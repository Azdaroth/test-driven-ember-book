
<h1 id="test-driven-ember.js---the-definitive-guide">Test Driven Ember.js - The Definitive Guide</h1>
<h2 id="learn-how-to-write-effective-and-maintainable-tests-in-ember.js-applications">Learn How To Write Effective And Maintainable Tests in Ember.js applications</h2>
<h3 id="karol-galanciak">Karol Galanciak</h3>
<h4 id="version-1.0-release-candidate-4-11.10.2017">Version: 1.0 Release Candidate 4 (11.10.2017)</h4>
<p></p>
<h1 id="test-driven-ember.js">Test Driven Ember.js</h1>
<p>Copyright © 2017 Karol Galanciak. All rights reserved.</p>
<p>To Napoleon Hill, the author of Think And Grow Rich, who has been one of my greatest inspirations.</p>
<p>In memory of Rich Piana, the founder of 5% Nutrition and bodybuilder, who planted <strong>Whatever It Takes</strong> mentality in my mind.</p>
<blockquote>
<p>“Whatever the mind can conceive and believe the mind can achieve.” - <strong>Napoleon Hill</strong></p>
</blockquote>
<blockquote>
<p>“Are you truly doing whatever it takes to reach your goals?” - <strong>Rich Piana</strong></p>
</blockquote>
<p></p>
<h1 id="preface">Preface</h1>
<p>Testing is one of the hottest topics when it comes to software development and building ambitious web applications. Most of the available resources about <strong>Test-Driven Development</strong> / <strong>Test-First</strong> approach for web applications is based on server-side programming. If you come from Ruby on Rails background or from any other technology, which embraces writing tests, you may think that testing your client-side apps should be similar and when it comes to writing good tests, similar rules should apply.</p>
<p>For testing <strong>client-side applications</strong> this is not always true. Have you heard about the concept of <a href="https://martinfowler.com/bliki/TestPyramid.html">test pyramid</a> and the rules/suggestions stating that you should mostly focus on unit testing, add some integration tests on top and have only a small amount of acceptance (end-to-end) tests? These guidelines are certainly useful when it comes to building server-side apps. However, in <strong>Ember.js</strong> the pyramid of testing could literally be inverted and the majority of the focus could be put on acceptance tests!</p>
<p>Testing <strong>Ember.js</strong> or any other <strong>JavaScript</strong> client-side applications is a skill of its own, and the abundance of asynchronous actions in most of the apps and other things that are not common in server-side programming makes it harder to write efficient and maintainable tests. Thanks to Ember community, there are plenty of tools like <a href="http://github.com/samselikoff/ember-cli-mirage/pulls">ember-cli-mirage</a> that make testing faster and simpler; nevertheless, it doesn’t mean that those tests are going to be easy and obvious to write.</p>
<p><strong>Test-Driven Development</strong> has been a fundamental concept for me since learning Ruby on Rails, and when I was starting my journey with Ember, it wasn’t that clear to me how to do it right. Learning that skill took me a lot of time and effort, and I would love to share this knowledge with you. I hope that after reading this book, you will have a clear idea what tools you should use in your own ambitious Ember projects and what kind of tests you should write to make the development process efficient and smooth. It took me over two years to learn how to do it well, and now you have a chance to learn all these concepts in the next few hours ;). Enjoy!</p>
<p></p>
<h1 id="introduction">Introduction</h1>
<h2 id="why-did-i-write-this-book">Why did I write this book?</h2>
<p>Writing a book seemed to me to be a pretty cool idea for a long time. I remember reading a few years ago a short, self-published e-book about Chef and setting up server infrastructure and besides enjoying the content of the book and learning a lot from it, I found it pretty fascinating that you can publish a book in such a simple way. That was probably the day when I started thinking about writing something more meaningful and having more impact comparing to writing just blog posts.</p>
<p>In less than 3 years later after reading this book, I became the CTO of <a href="https://www.bookingsync.com">BookingSync</a> which I consider as one of my greatest achievements, especially given the fact that I don’t have a formal computer science background and that 5 years earlier I had barely known what a “loop” or “conditional” is. I started to analyze my last few years and figuring out how exactly I managed to do that.</p>
<p>It was pretty clear that despite learning myself how to code, I couldn’t really say that I did everything myself. Obviously, I had to do the actual work, but the help was ubiquitous - I was able to find answers to a lot of my questions on StackOverflow, I was reading a lot of blogs with great content, and everything was available for free! And certainly, there is something more which deserves a special award: open source software. Thanks to the awesome community behind <strong>Ruby on Rails</strong> and <strong>Ember.js</strong>, I’ve managed to achieve all those things, and without the help of the community, I certainly would never have a chance to learn Rails or Ember, simply because those frameworks would have never evolved without everyone contributing to them.</p>
<p>It made me think that I partially owe my career to all the awesome people involved in the development process of the languages, frameworks, gems, addons and other tools I’ve been using from the beginning and to the fact that they gave something back. I’ve been been contributing to open source software for a while and have been periodically writing articles on <a href="http://karolgalanciak.com">my blog</a>, wrote a couple of articles on <a href="https://blog.ragnarson.com">Ragnarson’s blog</a> when I used to work there and also had a chance to write a guest blog post for <a href="https://www.codeschool.com/blog/2016/06/14/understanding-dependency-injection-in-ember/">Code School</a>. I managed to help some developers here and there by own contributions, but I didn’t think it was enough compared to how much I’d had benefitted from the open source software. Since I had had a plan to write a book for a long time, I thought it was the right time to do something much more meaningful and truly give back.</p>
<p>One major gap in the Ember ecosystem for a long time has been a lack of information (besides the official docs) how to do the TDD in real-world Ember apps and how to do it right. I’ve been interested in Test-Driven Development for a long time, so that looked like a perfect opportunity to share something that could help other developers in a substantial way.</p>
<p>I hope that by releasing this book for free, I will reach a larger audience comparing to a paid version and “pay” my debt to the open source community.</p>
<h2 id="who-is-this-book-for">Who Is This Book For?</h2>
<p>Every Ember developer, regardless of the skills, could benefit from this book. If you are a beginner, you will certainly learn more as it may serve as a guide for writing the tests. Nevertheless, if you are an experienced developer who has already written tons of tests, you can still find some useful ideas and techniques about writing tests presented in the book that could improve the way you approach testing or just show a different perspective.</p>
<p>This book assumes a basic knowledge of Ember and popular tools (mostly <strong>ember-cli</strong>). Having some background in testing (not necessarily in JavaScript) will also be beneficial, as this book doesn’t really focus on the basics of testing itself, but rather how to do it for Ember applications.</p>
<h2 id="how-to-read-it">How To Read It</h2>
<p>I would suggest reading it from the beginning till the end in chronological order, but feel free to jump to some particular chapter if you <em>really</em> want to focus on one particular concept at the moment.</p>
<h2 id="who-am-i">Who Am I?</h2>
<p>Hi! I’m Karol Galanciak, CTO of <a href="https://www.bookingsync.com">BookingSync</a>. I used to be the Angular fanboy, but after writing my first simple application in Ember in the fall of 2014, I immediately fell love with the framework. I had thought Angular was great, but even back then Ember was on a different level, especially thanks to Ember Data. That is how my journey with Ember has begun.</p>
<p>Privately, I love lifting weights and getting pumped, playing some heavy riffs and technical shreds on guitar, scuba diving and a traveling to cool places. I have a special gift of turning yerba mate (especially Pajarito!) into code. Apparently, I’m a capsaicin addict and cannot eat anything that is not hot.</p>
<p></p>
<h1 id="testing-basics">Testing Basics</h1>
<h2 id="what-is-the-point-of-writing-tests">What Is the Point Of Writing Tests?</h2>
<p>Before starting writing tests, we should ask ourselves the fundamental questions: what’s the point of doing that? How are we going to benefit from writing tests? It’s a complicated and time-consuming process, do the benefits outweigh the costs?</p>
<p>The essential benefit of writing tests is a confidence that the code we wrote works. The only alternative to writing tests is “testing” manually (e.g., by clicking through the different scenarios using the browser) which requires a lot of effort as well and doing it over and over again will eventually take much more time than writing automated tests.</p>
<p>It is not only when implementing new features that we need to verify if our application works fine - having well-written and the comprehensive test suite is also crucial when modifying existing behavior and doing refactoring. Can you imagine testing manually every possible scenario after applying every minor change? Neither can I. That way we get a powerful anti-regression tool which provides instant feedback. We’ve modified some code, and we have failing tests? Awesome! We know from the very beginning that <em>something</em> is not right and we can quickly fix it.</p>
<p>Another important aspect of writing automated tests is the ease of finding bugs. Imagine that you are maintaining a huge application and the users start complaining that some feature doesn’t work as it should. How fast can you identify the culprit without test suite? It would certainly take a lot of time. With well-written tests, it would take much less time to find where the problem is. Not only do you have a feedback from higher-level acceptance tests that are interacting with real UI that <em>something</em> is not right, but also the unit tests that deal with much smaller scope will tell you what the issue is.</p>
<p>An extra advantage of writing automated tests (mostly applicable when doing <strong>TDD</strong>) is clarifying the intentions - you need to precisely define the consecutive steps to execute some logic, which helps to break the functionality into smaller, more manageable pieces. That way you easily become more productive and focused on the current task.</p>
<p>Thanks to having automated test-suite we come more productive and confident about our code which makes any changes easier and indirectly, by investing time in writing good tests, we save time on arduous debugging.</p>
<h2 id="test-driven-development">Test-Driven Development</h2>
<p>You’ve most likely heard the term <strong>Test-Driven Development</strong> or <strong>Test-First Approach</strong>. What do they mean and how they are different?</p>
<p>According to <a href="http://www.growing-object-oriented-software.com">Growing Object Oriented-Software Guided By Tests</a> by Steve Freeman and Nat Pryce, a classic book about TDD, the idea of it is to <em>“write the tests for your code before writing the code itself”</em>. Well, that seems very similar to <strong>Test-First Approach</strong>, which is also about writing the tests before the code. The difference between those is subtle, and quite often those terms are used interchangeably.</p>
<p><strong>Test-First Approach</strong> is about starting with a test and writing a minimal amount of code to make the test(s) pass. It is also the case in <strong>TDD</strong>. However, the important aspect of <strong>Test-Driven Development</strong> is <strong>refactoring</strong> phase, which helps with achieving a proper design - that way <strong>TDD</strong> also serves as a design tool, which doesn’t matter that much in case of <strong>Test-First Approach</strong>.</p>
<p>To put it simply:</p>
<pre><code>Test-First Approach + Refactoring =&gt; Test-Driven Development</code></pre>
<h2 id="why-is-it-important-to-write-tests-first">Why Is It Important To Write Tests First?</h2>
<p>Now that we know that writing tests is pretty much essential in the long-term perspective, we should answer one more question: why does it even matter to write tests first? Why can’t we just write the code and then add a couple of tests to verify if the features work as expected?</p>
<p>There are few reasons behind it. The fundamental one is that you can’t be really sure that the test indeed works unless you’ve seen it failed. It is quite easy to have a false-positive in a test - the situation where the functionality doesn’t work as intended, yet the tests are still passing. It might be just a coincidence (maybe something returned <code>undefined</code> but not because such value was supposed to be returned, but because it’s never been defined in the first place!). Maybe you misused some testing library’s feature which resulted in having such problem. You can still work around those issues and add tests later which happens quite often when working on the legacy apps. Nevertheless, it’s simply safer, and it just takes less time to write the tests first without trying to apply some hacks later.</p>
<p>The other reason in that the tests may guide the design. When writing the implementation code, you’re probably not focusing on the ease of testing as the primary thing, but rather the ease of writing the code itself. However, the easier the code is to test, the easier it is to use. It quite often results in better interfaces and overall design with less coupling between objects and having more cohesive units. Writing tests first doesn’t necessarily guarantee that the code will always be well-designed; nevertheless, it’s more likely to be the case than when writing the tests after the implementation.</p>
<p>Keep in mind that those rules are not hard laws or dogmas. Sometimes you may be implementing a feature that you’ve implemented already few times before or maybe something is just trivial, and you already have an idea about the entire design. Tests are for making out lives as developers easier. If you think there is no risk of writing the code first, then go ahead. I just wouldn’t suggest making it a default approach and would rather stay with writing the tests first unless I’m 100% sure that I can do otherwise.</p>
<p>Also, when thinking about the tests as a tool for guiding the design, it’s pretty convenient to do the testing from the outside in.</p>
<h2 id="testing-from-the-outside-in">Testing From The Outside-In</h2>
<p>Testing from the outside in simply means starting from the higher-level tests and working from that point to lower-level tests.</p>
<p>Usually, it means writing a failing acceptance test for a particular feature, then writing some integration tests (in Ember applications those will be mostly components’ integration tests) and ending with some unit tests for models, services, etc. It also means that there might be a reverse order of passing tests - the first passing test could be a model unit test, then component integration test and the last passing one could be the acceptance test that was written first.</p>
<p>The opposite approach to outside-in is the inside-out approach where you focus on isolated units and defer the decision how they are going to interact with each other. This strategy isn’t necessarily wrong though - sometimes you may not know how to test given feature from the higher-level perspective. This might happen when you are implementing non-trivial functionality with some complex behavior - one example would be drag and drop. In such case, you may prefer starting with some lower level test (maybe with an integration one or even unit tests) and get back to acceptance tests later. You may lose some benefits of full TDD approach like the tests guiding your design, but still, there is a place for the outside-in approach. However, I believe by default you should always start with the outside-in approach and only try the inside-out approach if the former doesn’t work well in particular use case.</p>
<h2 id="tdd-vs.bdd">TDD vs. BDD</h2>
<p>So far I haven’t mentioned anything about <strong>Behavior-Driven Development (BDD)</strong> - a term which seems to be used quite often and sometimes even as the opposite approach to TDD.</p>
<p>Nevertheless, I believe there is no any major difference between those two. BDD advocates starting development by writing acceptance tests first, focusing on behavior. But this is the same as TDD done with the outside-in approach! Also, <a href="http://www.growing-object-oriented-software.com">Growing Object Oriented-Software Guided By Tests</a>, which is a classic on TDD, clearly says that starting with end-to-end (acceptance) tests is essential and that one should focus on describing the behavior, not the API of the objects.</p>
<p>Just to keep things simple and not introduce any confusion, I’ll stick to <strong>TDD</strong> term later in the book, which might mean the same thing as <strong>BDD</strong> if you are more used to that phrase.</p>
<h2 id="classification-of-tests">Classification Of Tests</h2>
<p>Based on the scope of tests and a number of layers of the application they involve, there are three levels of tests:</p>
<ul>
<li><p>Acceptance tests (end-to-end tests) - these tests cover all layers of the application and simulate user interaction, e.g., by filling forms and clicking the buttons in the browser. They are automated equivalent of manual testing by interacting with the application yourself.</p></li>
<li><p>Integration tests - these tests involve multiple layers of an application, but they don’t run the entire app. In context of Ember applications, those are mostly component tests which also involve components’ collaborators (like injected services) or isolated and simplified user interaction (e.g., rendering and submitting a form from the component, but outside the context of the rest of the application)</p></li>
<li><p>Unit tests - they are checking if the behavior of a particular unit is right. Note that it isn’t necessarily about one object - a unit can be composed of multiple objects, but some of them they might be implementation details, or they don’t exist outside given context.</p></li>
</ul>
<h2 id="test-pyramid">Test Pyramid</h2>
<p>If you are a seasoned developer you’ve most likely heard about the concept of <a href="https://martinfowler.com/bliki/TestPyramid.html">Test Pyramid</a> which illustrates the idea that unit tests should be the fundament of your test suite on top of which you should have some integration tests and few acceptance tests, which will verify if the app truly works.</p>
<p>In case of server-side applications (or in general non-client-side applications) this makes a lot of sense - you don’t want your UI interactions to make the majority of your tests as it’s quite tricky to test all the edge cases that way and such tests are simply slow comparing to the unit or even integration tests. However, when it comes to Single Page Applications, it’s quite the opposite - the entire application serves the purpose of the UI! The priorities are different, so is the test pyramid. In Ember apps (or any other SPAs) the acceptance tests may not necessarily make the majority of your tests (well, at least in terms of the amount, they are most likely going to take most of the time when running the entire test suite though), but as you will see in the next chapters the unit tests don’t matter that much as you may initially think.</p>
<p>Some layers like routes and their hooks might not even be worth testing with unit tests at all as the acceptance tests will cover them as well. Unit testing actions in components also might not bring much value - perhaps the logic inside that action works fine, but you don’t know if they are going to be executed properly. It’s much safer to test the actions via component integration tests, which will provide us with a feedback not only about the logic itself but also if the component is wired-up properly and if it executes proper actions when handling some event.</p>
<p>However, unit tests remain quite important for testing edge cases and complex computed properties as they require much less overhead and are faster.</p>
<p>Considering the tests’ structure in typical Ember application, it’s probably no longer valid to talk about “pyramid” of tests. Rather, we may end up with Testing Cube without a clear foundation and a clear peak like in case of a pyramid, but with all three layers (acceptance, integration, and unit) mixed in different proportions and with all of them creating the foundation of solid test-suite.</p>
<h2 id="to-test-or-not-to-test">To Test Or Not To Test</h2>
<p>As already stated before, there are some layers or part of those layers that might be not worth unit testing at all. I believe this is mostly true for testing hook methods’ behavior in routes like <code>beforeModel</code>, <code>model</code> or <code>afterModel</code>, actions and most of the computed properties in components and arguably controllers. Let’s break these three layers down and see what the better way to test them is:</p>
<ul>
<li><p><strong>routes</strong> - hooks like <code>beforeModel</code>, <code>model</code> or <code>afterModel</code> are in most cases pretty simple and they in general fetch data from the remote API, do some transitions based on some conditions, etc. As those are hook methods, they are strictly connected to the request of the application and executed under specific circumstances, so such methods make a poor unit and it doesn’t make much sense to test them in isolation. It’s more convenient and safer to test them using acceptance tests as you will make sure that the route behaves properly in real-world interaction. Actions are a different story though. Some actions could be tested via acceptance tests as well, but if you have some complex logic there with multiple edge cases, writing unit tests would certainly help. You can either test all the edge cases in the route action itself or extract the logic to another object an just check if the right method is called on this object and the expected arguments are passed.</p></li>
<li><p><strong>controllers</strong> - they are said to be replaced eventually by routable components, but until this feature is ready, we need to learn how to test them. Controllers in Ember serve a role of a top-level component for given route. It’s not currently possible to totally give up on controllers as they handle query params and transitions (though the latter can be handled on route-level with <a href="https://github.com/DockYard/ember-route-action-helper">route actions</a>). Testing controllers highly depends on the current design of your application and if it’s a new controller or some already existing controller which is packed with logic. For new controllers, I would suggest keeping some actions and computed properties to a minimum in the controller and moving actions to routes (that are modifying the data, just like the ol’ good <a href="http://www.samselikoff.com/blog/data-down-actions-up/">Data Down Actions Up</a> paradigm recommends) and moving other actions and computed properties to components. Query params should be tested via acceptance tests as it doesn’t make much sense in isolation, they are bound to request cycle. That way we would end up with no unit tests for controllers. For already existing ones, you may approach testing actions exactly in the same way as for route actions - unit test the behavior or delegation. For computed properties though you should write proper unit tests and test all the edge cases unless it’s something trivial that is already covered in acceptance tests.</p></li>
<li><p><strong>components</strong> - most of the tests you should be writing for components should be integration tests unless you have a very specific reason for writing unit tests. The integration tests are pretty simple to set up, and even if you have complex actions, you can just extract the behavior to a service, inject stubbed service in the test and verify if the right method on the service was called with expected arguments. Actions are never the isolated units; they are called as the result of some user interaction so they should be tested that way. Some user interactions might be difficult to simulate in integration tests, and such actions could be potential candidates for unit testing, but by default, it’s better to always start with an integration test. And what about the computed properties? Unless they are very complex, you should also stick to integration tests.</p></li>
</ul>
<p>All this means that the majority of the unit tests you will be writing will cover models and services.</p>
<p></p>
<h1 id="essential-tools">Essential Tools</h1>
<p>There are multiple tools that we’ll be using in the next chapters of the book. Some of them will be introduced ad hoc when needed, but for now, let’s focus on the essential ones.</p>
<h2 id="qunit">QUnit</h2>
<h3 id="introduction-1">Introduction</h3>
<p><a href="https://qunitjs.com">QUnit</a> is the default testing tool for Ember. Even though I used to be a <a href="https://jasmine.github.io">jasmine</a> fanboy before I knew Ember, I quite quickly got used to QUnit and appreciated it for its simplicity. The API is pretty limited, yet it offers everything you may need to write proper tests for your applications. Let’s take a closer look how it works.</p>
<p>Here’s a super short setup for QUnit:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
<span class="kw">&lt;html&gt;</span>
<span class="kw">&lt;head&gt;</span>
  <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;meta</span><span class="ot"> name=</span><span class="st">&quot;viewport&quot;</span><span class="ot"> content=</span><span class="st">&quot;width=device-width&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;title&gt;</span>QUnit Example<span class="kw">&lt;/title&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="ot"> href=</span><span class="st">&quot;https://code.jquery.com/qunit/qunit-2.1.1.css&quot;</span><span class="kw">&gt;</span>
<span class="kw">&lt;/head&gt;</span>
<span class="kw">&lt;body&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;qunit&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;qunit-fixture&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
  <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;https://code.jquery.com/qunit/qunit-2.1.1.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
  <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;tests.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;/body&gt;</span>
<span class="kw">&lt;/html&gt;</span></code></pre></td></tr></table></div>
<p>What we are doing here is fetching some stylesheets to have a clean and smooth testing page and the QUnit code itself. Let’s add some tests to <code>tests.js</code> file and see QUnit in action:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">QUnit</span>.<span class="at">test</span>(<span class="st">&quot;QUnit rockzzz&quot;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="dv">1</span> <span class="op">===</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&#39;1 should be equal to 1&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">notOk</span>(<span class="kw">false</span><span class="op">,</span> <span class="st">&#39;false if falsey&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="dv">1</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">deepEqual</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span> <span class="st">&#39;deepEqual is so cool&#39;</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>After opening the <code>tests.html</code> in a browser, we should see something like this:</p>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/qunit_example.png" alt="Qunit example" />
<p class="caption">Qunit example</p>
</div>
<h3 id="api-overview">API Overview</h3>
<h4 id="assertions">Assertions</h4>
<p>Let’s start with explaining the syntax and then we will get back to the details of this tests’ UI.</p>
<p>QUnit has a pretty limited API, it’s not as flexible and elaborate as Jasmine, which syntax was inspired by powerful Ruby testing framework - <a href="http://rspec.info">RSpec</a>, but it’s straightforward and easy to understand. We write test scenarios with <code>QUnit.test</code> method, which takes two arguments - the description of the test and callback where we put the test’s body. The argument of the callback is <code>assert</code> object which contains the assertions. We can use <code>ok</code> or <code>notOk</code> assertions which check for truthiness or falseness and also assertions such as <code>equal</code> which performs non-strict comparison or <code>deepEqual</code> which according to the <a href="http://api.qunitjs.com/category/assert/">docs</a> performs “a deep recursive comparison, working on primitive types, arrays, objects, regular expressions, dates, and function”. It is possible also to provide an optional description of particular assertion as the last argument, which helps identify failures of the tests.</p>
<p>These are by no means the only capabilities of QUnit. Dealing with async functions is bread and butter when it comes to JavaScript. To make sure QUnit will wait for an asynchronous operation that is not finished you can use <code>async()</code> function. That way QUnit will wait until <code>done()</code> is called.</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">QUnit</span>.<span class="at">test</span>(<span class="st">&#39;async is awesome&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> done <span class="op">=</span> <span class="va">assert</span>.<span class="at">async</span>()<span class="op">;</span>

  <span class="at">setTimeout</span>(<span class="kw">function</span>() <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;called from async function&#39;</span>)<span class="op">;</span>
    <span class="at">done</span>()<span class="op">;</span>
  <span class="op">},</span> <span class="dv">100</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>QUnit doesn’t provide any API for spying and mocking. Nevertheless, it is still possible to make sure some method or function is called. Just write an assertion within a given function and ensure that the right amount of assertions is called using <code>expect()</code>:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">QUnit</span>.<span class="at">test</span>(<span class="st">&#39;testing with assert.expect&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">var</span> $btn <span class="op">=</span> <span class="at">$</span>(<span class="st">&#39;btn&#39;</span>)<span class="op">;</span>

  <span class="va">$btn</span>.<span class="at">on</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;the button was clicked&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="va">$body</span>.<span class="at">click</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>If the total amount of assertions is not equal to the <code>count</code> argument passed to <code>expect()</code>, the tests will fail. That way we can make sure that all the expected assertions were performed.</p>
<p>There are also many other assertions available in QUnit, such as <code>assert.throws()</code> for catching the exceptions and I highly recommend to read the <a href="http://api.qunitjs.com/category/assert/">official docs</a> for the quick overview, just to be aware of all of them.</p>
<h4 id="module-and-hooks">Module And Hooks</h4>
<p>In QUnit it’s possible to group some tests in a <code>module</code> for clearer organization purposes, but also for providing hooks for what should happen <code>before</code> running tests, <code>beforeEach</code> test, <code>afterEach</code> test and <code>after</code> all tests. Check the following example:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">QUnit</span>.<span class="at">module</span>(<span class="st">&#39;Awesomeness check&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">before</span><span class="op">:</span> <span class="kw">function</span>() <span class="op">{</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;run me before all tests&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;run me before each test&#39;</span>)<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">awesomeFramework</span> <span class="op">=</span> <span class="st">&#39;Ember&#39;</span><span class="op">;</span>
    <span class="kw">this</span>.<span class="at">isQUnitAwesome</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span>
  <span class="op">},</span>
  <span class="at">afterEach</span>() <span class="op">{</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;run me after each test&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">after</span>() <span class="op">{</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;run me at the end&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="va">QUnit</span>.<span class="at">test</span>(<span class="st">&#39;Ember should be the awesome framework&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="kw">this</span>.<span class="at">awesomeFramework</span><span class="op">,</span> <span class="st">&#39;Ember&#39;</span><span class="op">,</span> <span class="st">&#39;Ember should be awesome&#39;</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="va">QUnit</span>.<span class="at">test</span>(<span class="st">&#39;QUnit should be awesome&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">this</span>.<span class="at">isQUnitAwesome</span><span class="op">,</span> <span class="st">&#39;QUnit should be awesome&#39;</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We grouped some tests under a module with an awesome description and provided some hooks to demonstrate how they work. After running our test suite, all tests should pass, which will mean that the setup from <code>before</code> hook and assigning some values to <code>this</code> context works as expected and also the sequence of running the hooks is the same as discussed. After opening the console, we should see the following logs:</p>
<pre><code>run me before all tests
run me before each test
run me after each test
run me before each test
run me after each test
run me at the end</code></pre>
<h4 id="qunit-ui">QUnit UI</h4>
<p>Let’s get back to the cool UI we saw at the beginning of this chapter:</p>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/qunit_example.png" alt="Qunit example" />
<p class="caption">Qunit example</p>
</div>
<p>Besides showing all the tests and their statuses whether they are currently passing or not we have some options for customization:</p>
<ul>
<li>Hide passed tests - this options allows to not display the passed tests and only show the failed ones, which is what we want in most cases. If we tried to force some failure from the previous example and checked this checkbox, we would have the following result:</li>
</ul>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/qunit_example_hide_passed.png" alt="Qunit failure example" />
<p class="caption">Qunit failure example</p>
</div>
<ul>
<li>Check for Globals - checking this options will make the QUnit check if some globals were introduced in any of the tests and fail those tests if that’s the case. Let’s get back to our initial example, introduce some global and take a look at the result:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">QUnit</span>.<span class="at">test</span>(<span class="st">&quot;QUnit rockzzz&quot;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="dv">1</span> <span class="op">===</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&#39;1 should be qual to 1&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">notOk</span>(<span class="kw">false</span><span class="op">,</span> <span class="st">&#39;false if falsey&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="dv">1</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">deepEqual</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span> <span class="st">&#39;deepEqual is so cool&#39;</span>)<span class="op">;</span>

  <span class="va">window</span>.<span class="at">uglyGlobal</span> <span class="op">=</span> <span class="st">&#39;fail the tests!&#39;</span><span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>After running the test suite, we will see the following result:</p>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/qunit_example_globals.png" alt="Qunit Check for Globals example" />
<p class="caption">Qunit Check for Globals example</p>
</div>
<ul>
<li><p>No try-catch - by default QUnit runs tests inside <code>try/catch</code> block, catches all the exceptions and then displays that some error has happened. Sometimes you may want QUnit to not catch these errors and get the “native” exception in the console - this is particularly useful when debugging as you will get the exact info where the problem happened.</p></li>
<li><p>Module select - this select lets you pick a particular module that should be the subject of testing, useful especially in huge test suites.</p></li>
<li><p>Filter input - this input allows to filter tests with a description matching the provided phrase, quite beneficial when you need to run only a particular subset of tests.</p></li>
</ul>
<h2 id="ember-test-helpers-ember-qunit">ember-test-helpers &amp; ember-qunit</h2>
<p><strong>ember-test-helpers</strong> provide the essential helpers required to test Ember applications. As this library is testing-framework-agnostic it requires some extra integration layer for some of the helpers, in our case it is ember-qunit, but it could also be something different like <a href="https://github.com/emberjs/ember-mocha">ember-mocha</a>.</p>
<p>Let’s take a look at the provided helpers and how we can use them:</p>
<ul>
<li><code>TestModule</code> (exposed as <code>moduleFor</code> in ember-qunit) - it’s a basic building block for tests handling all the necessary setup and teardown essential to test given subject in the Ember ecosystem. It works for anything that could be looked up by Ember Resolver (models, components, services, etc.), but some of these layers have more dedicated helpers like <code>moduleForComponent</code>. Its basic usage is quite straight-forward: you just need to provide the name of the subject with its type:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="at">moduleFor</span>(<span class="st">&#39;service:current-user&#39;</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>You can also pass an optional description, e.g., “Unit | Service | current -user” and config options, which is the most interesting part here.</p>
<p>With config options, you can pass callbacks such as <code>beforeEach</code> and <code>afterEach</code>, but also options which influence how the tests are being run.</p>
<p>When writing an integration test, you will need to pass <code>integration: true</code> option. And when you are unit testing some piece which depends on other parts of the application, you will need to pass the array of dependencies with <code>needs</code> option, like <code>needs: ['service:current-user']</code>. Other helpers which extend the behavior of <code>TestModule</code> (<code>moduleFor</code>) such as <code>TestModuleForComponent</code> (<code>moduleForComponent</code>) introduce some more specific options, e.g. <code>unit</code> flag to indicate that you want to write a component unit test.</p>
<p>You may be wondering why passing the exact subject name is important. Let’s take a look at this example of a basic service test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;service:current-user&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Service | current user&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it exists&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> service <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(service)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Somehow the service we wanted to test was properly initialized using <code>subject</code> function. <code>moduleFor</code> requires this full name exactly for this purpose - to find a factory and instantiate the object under the test.</p>
<p>Another important thing which <code>TestModule</code> (<code>moduleFor</code>) handles is contextualization of the tests. Check the following example:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;service:invoice-price-calculator&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Service |</span>
  invoice<span class="op">-</span>price<span class="op">-</span>calculator<span class="st">&#39;);</span>

<span class="at">test</span>(<span class="st">&#39;it calculates net price for the invoice&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> calculator <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="kw">const</span> service_1 <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">netPrice</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> service_2 <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">netPrice</span><span class="op">:</span> <span class="dv">200</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> service_3 <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">netPrice</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> services <span class="op">=</span> [service_1<span class="op">,</span> service_2<span class="op">,</span> service_3]<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">calculator</span>.<span class="at">calculateNetPrice</span>(services)<span class="op">,</span> <span class="dv">600</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it calculates gross price for the invoice&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> calculator <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="kw">const</span> service_1 <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">netPrice</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> service_2 <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">netPrice</span><span class="op">:</span> <span class="dv">200</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> service_3 <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">netPrice</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> services <span class="op">=</span> [service_1<span class="op">,</span> service_2<span class="op">,</span> service_3]<span class="op">;</span>
  <span class="kw">const</span> tax <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">percentage</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
  consts taxes <span class="op">=</span> [tax]<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">calculator</span>.<span class="at">calculateGrossPrice</span>(services<span class="op">,</span> taxes)<span class="op">,</span> <span class="dv">660</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>In both tests, we had to set up the same services, which is maybe not that bad for two tests but would certainly be a problem for a huge amount of tests. The great thing about the setup is that there is a shared context (<code>this</code>) between tests and setup callbacks! So we can assign all the values to <code>this</code> inside <code>beforeEach</code>:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;service:invoice-price-calculator&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Service |</span>
  invoice<span class="op">-</span>price<span class="op">-</span>calculator<span class="st">&#39;, {</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">const</span> service_1 <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
      <span class="dt">netPrice</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span>
    <span class="op">}</span>)<span class="op">;</span>
    <span class="kw">const</span> service_2 <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
      <span class="dt">netPrice</span><span class="op">:</span> <span class="dv">200</span><span class="op">,</span>
    <span class="op">}</span>)<span class="op">;</span>
    <span class="kw">const</span> service_3 <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
      <span class="dt">netPrice</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span>
    <span class="op">}</span>)<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">services</span> <span class="op">=</span> [service_1<span class="op">,</span> service_2<span class="op">,</span> service_3]<span class="op">;</span>
  <span class="op">},</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it calculates net price for the invoice&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> calculator <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">calculator</span>.<span class="at">calculateNetPrice</span>(<span class="kw">this</span>.<span class="at">services</span>)<span class="op">,</span> <span class="dv">600</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it calculates gross price for the invoice&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> calculator <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="kw">const</span> tax <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">percentage</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
  consts taxes <span class="op">=</span> [tax]<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">calculator</span>.<span class="at">calcualteGrossPrice</span>(<span class="kw">this</span>.<span class="at">services</span><span class="op">,</span> taxes)<span class="op">,</span> <span class="dv">660</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Looks much better and much more DRY!</p>
<ul>
<li><code>TestModuleForComponent</code> (<code>moduleForComponent</code>) - a specialized version of <code>TestModule</code> (<code>moduleFor</code>) help intended for testing components. By default, it’s supposed to test components via integration tests, but you can also write unit tests by providing <code>unit: true</code> flag or the list of dependencies via <code>needs: []</code> in callbacks. This helper also provides <code>render</code> method which lets you render and test the component. Here’s an example of a component and its integration test (which uses <code>htmlbars-inline-precompile</code> described later in this chapter):</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// app/components/display-ember-awesomeness-status.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

set <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">shouldShowStatus</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">showStatus</span>() <span class="op">{</span>
      <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;shouldShowStatus&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- app/templates/components/display-ember-awesomeness-status.hbs --&gt;</span>
{{#if shouldShowStatus}}
  <span class="kw">&lt;p</span><span class="ot"> data-test=</span><span class="st">&quot;status&quot;</span><span class="kw">&gt;</span>Ember is Awesome!<span class="kw">&lt;/p&gt;</span>
{{else}}
  <span class="kw">&lt;button</span><span class="ot"> data-test=</span><span class="st">&quot;show-status-btn&quot;</span><span class="kw">&gt;</span>Show status<span class="kw">&lt;/button&gt;</span>
{{/if}</code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/integration/components/display-ember-awesomeness-status-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;display-ember-awesomeness-status&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component |</span>
  display ember awesomeness status<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it shows status after clicking the button&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{display-ember-awesomeness-status}}`</span>)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">$</span>(<span class="st">&#39;[data-test=status]&#39;</span>).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;status should be hidden&#39;</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="st">&#39;[data-test=show-status-btn]&#39;</span>).<span class="at">click</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">$</span>(<span class="st">&#39;[data-test=status]&#39;</span>).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;status should be visible&#39;</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>As this helper is supposed to be used only for components, you don’t need to pass the type of the subject, just the name of the component is sufficient.</p>
<ul>
<li><code>TestModuleForModel</code> (<code>moduleForModel</code>) - a specialized version of <code>TestModule</code> (<code>moduleFor</code>), which provides extra setup and methods making testing models easier. It registers Application Adapter, allows you to access <code>store</code> via <code>this.store()</code> and overrides subject instantiation - by default it uses <code>store</code> to create new instances of the model with <code>store.createRecord()</code> passing the test subject as a model name:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/unit/models/user-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForModel<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>

<span class="at">moduleForModel</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Model | user&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">needs</span><span class="op">:</span> []
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it exists&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> model <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>
  <span class="kw">const</span> store <span class="op">=</span> <span class="kw">this</span>.<span class="at">store</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(model<span class="op">,</span> <span class="st">&#39;model should exist&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(store<span class="op">,</span> <span class="st">&#39;store should exist&#39;</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<ul>
<li><code>hasEmberVersion</code> - a nifty little helper for checking if you the current Ember version is equal to the specified one or higher concerning major and minor version. If you are developing some addon and want to use a feature introduced in Ember 2.10 and provide a fallback for the older versions, you can do it in the following way:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">import</span> hasEmberVersion <span class="im">from</span> <span class="st">&#39;ember-test-helpers/lib/ember-test-helpers/has-ember-version&#39;</span><span class="op">;</span>

<span class="cf">if</span> (<span class="at">hasEmberVersion</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">10</span>)) <span class="op">{</span>
  <span class="at">executeLogicUsingFeatureAvailableFromThatEmberVersion</span>()<span class="op">;</span>
<span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
  <span class="at">executeFallback</span>()<span class="op">;</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<ul>
<li><code>wait</code> - a helper making it possible to wait until all the asynchronous operations, such as timers or HTTP requests, have been executed and only then doing the assertions. It is particularly useful when you don’t want to stub out the behavior, but just test the behavior in more real-world circumstances. You will most likely need to use this helper along with QUnit’s <code>async()</code> helper.</li>
</ul>
<p>Imagine a simple use case where you need to hide some button after clicking on it after a particular period. This is how we could approach testing it:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/integrations/components/hide-button-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> wait <span class="im">from</span> <span class="st">&#39;ember-test-helpers/wait&#39;</span><span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;hide-button&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component | hide button&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">integration</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;button is hidden after clicking on it&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="kw">const</span> done <span class="op">=</span> <span class="va">assert</span>.<span class="at">async</span>()<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{hide-btn}}`</span>)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">$</span>(<span class="st">&#39;[data-test=hide-btn]&#39;</span>).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;button should be visible&#39;</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="st">&#39;[data-test=hide-btn]&#39;</span>).<span class="at">click</span>()<span class="op">;</span>

  <span class="at">wait</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">$</span>(<span class="st">&#39;[data-test=hide-btn]&#39;</span>).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;button should not be visible&#39;</span>)<span class="op">;</span>
    <span class="at">done</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And here is the component:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- app/templates/components/hide-btn.hbs --&gt;</span>
{{#unless hideBtn}}
  <span class="kw">&lt;button</span><span class="ot"> data-test=</span><span class="st">&quot;hide-btn&quot;</span> <span class="er">{{action</span> <span class="er">&quot;hide&quot;}}</span><span class="kw">&gt;</span>
    Hide me!
  <span class="kw">&lt;/button&gt;</span>
{{/unless}}</code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// app/components/hide-btn.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  run<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">hideBtn</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">hide</span>() <span class="op">{</span>
      <span class="va">run</span>.<span class="at">later</span>(<span class="kw">this</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span>
        <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;hideBtn&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span>
      <span class="op">},</span> <span class="dv">2000</span>)<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And that’s it! We don’t need to stub any behavior in out tests or use <code>Ember.run.later()</code> (please, never ever do it) in our tests to make sure all the events have been processed.</p>
<p>The only concern here would be that this test takes more than 2 seconds to run. But we could quite easily make it faster by making delay time configurable from the outside:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/integrations/components/hide-button-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> wait <span class="im">from</span> <span class="st">&#39;ember-test-helpers/wait&#39;</span><span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;hide-button&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component | hide button&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">integration</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;button is hidden after clicking on it&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="kw">const</span> done <span class="op">=</span> <span class="va">assert</span>.<span class="at">async</span>()<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="co">// let&#39;s change the delay time!</span>
  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{hide-btn delayTime=0}}`</span>)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">$</span>(<span class="st">&#39;[data-test=hide-btn]&#39;</span>).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;button should be visible&#39;</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="st">&#39;[data-test=hide-btn]&#39;</span>).<span class="at">click</span>()<span class="op">;</span>

  <span class="at">wait</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">$</span>(<span class="st">&#39;[data-test=hide-btn]&#39;</span>).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;button should not be visible&#39;</span>)<span class="op">;</span>
    <span class="at">done</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// app/components/hide-btn.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  run<span class="op">,</span>
  set<span class="op">,</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">hideBtn</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span>
  <span class="dt">delayTime</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">hide</span>() <span class="op">{</span>
      <span class="kw">const</span> delayTime <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;delayTime&#39;</span>)<span class="op">;</span>
      <span class="va">run</span>.<span class="at">later</span>(<span class="kw">this</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span>
        <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;hideBtn&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span>
      <span class="op">},</span> delayTime)<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>By default <code>delayTime</code> is <code>2000</code> which is the same as it was, but this time this property is configurable, and we can just pass <code>0</code> to make the test much faster. As a nice side effect, we achieved a slightly better design in the component by extracting this delay time to a named property.</p>
<h2 id="testem">testem</h2>
<p><a href="https://github.com/testem/testem">Testem</a> is a test runner used under the hood when running <code>ember test</code> and <code>ember test --server</code>. However, there’s quite a big difference between those two.</p>
<p>The former runs the tests in CI mode which just runs entire test suite and shows how many tests were run, how many passed, how many were skipped and how many failed. As the name suggests, it’s supposed to be used for CI. For everyday development, you should use the latter, which will run a particular subset of tests when the file changes which is very convenient for rapid TDD.</p>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/testem.png" alt="Testem" />
<p class="caption">Testem</p>
</div>
<p>Here’s an example config for Testem taken from <code>testem.json</code> config file in Ember app:</p>
<div class="sourceCode"><table class="sourceCode json numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="sourceCode"><pre><code class="sourceCode json"><span class="er">&lt;!--</span> <span class="er">testem.json</span> <span class="er">--&gt;</span>

<span class="fu">{</span>
  <span class="dt">&quot;framework&quot;</span><span class="fu">:</span> <span class="st">&quot;qunit&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;test_page&quot;</span><span class="fu">:</span> <span class="st">&quot;tests/index.html?hidepassed&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;disable_watching&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
  <span class="dt">&quot;launch_in_ci&quot;</span><span class="fu">:</span> <span class="ot">[</span>
    <span class="st">&quot;PhantomJS&quot;</span>
  <span class="ot">]</span><span class="fu">,</span>
  <span class="dt">&quot;launch_in_dev&quot;</span><span class="fu">:</span> <span class="ot">[</span>
    <span class="st">&quot;PhantomJS&quot;</span><span class="ot">,</span>
    <span class="st">&quot;Chrome&quot;</span>
  <span class="ot">]</span>
<span class="fu">}</span></code></pre></td></tr></table></div>
<p>The list of options is quite self-explanatory:</p>
<ul>
<li><p>framework - pass the name of test framework you are using. It could be <code>qunit</code>, <code>jasmine</code>, <code>mocha</code> and <code>buster</code>.</p></li>
<li><p>test_page - a path to a customized test page to run tests.</p></li>
<li><p>disable_watching - whether the file watching should be disabled or not. <code>ember-cli</code> already handles it, so no need to have it enabled.</p></li>
<li><p>lanuch_in_ci - a list of launchers (such as PhantomJS, Chrome, Firefox) to be used when running tests in CI mode.</p></li>
<li><p>launch_in_dev - a list of launchers to be used when running tests in development mode.</p></li>
</ul>
<p>There are plenty of other config options that could be used if necessary; you can learn more about them <a href="https://github.com/testem/testem/blob/master/docs/config_file.md">here</a>.</p>
<h2 id="ember-cli-htmlbars-inline-precompile">ember-cli-htmlbars-inline-precompile</h2>
<p>An awesome addon which makes it possible to precompile HTMLBars template strings making components testing much easier. That way we can write fewer acceptance tests covering different scenarios of the same feature in favor of components’ integration tests, which results ultimately in faster tests.</p>
<p>Its API is pretty limited - you just pass a component’s code as if you were rendering it in a real-world handlebar templates:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;my-awesome-component&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component | my awesome</span>
  component<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;button is hidden after clicking on it&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="kw">const</span> onUpdateAction <span class="op">=</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;onUpdate has been executed&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>
  <span class="kw">const</span> user <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onUpdateAction&#39;</span><span class="op">,</span> onUpdateAction)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;user&#39;</span><span class="op">,</span> user)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{my-awesome-component user=user onUpdate=(action onUpdateAction)}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="st">&#39;[data-test=update-btn]&#39;</span>).<span class="at">click</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>As you can see it is quite easy to pass bith the properties to the component and the actions! We just need to define them in the current context under the same name that we pass when rendering the component.</p>
<h2 id="pretender-ember-cli-pretender">pretender / ember-cli-pretender</h2>
<p><a href="https://github.com/pretenderjs/pretender">Pretender</a> is a mock server library which makes it pretty straight-forward to define how mocked endpoints should behave, what kind of payload they should return and verify that the requests were performed to the given endpoints.</p>
<p>The API is limited but powerful - you just need to create a new instance of <code>Pretender</code> and mock the endpoints in the callback argument. You can define how the endpoints should behave using <code>get</code>, <code>post</code>, <code>put</code>, <code>patch</code>, <code>delete</code> and <code>head</code> methods.</p>
<p>Each of those methods takes three arguments: a path pattern, a callback handling the logic for given endpoint and an optional timing parameter. By default, all requests are asynchronous, but you can force a synchronous behavior, a response after the specified amount of time or making the endpoint not responding automatically at all which requires a manual resolving.</p>
<p>Each endpoint must return an array of 3 elements: HTTP status code, headers, and body.</p>
<p>Here’s an example how you could use it:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">
<span class="kw">const</span> booking_1 <span class="op">=</span> <span class="op">{</span>
  <span class="op">{</span>
    <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;bookings&#39;</span><span class="op">,</span>
    <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;1&#39;</span><span class="op">,</span>
    <span class="dt">attributes</span><span class="op">:</span> <span class="op">{</span>
      <span class="st">&#39;start-at&#39;</span><span class="op">:</span> <span class="st">&#39;2017-01-01T12:00:00Z&#39;</span><span class="op">,</span>
      <span class="st">&#39;end-at&#39;</span><span class="op">:</span> <span class="st">&#39;2017-01-10T08:00:00Z&#39;</span><span class="op">,</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">};</span>

<span class="kw">const</span> booking_2 <span class="op">=</span> <span class="op">{</span>
  <span class="op">{</span>
    <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;bookings&#39;</span><span class="op">,</span>
    <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;2&#39;</span><span class="op">,</span>
    <span class="dt">attributes</span><span class="op">:</span> <span class="op">{</span>
      <span class="st">&#39;start-at&#39;</span><span class="op">:</span> <span class="st">&#39;2017-02-01T12:00:00Z&#39;</span><span class="op">,</span>
      <span class="st">&#39;end-at&#39;</span><span class="op">:</span> <span class="st">&#39;2017-02-10T08:00:00Z&#39;</span><span class="op">,</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">};</span>

<span class="kw">const</span> bookings <span class="op">=</span> <span class="op">{</span>
  <span class="dt">data</span><span class="op">:</span> [booking_1<span class="op">,</span> bookings_2]
<span class="op">};</span>

<span class="kw">const</span> server <span class="op">=</span> <span class="kw">new</span> <span class="at">Pretender</span>(<span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">get</span>(<span class="st">&#39;/api/bookings&#39;</span><span class="op">,</span>(request) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">return</span> [<span class="dv">200</span><span class="op">,</span> <span class="op">{</span><span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">},</span>
      <span class="va">JSON</span>.<span class="at">stringify</span>(bookings)]<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">get</span>(<span class="st">&#39;/api/bookings/:id&#39;</span><span class="op">,</span> (request) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> idsBookingsMapping <span class="op">=</span> <span class="op">{</span>
      <span class="st">&#39;1&#39;</span><span class="op">:</span> booking_1<span class="op">,</span>
      <span class="st">&#39;2&#39;</span><span class="op">:</span> booking_2<span class="op">,</span>
    <span class="op">};</span>
    <span class="kw">const</span> id <span class="op">=</span> <span class="va">request</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">;</span>

    <span class="cf">return</span> [<span class="dv">200</span><span class="op">,</span> <span class="op">{</span><span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span><span class="op">},</span> <span class="va">JSON</span>.<span class="at">stringify</span>(<span class="op">{</span>
      <span class="dt">data</span><span class="op">:</span> idsBookingsMapping[id]
    <span class="op">}</span>)]<span class="op">;</span>
  <span class="op">},</span> <span class="dv">5000</span>)<span class="op">;</span> <span class="co">// respond after 5 seconds</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And what is this <code>request</code> argument passed to a handler callback? It’s a <code>FakeRequest</code> object which offers a pretty convenient API giving you access to <code>params</code>, <code>queryParams</code>, <code>requestBody</code> or <code>requestParams</code> properties making it easy to do proper assertions and stub endpoints with some extra features like filtering which will be much closer to the behavior of a real backend server.</p>
<p><code>Pretender</code> has also some other interesting features like <code>handledRequest(verb, path, request)</code> hook which makes it easy to do some assertions about specific endpoints being called or <code>prepareHeaders(headers)</code> and <code>prepareBody(body)</code> hooks for some extra transformations of headers and body for each request. For a full reference to all features check the <a href="https://github.com/pretenderjs/pretender">docs</a>.</p>
<p>What about <code>ember-cli-pretender</code>? It’s just an extra layer for the integration of <code>pretender</code> with <code>ember-cli</code> apps; it doesn’t introduce any new features.</p>
<p><code>Pretender</code> is a handy tool, but adding all these handlers and preparing payloads for every endpoint can get quite cumbersome, especially when dealing with a more complex format such as JSONAPI. It would be good to have something that would make it much easier and DRY and add some factories on top to have a mocked backend DB. Fortunately, there’s an exact solution for that, which is a wrapper for <code>pretender</code> plus tons of other excellent features that make dealing with HTTP requests pretty simple. Time to meet <a href="http://www.ember-cli-mirage.com">ember-cli-mirage</a>.</p>
<h2 id="ember-cli-mirage">ember-cli-mirage</h2>
<h3 id="overview">Overview</h3>
<p><code>ember-cli-mirage</code> is a powerful tool which provides both mock backend server and factories/fixtures, which makes not only a testing much easier but also the development of the application is much faster - we no longer need real backend server, as we can rely just on a mock backend server. And the remarkable thing is that <code>ember-cli-mirage</code> handler JSONAPI format out-of-box! Even if we need any extra customization, we can quickly adjust the specific endpoints to do something more. Let’s take a look at some examples.</p>
<h3 id="getting-started">Getting started</h3>
<p>After installing the addon via <code>ember install ember-cli-mirage</code> we will see that <code>mirage</code> directory was added to the main directory of the app which consists of:</p>
<ul>
<li><p><code>config.js</code> file for defining route handlers,</p></li>
<li><p><code>scenarios</code> directory with <code>default.js</code> file which is supposed to be used for seeding mock database</p></li>
<li><p><code>serializers</code> directory with <code>application.js</code> serializer which by default handles JSONAPI format.</p></li>
</ul>
<h3 id="ember-cli-mirage-101">ember-cli-mirage 101</h3>
<p>Let’s define some example routes to see ember-cli-mirage in action. As this layer is a wrapper for <code>pretender</code>, we may expect that it will work similarly. And that’s indeed the case! We can define route handlers for given path pattern for <code>get</code>, <code>post</code>, <code>put</code>, <code>patch</code> and <code>del</code> methods. Here’s a simple example how to define a handler returning all users:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">get</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="dt">data</span><span class="op">:</span> [
    <span class="op">{</span>
      <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;1&#39;</span><span class="op">,</span>
      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;users&#39;</span><span class="op">,</span>
      <span class="dt">attributes</span><span class="op">:</span> <span class="op">{</span>
        <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;ember-cli-mirage@is-awesome.com&#39;</span>
      <span class="op">}</span>
    <span class="op">}</span>
  ]
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>It’s still a bit simpler than defining handlers in <code>pretender</code>; nevertheless, it doesn’t offer much of an improvement so far. Let’s add some real models and play with <code>ember-cli-mirage</code> ORM and mock database and see how powerful it is!</p>
<h3 id="ember-cli-mirage-models-and-route-handlers">ember-cli-mirage models and route handlers</h3>
<p>If we want to interact with a mock in-memory database, we need to define models first. For now, let’s focus on the minimum thing that will work and start with generating <code>user</code> model. We can use a built-in generator for that:</p>
<pre><code>ember g mirage-model user</code></pre>
<p>It should generate <code>user.js</code> file under <code>mirage/models</code> directory with the following body:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/models/user.js</span>
<span class="im">import</span> <span class="op">{</span> Model <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> Model<span class="op">;</span></code></pre></td></tr></table></div>
<p>And for now, this is enough to define virtual <code>users</code> “table” in the mock database.</p>
<p>Before <code>0.3.2</code> version of it was necessary to generate those separate models for <code>ember-cl-mirage</code>, but fortunately, we are now able to reuse just Ember Data model for this purpose by setting <code>discoverEmberDataModels</code> to true for the ENV:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript">ENV[<span class="st">&#39;ember-cli-mirage&#39;</span>] <span class="op">=</span> <span class="op">{</span>
  <span class="dt">discoverEmberDataModels</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">};</span></code></pre></td></tr></table></div>
<p>Later in the book, we will use the exact config to avoid generating models manually.</p>
<p>Let’s get back to the routes and define route handlers for all the CRUD actions.</p>
<p>Here’s the simplest form of a route handler for getting all users:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">get</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> (schema) <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="cf">return</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">all</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>The first argument passed to the handler callback is <code>schema</code> which exposes models and database giving us all the tools we need to interact with a mock backend, available under <code>schema.db</code> attribute.</p>
<p>One of these model collections is <code>schema.users</code> which exposes various methods for manipulating and accessing the specified collection. <code>all()</code> method is one of those that return all records for given model, but there are also few more:</p>
<ul>
<li><p><code>find(id_or_ids)</code> - finds record(s) with given id(s). Note that you can also pass the array of ids. You can use it either as <code>schema.users.find(10)</code> or <code>schema.users.find([10, 20, 30])</code></p></li>
<li><p><code>where(conditions)</code> - return records matching provided conditions specified as key-value pairs, e.g. <code>schema.users.where({ isAdmin: true })</code></p></li>
<li><p><code>first()</code> - returns first item from collection: <code>schema.users.first()</code></p></li>
<li><p><code>new(attributes)</code> - creates an unpersisted (i.e. without <code>id</code>) record with specified attributes: <code>schema.users.new({ isAdmin: true, full_name: 'Rich Piana' })</code></p></li>
<li><p><code>create()</code> - similar to <code>new()</code>, but creates a persisted record having <code>id</code>, e.g. <code>schema.users.create({ isAdmin: true, fullName: 'Rich Piana' })</code></p></li>
</ul>
<p>The important thing is that these methods don’t return just some sets of attributes, but real object with a very useful API:</p>
<ul>
<li><code>attrs()</code> - returns attributes of given model record:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">const</span> user <span class="op">=</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">find</span>(<span class="dv">1</span>)<span class="op">;</span>
<span class="va">user</span>.<span class="at">attrs</span>()
  <span class="co">// =&gt; { id: 1, fullName: &#39;Rich Piana&#39; }</span></code></pre></td></tr></table></div>
<ul>
<li><code>save()</code> - persists records with applied changes to the attributes’ values:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">const</span> user <span class="op">=</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">new</span>(<span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Rich&#39;</span> <span class="op">}</span>)
<span class="va">user</span>.<span class="at">id</span>
  <span class="co">// =&gt; null, record is not persisted</span>

<span class="va">user</span>.<span class="at">save</span>()
<span class="va">user</span>.<span class="at">id</span>
  <span class="co">// =&gt; 1, record got persisted</span>

<span class="va">user</span>.<span class="at">name</span> <span class="op">=</span> <span class="st">&#39;Lazar&#39;</span>
  <span class="co">// the attribute has been assigned, but the changes are</span>
  <span class="co">// not persisted yet</span>
<span class="va">user</span>.<span class="at">save</span>()
  <span class="co">// the changes to the attributes have been persisted</span></code></pre></td></tr></table></div>
<ul>
<li><code>update(attribute, value)</code> - updates specified attributes for given records and // persists changes to the database:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">const</span> user <span class="op">=</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">find</span>(<span class="dv">1</span>)<span class="op">;</span>

<span class="va">user</span>.<span class="at">update</span>(<span class="st">&#39;name&#39;</span><span class="op">,</span> <span class="st">&#39;Rich&#39;</span>})
  <span class="co">// `name` attribute has been updated and the update has been persisted to the database</span></code></pre></td></tr></table></div>
<ul>
<li><code>destroy()</code> - removes given record from the database:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">const</span> user <span class="op">=</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">find</span>(<span class="dv">1</span>)<span class="op">;</span>

<span class="va">user</span>.<span class="at">destroy</span>()<span class="op">;</span>
  <span class="co">// record has been removed from the database</span></code></pre></td></tr></table></div>
<ul>
<li><code>isNew()</code> - returns <code>true</code> if record has not been persisted to the database:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">const</span> user <span class="op">=</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">new</span>(<span class="op">{</span> <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Lazar Angelov&#39;</span> <span class="op">}</span>)<span class="op">;</span>

<span class="va">user</span>.<span class="at">isNew</span>()<span class="op">;</span> <span class="co">// true</span>

<span class="va">user</span>.<span class="at">save</span>()<span class="op">;</span>
  <span class="co">// user has been persisted</span>
<span class="va">user</span>.<span class="at">isNew</span>()<span class="op">;</span> <span class="co">// false</span></code></pre></td></tr></table></div>
<ul>
<li><code>isSaved()</code> - returns true if the record is persisted in the database:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">const</span> user <span class="op">=</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">new</span>(<span class="op">{</span> <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Lazar Angelov&#39;</span> <span class="op">}</span>)<span class="op">;</span>

<span class="va">user</span>.<span class="at">isSaved</span>()<span class="op">;</span> <span class="co">// false</span>

<span class="va">user</span>.<span class="at">save</span>()<span class="op">;</span>
  <span class="co">// user has been persisted</span>
<span class="va">user</span>.<span class="at">isSaved</span>()<span class="op">;</span> <span class="co">// true</span></code></pre></td></tr></table></div>
<p>What about the database itself, available under <code>schema.db</code> attribute?</p>
<p>In most cases you won’t probably need to access it directly as accessing the model collection is going to be enough; nevertheless, it might be worth knowing the available API for manipulating it in case it is necessary.</p>
<ul>
<li><code>collection</code> - it’s not an attribute, but a particular model collection name, e.g. <code>users</code>, returning the array with the records of given type. The important thing to keep in mind is that it doesn’t return real models, only the database representation of them:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">schema</span>.<span class="va">db</span>.<span class="at">users</span>[<span class="dv">0</span>]<span class="op">;</span>
  <span class="co">// { id: &#39;1&#39;, fullName: &#39;Rich Piana&#39; }, just the attributes</span></code></pre></td></tr></table></div>
<ul>
<li><code>insert(attributes_or_array_with_attributes)</code> - inserts record or records or with given attributes to the database. It returs the newly inserted record or records with added <code>id</code>:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">insert</span>(<span class="op">{</span> <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Rich Piana&#39;</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="co">// { fullName: &quot;Rich Piana&quot;, id: &#39;2&#39; }</span>

<span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">insert</span>([
  <span class="op">{</span> <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Rich Piana&#39;</span> <span class="op">},</span>
  <span class="op">{</span> <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Lazar Angelov&#39;</span> <span class="op">}</span>
)<span class="op">;</span>
  <span class="co">// [{ fullName: &#39;Rich Piana&#39;, id: &#39;3&#39; }, { fullName: &#39;Lazar Angelov&#39;, id: &#39;4&#39; }]</span></code></pre></td></tr></table></div>
<ul>
<li><code>find(id_or_ids)</code> - returns record or record with given id / ids:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">find</span>(<span class="st">&#39;3&#39;</span>)<span class="op">;</span>
  <span class="co">// { fullName: &#39;Rich Piana&#39;, id: &#39;3&#39; }</span>

<span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">find</span>([<span class="st">&#39;3&#39;</span><span class="op">,</span> <span class="st">&#39;4&#39;</span>])<span class="op">;</span>
  <span class="co">// [{ fullName: &#39;Rich Piana&#39;, id: &#39;3&#39; },</span>
  <span class="co">// { fullName: &#39;Lazar Angelov&#39;, id: &#39;4&#39; }]</span></code></pre></td></tr></table></div>
<ul>
<li><code>where(conditions)</code> - returns records matching specified conditions provided as key-value pairs:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">where</span>(<span class="op">{</span> <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Rich Piana });</span>
  <span class="co">// [{ fullName: &#39;Rich Piana, id: &#39;3&#39; }];</span></code></pre></td></tr></table></div>
<ul>
<li><code>update(attributes)</code> - updates all records with given attributes:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">update</span>(<span class="op">{</span> <span class="dt">isAdmin</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span> <span class="co">// all users are updated with `isAdmin`</span>
  <span class="co">// value set to `true`</span></code></pre></td></tr></table></div>
<ul>
<li><code>update(record, attributes)</code> - updates a record identified by either <code>id</code> or records matching specified conditions provided as key-value pairs and updates their attributes:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">update</span>(<span class="st">&#39;3&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">isAdmin</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="co">// a user with `id` &#39;3&#39;</span>
  <span class="co">// updated with `isAdmin` value set to `true`</span>
<span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">update</span>(<span class="op">{</span> <span class="dt">fullname</span><span class="op">:</span> <span class="st">&#39;Lazar Angelov&#39;</span> <span class="op">},</span> <span class="op">{</span> <span class="dt">isAdmin</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="co">// all users with `fullname` &#39;Lazar Angelov&#39; are updated with `isAdmin` value set to `true`</span></code></pre></td></tr></table></div>
<ul>
<li><code>remove()</code> - removes all records from the database:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">remove</span>()<span class="op">;</span> <span class="co">// schema.db.users =&gt; []</span></code></pre></td></tr></table></div>
<ul>
<li><code>remove(record)</code> - removes a record identified by either <code>id</code> or records matching specified conditions provided as key-value pairs:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">remove</span>(<span class="st">&#39;3&#39;</span>)<span class="op">;</span> <span class="co">// removes record with id &#39;3&#39;</span>
<span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">remove</span>(<span class="op">{</span> <span class="dt">fullname</span><span class="op">:</span> <span class="st">&#39;Rich Piana&#39;</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="co">// removes records with `fullname` &#39;Rich Piana&#39;</span></code></pre></td></tr></table></div>
<ul>
<li><code>firstOrCreate(conditions, attributesForCreate)</code> - finds a record matching specified conditions provided as key-value pairs or creates a new one using specified attributes for create:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">firstOrCreate</span>(<span class="op">{</span> <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Rich Piana&#39;</span> <span class="op">}</span>)
  <span class="co">// finds a record with `fullName` &#39;Rich Piana&#39; or creates a new one</span>
<span class="va">schema</span>.<span class="va">db</span>.<span class="va">users</span>.<span class="at">firstOrCreate</span>(<span class="op">{</span> <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Rich Piana&#39;</span> <span class="op">},</span> <span class="op">{</span> <span class="dt">isAdmin</span><span class="op">:</span> <span class="kw">true</span><span class="op">}</span>)
  <span class="co">// finds a record with `fullName` &#39;Rich Piana&#39; or creates</span>
  <span class="co">// a new one assigning also `isAdmin` attribute with `true` value</span></code></pre></td></tr></table></div>
<p>Now that we know quite a lot about <code>schema</code> and we can define route handler for getting all records, we need to answer one important question: how does <code>ember-cli-mirage</code> handle serialization of the response? The format of the result returned by <code>schema.users.all()</code> is far from, e.g. JSONAPI standard which is the default choice in Ember Data. Under the hood <code>ember-cli-mirage</code> uses a serializer for given model (which can be defined in <code>mirage/serializers</code> directory. By default it’s <code>JSONAPISerializer</code> as well, but you can also pick <code>RESTSerializer</code> and <code>ActiveModelSerializer</code>), so we don’t need really need to think about the format that Ember Data models expect, the serializer layer will do it for us.</p>
<p>Let’s try to define a handler for getting a model with given id:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">get</span>(<span class="st">&#39;/api/users/:id&#39;</span><span class="op">,</span> (<span class="op">{</span> users <span class="op">},</span> request) <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="cf">return</span> <span class="va">users</span>.<span class="at">find</span>(<span class="va">request</span>.<span class="va">params</span>.<span class="at">id</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Just like we define a route handler for given path pattern in <code>pretender</code>, we do the same in <code>ember-cli-mirage</code>. Also, we had access to <code>request</code> param, and so we do in this case! <code>request</code> is a second argument in the callback available in every route handler we define. Thanks to ES 6 destructuring feature, we can add some syntactic sugar for getting a specified collection from <code>schema</code>. Then, we are simply using <code>find()</code> method on collection passing an <code>id</code> from the <code>params</code>.</p>
<p>And how to implement an action for creating new records? There is <code>create</code> method available on collection and that’s exactly what we need here:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">post</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> (<span class="op">{</span> users <span class="op">},</span> request) <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="kw">const</span> attributes <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(<span class="va">request</span>.<span class="at">requestBody</span>)<span class="op">;</span>

  <span class="va">users</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>It’s pretty straightforward - we just take <code>requestBody</code> from <code>request</code>, parse it and create a new record. However, this is not an elegant solution, and there is a potential problem - <code>ember-cli-mirage</code> expects a normalized format of the data to be used in <code>create</code> method! If your Ember Data models are using JSONAPI format, the payload will be far from the expected format. Fortunately, there is <code>normalizedRequestAttrs()</code> helper method implemented for exactly this purpose:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">post</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> <span class="kw">function</span>(<span class="op">{</span> users <span class="op">},</span> request) <span class="op">{</span>
  consts attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>

  <span class="cf">return</span> <span class="va">users</span>.<span class="at">create</span>(attrs)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>This method takes care of the normalization process, which is based on the model’s serializer, so we don’t need to give it much thought.</p>
<p>Note that we need a proper context inside the callback function (<code>this.normalizedRequestAttrs()</code>), so we cannot use arrow functions in such case.</p>
<p>Updating models is quite similar, we just need to find given model by <code>id</code> and call <code>update</code> method passing normalized attributes:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">this</span>.<span class="at">put</span>(<span class="st">&#39;/api/users/:id&#39;</span><span class="op">,</span> <span class="kw">function</span>(<span class="op">{</span> users <span class="op">},</span> request) <span class="op">{</span>
  <span class="kw">const</span> id <span class="op">=</span> <span class="va">request</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">;</span>
  consts attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>

  <span class="cf">return</span> <span class="va">users</span>.<span class="at">find</span>(id).<span class="at">update</span>(attributes)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And for deleting models we just need to call <code>destroy()</code> on a model:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">this</span>.<span class="at">del</span>(<span class="st">&#39;/api/users/:id&#39;</span><span class="op">,</span> (<span class="op">{</span> users <span class="op">},</span> request) <span class="op">=&gt;</span> <span class="op">{</span>
  consts id <span class="op">=</span> <span class="va">request</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">;</span>

  <span class="va">users</span>.<span class="at">find</span>(id).<span class="at">destroy</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>That way we defined all the CRUD actions for <code>users</code> resource. But defining all these handlers is quite repetitive, and most handlers will look the same for other resources. Is it possible to DRY it up a bit? The answer is yes! And it’s quite easy.</p>
<h3 id="ember-cli-mirage-shorthands-and-resource-helper">ember-cli-mirage: shorthands and <code>resource</code> helper</h3>
<p>Defining a <code>shorthand</code> in <code>ember-cli-mirage</code> simply means adding a route action without a callback, which is optional. If not provided, the default handler will be used, which looks exactly the same as the callbacks we previously defined. That way entire CRUD for some resource could be defined the following:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">get</span>(<span class="st">&#39;/api/users&#39;</span>)
<span class="kw">this</span>.<span class="at">get</span>(<span class="st">&#39;/api/users/:id&#39;</span>)
<span class="kw">this</span>.<span class="at">post</span>(<span class="st">&#39;/api/users&#39;</span>)
<span class="kw">this</span>.<span class="at">patch</span>(<span class="st">&#39;/api/users/:id&#39;</span>)
<span class="kw">this</span>.<span class="at">delete</span>(<span class="st">&#39;/api/users/:id&#39;</span>)</code></pre></td></tr></table></div>
<p>If we don’t want to prefix every path pattern with <code>api</code>, we can provide a <code>namespace</code> to make it even shorter:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">namespace</span> <span class="op">=</span> <span class="st">&#39;/api&#39;</span><span class="op">;</span>

<span class="kw">this</span>.<span class="at">get</span>(<span class="st">&#39;/users&#39;</span>)
<span class="kw">this</span>.<span class="at">get</span>(<span class="st">&#39;/users/:id&#39;</span>)
<span class="kw">this</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span>)
<span class="kw">this</span>.<span class="at">patch</span>(<span class="st">&#39;/users/:id&#39;</span>)
<span class="kw">this</span>.<span class="at">delete</span>(<span class="st">&#39;/users/:id&#39;</span>)</code></pre></td></tr></table></div>
<p>But that’s not everything; we can DRY it up even more! Rails-like <code>resource</code> helper is available for exactly this purpose which allows defining CRUD actions for given resource:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">namespace</span> <span class="op">=</span> <span class="st">&#39;/api&#39;</span><span class="op">;</span>

<span class="kw">this</span>.<span class="at">resource</span>(<span class="st">&#39;users&#39;</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We can also whitelist or blacklist actions using <code>only</code> and <code>except</code> options:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">namespace</span> <span class="op">=</span> <span class="st">&#39;/api&#39;</span><span class="op">;</span>

<span class="kw">this</span>.<span class="at">resource</span>(<span class="st">&#39;users&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">only</span><span class="op">:</span> [<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="st">&#39;show&#39;</span><span class="op">,</span> <span class="st">&#39;create&#39;</span>] <span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/config.js</span>
<span class="kw">this</span>.<span class="at">namespace</span> <span class="op">=</span> <span class="st">&#39;/api&#39;</span><span class="op">;</span>

<span class="kw">this</span>.<span class="at">resource</span>(<span class="st">&#39;users&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">except</span><span class="op">:</span> [<span class="st">&#39;update&#39;</span><span class="op">,</span> <span class="st">&#39;delete&#39;</span>] <span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>This is the exact mapping between actions and route handlers:</p>
<pre><code>| action       | route handler          |
|--------------|------------------------|
|  index       | this.get(&#39;/users&#39;);    |
|---------------------------------------|
|  show        | this.get(&#39;/users/:id&#39;);|
|---------------------------------------|
|  create      | this.post(&#39;/users&#39;);   |
|---------------------------------------|
|  update      | this.patch(&#39;/users&#39;);  |
|              | this.put(&#39;/users&#39;);    |
|---------------------------------------|
|  delete      | this.del(&#39;/users/:id&#39;);|</code></pre>
<h3 id="ember-cli-mirage-models-and-associations">ember-cli-mirage: models and associations</h3>
<p>Associations are a big part of modeling the domain layer. As you may expect, <code>ember-cli-mirage</code> has a great API for defining those as well. For this purpose there are two helpers: <code>belongsTo</code> and <code>hasMany</code>. Let’s see them in action:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/models/user.js</span>
<span class="im">import</span> <span class="op">{</span> Model<span class="op">,</span> belongsTo <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">organization</span><span class="op">:</span> <span class="at">belongsTo</span>()<span class="op">,</span>
  <span class="dt">articles</span><span class="op">:</span> <span class="at">hasMany</span>()<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We’ve just defined a to-one relationship between Users and Organizations and to-many between Users and Articles. If you follow the conventions of the naming, you won’t need to provide the literal model name for a given relationship as it will be inferred from the attribute name. However, if the model name differs from attribute name, you will need to provide the proper name as the first argument:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/models/user.js</span>
<span class="im">import</span> <span class="op">{</span> Model<span class="op">,</span> belongsTo <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">organization</span><span class="op">:</span> <span class="at">belongsTo</span>(<span class="st">&#39;company&#39;</span>)<span class="op">,</span>
  <span class="dt">articles</span><span class="op">:</span> <span class="at">hasMany</span>()<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>By declaring those relationships, we gain some dynamically defined methods for manipulating them. We get readers/writers for id/ids and methods for building the associated models.</p>
<p>This is how we could manipulate <code>organization</code> relationship:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">const</span> user <span class="op">=</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">find</span>(<span class="dv">1</span>)<span class="op">;</span>

<span class="va">user</span>.<span class="at">organizationId</span><span class="op">;</span> <span class="co">// 2</span>
<span class="va">user</span>.<span class="at">organization</span><span class="op">;</span> <span class="co">// returns organization with id equal to 2</span>
<span class="va">user</span>.<span class="at">organizationId</span><span class="op">;</span> <span class="co">// 1;</span>
<span class="va">user</span>.<span class="at">organization</span><span class="op">;</span>
  <span class="co">// returns organization with id equal to 1</span>
<span class="va">user</span>.<span class="at">newOrganization</span>(<span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;5% Nutrition&#39;</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="co">// builds in-memory organization instance associated to the user</span>
<span class="va">user</span>.<span class="at">createOrganization</span>(<span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;5% Nutrition&#39;</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="co">// creates persisted organization instance associated to the user</span></code></pre></td></tr></table></div>
<p>And here are the set of methods for manipulating articles:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="kw">const</span> user <span class="op">=</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">find</span>(<span class="dv">1</span>)<span class="op">;</span>

<span class="va">user</span>.<span class="at">articleIds</span><span class="op">;</span> <span class="co">// [10, 12, 100]</span>
<span class="va">user</span>.<span class="at">articleIds</span> <span class="op">=</span> [<span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">;</span>
  <span class="co">// replaces current articles with the new set</span>
<span class="va">user</span>.<span class="at">articles</span><span class="op">;</span>
  <span class="co">// returns array of associated articles</span>
<span class="va">user</span>.<span class="at">articles</span> <span class="op">=</span> [article1<span class="op">,</span> article2]<span class="op">;</span>
  <span class="co">// replaces current articles with the new set</span>
<span class="va">user</span>.<span class="at">newArticle</span>(<span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Pumping biceps to the max&#39;</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="co">// builds in-memory article instance associated to the user</span>
<span class="va">user</span>.<span class="at">createArticle</span>((<span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Pumping biceps to the max&#39;</span> <span class="op">}</span>))<span class="op">;</span>
  <span class="co">// creates persisted article instance associated to the user</span></code></pre></td></tr></table></div>
<p>Keep in mind that there is no need to define those relationships if the Ember Data models discovery feature is enabled.</p>
<h3 id="ember-cli-mirage-factories">ember-cli-mirage: factories</h3>
<h4 id="attributes">Attributes</h4>
<p>Route handlers and mock database aren’t the only things that <code>ember-cli-mirage</code> is responsible for. Another layer that makes our life as developers much easier are <strong>factories</strong>.</p>
<p>Factories are blueprints for model records with certain set of attributes and relationships which are used for seeding the database. You can either generate factory files by built-in generator:</p>
<pre><code>ember g mirage-factory user</code></pre>
<p>or create them manually inside <code>mirage/factories</code> directory.</p>
<p>Let’s define a basic factory for creating users:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/factories/user.js</span>
<span class="im">import</span> <span class="op">{</span> Factory <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Rich Piana&#39;</span><span class="op">,</span>
  <span class="dt">companyName</span><span class="op">:</span> <span class="st">&#39;5% Nutrition&#39;</span><span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>To define a new factory we need to extend <code>Factory</code> and provide the set of attributes. We are not limited to only static attributes like in the example above, but we can also provide dynamic ones taking a sequence number as an argument:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/factories/user.js</span>
<span class="im">import</span> <span class="op">{</span> Factory <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">fullName</span><span class="op">:</span> <span class="st">&#39;Rich Piana&#39;</span><span class="op">,</span>
  <span class="dt">companyName</span><span class="op">:</span> <span class="st">&#39;5% Nutrition&#39;</span><span class="op">,</span>
  <span class="at">birthDate</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">email</span>(i) <span class="op">{</span>
    <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span>.<span class="at">fullName</span><span class="sc">}</span><span class="vs">_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">@example.com`</span><span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Note that inside the definition of a dynamic attribute we have access to the current context (<code>this</code>) so we can reference other attributes.</p>
<p>We often need to use some random data, but with more meaningful values, especially if we want to reuse such data outside of tests. Fortunately, we can take advantage of <code>faker</code> which is included in <code>ember-cli-mirage</code> for exactly this purpose:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/factories/user.js</span>
<span class="im">import</span> <span class="op">{</span> Factory<span class="op">,</span> faker <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">firstName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">firstName</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">lastName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">lastName</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="dt">companyName</span><span class="op">:</span> <span class="st">&#39;5% Nutrition&#39;</span><span class="op">,</span>
  <span class="at">birthDate</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">email</span>(i) <span class="op">{</span>
    <span class="cf">return</span> <span class="vs">`email_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">@example.com`</span><span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>You can learn more about <code>faker</code> form the <a href="https://github.com/marak/Faker.js/">docs</a>.</p>
<h4 id="building-and-creating-records-from-factories">Building And Creating Records From Factories</h4>
<p>To instantiate persisted or non-persisted records we can use <code>create()</code>/<code>createList()</code> for creating one record or multiple records or <code>build()</code>/<code>buildList()</code> for building one or multiple records. All these methods are available on the <code>server</code> object, which is a global injected to every acceptance test, but you can also make it available in unit or integration tests using <code>startMirage()</code> initializer:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/integration/awesome-integration-test-with-mirage.js</span>
<span class="im">import</span> <span class="op">{</span> startMirage <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;my-app/initializers/ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;awesome-integration-test-with-mirage&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component |</span>
  awesome integration test <span class="cf">with</span> mirage<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">server</span> <span class="op">=</span> <span class="at">startMirage</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">afterEach</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="va">server</span>.<span class="at">shutdown</span>()<span class="op">;</span>
  <span class="op">}</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>Let’s reuse previous factory for <code>users</code>:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/factories/user.js</span>
<span class="im">import</span> <span class="op">{</span> Factory<span class="op">,</span> faker <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">firstName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">firstName</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">lastName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">lastName</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="dt">companyName</span><span class="op">:</span> <span class="st">&#39;5% Nutrition&#39;</span><span class="op">,</span>
  <span class="at">birthDate</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">email</span>(i) <span class="op">{</span>
    <span class="cf">return</span> <span class="vs">`email_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">@example.com`</span><span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>By calling <code>server.create('user')</code> we would create a persisted <code>user</code> record. We could also provide the attributes’ overrides if we want to set some custom value instead of relying on attributes defined in the factory:</p>
<pre><code>server.create(&#39;user&#39;, { firstName: &#39;Rich&#39; });</code></pre>
<p><code>createList()</code> method is very similar, we just need to provide the <code>count</code> argument for indicating the amount of records we want to create:</p>
<pre><code>server.createList(&#39;user&#39;);
server.createList(&#39;user&#39;, { firstName: &#39;Rich&#39; });</code></pre>
<p>Both <code>build</code> and <code>buildList</code> methods work the same as their <code>create</code> equivalents, they just create unpersisted records instead.</p>
<h4 id="setting-relationships-association-helper-aftercreate-callback">Setting relationships: <code>association</code> helper &amp; <code>afterCreate</code> callback</h4>
<p>For setting to-one relationships we can use either <strong>association</strong> helper or <strong>afterCreate</strong> callback. <strong>association</strong> sounds much more suitable, and it’s easier to use, so let’s see it in action. We could reuse the previous example with <code>users</code> belonging to some <code>organization</code>:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/models/user.js</span>
<span class="im">import</span> <span class="op">{</span> Model<span class="op">,</span> belongsTo <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">organization</span><span class="op">:</span> <span class="at">belongsTo</span>()<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And here’s our factory:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/factories/user.js</span>
<span class="im">import</span> <span class="op">{</span> Factory<span class="op">,</span> association <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">firstName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">firstName</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">lastName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">lastName</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="dt">organization</span><span class="op">:</span> <span class="at">association</span>()<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Super simple! What if the model name would not follow convention and we called it, e.g., <code>company</code>?</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/models/user.js</span>
<span class="im">import</span> <span class="op">{</span> Model<span class="op">,</span> belongsTo <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">organization</span><span class="op">:</span> <span class="at">belongsTo</span>(<span class="st">&#39;company&#39;</span>)<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>It would be still the same - <code>association</code> helper is “smart” enough to infer the proper model name from the associations defined in the model.</p>
<p>If you don’t like this approach you could also use more generic tool - <code>afterCreate</code> callback which takes two arguments: a record which is being created and the <code>server</code> instance:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/factories/user.js</span>
<span class="im">import</span> <span class="op">{</span> Factory <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">firstName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">firstName</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">lastName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">lastName</span>()<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">afterCreate</span>(user<span class="op">,</span> server) <span class="op">{</span>
    <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;organization&#39;</span><span class="op">,</span> <span class="op">{</span> user <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>For setting up to-many relationships we can use <code>afterCreate</code> callback as well:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/models/user.js</span>
<span class="im">import</span> <span class="op">{</span> Model<span class="op">,</span> belongsTo <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">organization</span><span class="op">:</span> <span class="at">belongsTo</span>(<span class="st">&#39;company&#39;</span>)<span class="op">,</span>
  <span class="dt">articles</span><span class="op">:</span> <span class="at">hasMany</span>()<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/factories/user.js</span>
<span class="im">import</span> <span class="op">{</span> Factory <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">firstName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">firstName</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">lastName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">lastName</span>()<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">afterCreate</span>(user<span class="op">,</span> server) <span class="op">{</span>
    <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;organization&#39;</span><span class="op">,</span> <span class="op">{</span> user <span class="op">}</span>)<span class="op">;</span>
    <span class="va">server</span>.<span class="at">createList</span>(<span class="st">&#39;article&#39;</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="op">{</span> user <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<h4 id="traits">Traits</h4>
<p>It quite often happens that there are multiple contexts of some model, e.g., a user can be an admin user or not admin-user, or an article can be either published or not published (i.e., a draft). Instead of duplicating such setup logic in the multiple tests, we can use <strong>traits</strong> which are supposed to solve exactly this problem. Let’s assume that we need to create admin and non-admin users, users that belong to some organization or do not and also the user having some articles. Here is how to do that using traits:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/factories/user.js</span>
<span class="im">import</span> <span class="op">{</span> Factory<span class="op">,</span> trait<span class="op">,</span> association <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">firstName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">firstName</span>()<span class="op">;</span>
  <span class="op">},</span>
  <span class="at">lastName</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">name</span>.<span class="at">lastName</span>()<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">adminUser</span><span class="op">:</span> <span class="at">trait</span>(<span class="op">{</span>
    <span class="dt">isAdmin</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">,</span>

  <span class="dt">withOrganization</span><span class="op">:</span> <span class="at">trait</span>(<span class="op">{</span>
    <span class="dt">organization</span><span class="op">:</span> <span class="at">association</span>()<span class="op">,</span>
  <span class="op">}</span>)<span class="op">,</span>

  <span class="dt">withComments</span><span class="op">:</span> <span class="at">trait</span>(<span class="op">{</span>
    <span class="at">afterCreate</span>(user<span class="op">,</span> server) <span class="op">{</span>
      <span class="va">server</span>.<span class="at">createList</span>(<span class="st">&#39;article&#39;</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="op">{</span> user <span class="op">}</span>)<span class="op">;</span>
    <span class="op">}</span>)<span class="op">,</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Notice that we can use both <code>afterCreate</code> callback and <code>association</code> helper inside traits.</p>
<p>To create records with given traits, we just need to pass them as arguments to <code>create()</code>/<code>createList()</code> and <code>build()</code>/<code>buildList()</code> methods:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="st">&#39;adminUser&#39;</span>)<span class="op">;</span>
<span class="va">server</span>.<span class="at">createList</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="st">&#39;adminUser&#39;</span><span class="op">,</span> <span class="st">&#39;withOrganization&#39;</span>)<span class="op">;</span>
<span class="va">server</span>.<span class="at">build</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="st">&#39;withOrganization&#39;</span><span class="op">,</span> <span class="vs">`withComments`</span>)<span class="op">;</span>
<span class="va">server</span>.<span class="at">buildList</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&#39;withOrganization&#39;</span><span class="op">,</span> <span class="vs">`withComments`</span><span class="op">,</span>
  <span class="op">{</span> <span class="dt">firstName</span><span class="op">:</span> <span class="st">&#39;Rich&#39;</span> <span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>A great thing (shown in the last example) is that we can also pass the attributes’ overrides as the last argument which will take precedence over the attributes from the traits.</p>
<h3 id="ember-cli-mirage-serializers">ember-cli-mirage: serializers</h3>
<p>Serializers layer is responsible for normalizing incoming data (POST and PUT) and serializing data to a right format. There are three types of serializers available in <code>ember-cli-mirage</code> out of the box:</p>
<ul>
<li><p>JSONAPISerializer (a default one)</p></li>
<li><p>ActiveModelSerializer</p></li>
<li><p>RestSerializer</p></li>
</ul>
<p>It’s not the layer that you do a lot of customization, nevertheless, knowing the available API may be extremely valuable when you need to do something extra. You can either customize the global serializer (the one from <code>mirage/serializers/application.js</code>) or provide a model-specific serializer. Here’s the list of the methods that you will most likely want to customize:</p>
<ul>
<li><code>serialize(object, request)</code> - override this method if you need to return different data in the route handlers than the default one. Particularly useful when you want to add, e.g., some meta data to the response:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/serializers/user.js</span>
<span class="im">import</span> BaseSerializer <span class="im">from</span> <span class="st">&#39;./application&#39;</span><span class="op">;</span>

<span class="im">export</span> defauls<span class="op">:</span> <span class="va">BaseSerializer</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">serialize</span>(object<span class="op">,</span> request) <span class="op">{</span>
    <span class="kw">const</span> originalResponse <span class="op">=</span> <span class="va">BaseSerializer</span>.<span class="va">prototype</span>.<span class="va">serialize</span>.<span class="at">apply</span>(<span class="kw">this</span><span class="op">,</span>
      arguments)<span class="op">;</span>

    <span class="va">originalResponse</span>.<span class="at">meta</span> <span class="op">=</span> <span class="op">{</span>
      <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>().<span class="at">toString</span>()<span class="op">,</span>
    <span class="op">}</span>
    <span class="cf">return</span> originalResponse<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<ul>
<li><p><code>normalize(json)</code> - customize the payload coming from POST and PUT shorthands. Keep in mind that the format must be JSONAPI-compliant.</p></li>
<li><p><code>attrs</code> - you can use this method to whitelist attributes that should be returned in a serialized response:</p></li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/serializers/user.js</span>
<span class="im">import</span> BaseSerializer <span class="im">from</span> <span class="st">&#39;./application&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">BaseSerializer</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">attrs</span><span class="op">:</span> [<span class="st">&#39;id&#39;</span><span class="op">,</span> <span class="st">&#39;firstName&#39;</span><span class="op">,</span> <span class="st">&#39;lastName&#39;</span>]
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<ul>
<li><code>include</code> - if you need to return sideloaded associations, that’s the method you should use. You can provide an array of associations or a function:</li>
</ul>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/models/user.js</span>
<span class="im">import</span> <span class="op">{</span> Model<span class="op">,</span> hasMany <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">articles</span><span class="op">:</span> <span class="at">hasMany</span>()<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/serializers/user.js</span>
<span class="im">import</span> BaseSerializer <span class="im">from</span> <span class="st">&#39;./application&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">BaseSerializer</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">include</span><span class="op">:</span> [<span class="st">&#39;articles&#39;</span>]<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>or</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/serializers/user.js</span>
<span class="im">import</span> BaseSerializer <span class="im">from</span> <span class="st">&#39;./application&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">BaseSerializer</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">include</span><span class="op">:</span> <span class="kw">function</span>(request) <span class="op">{</span>
    <span class="kw">const</span> queryParams <span class="op">=</span> <span class="va">request</span>.<span class="at">queryParams</span>
    <span class="cf">if</span> (queryParams <span class="op">&amp;&amp;</span> <span class="va">queryParms</span>.<span class="at">include</span> <span class="op">&amp;&amp;</span> <span class="va">queryParams</span>.<span class="at">indexOf</span>(<span class="st">&#39;articles&#39;</span>)) <span class="op">{</span>
      <span class="cf">return</span> [<span class="st">&#39;articles&#39;</span>]
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
      <span class="cf">return</span> []<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>As the second use case is a pretty standard feature, it works out of the box for JSONAPI serializer: just specify the relationships that should be included using <code>include</code> query param, and you won’t need to customize any serializer.</p>
<p>Check the <a href="http://www.ember-cli-mirage.com/docs/v0.2.x/serializers/">official docs</a> if you want to learn more.</p>
<h3 id="ember-cli-mirage-seeding-database">ember-cli-mirage: seeding database</h3>
<p>When it comes to testing it’s pretty straightforward - we have <code>server</code> object available in acceptance tests or we can <a href="http://www.ember-cli-mirage.com/docs/v0.2.x/manually-starting-mirage/">manually instantiate it</a> when needed. How about using factories for seeding database for development?</p>
<p>In that case, we need to take advantage of <code>mirage/scenarios/default.js</code> file and define the entire setup there inside one function accepting <code>server</code> argument:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// mirage/scenarios/default.js</span>
<span class="im">export</span> <span class="im">default</span> <span class="kw">function</span>(server) <span class="op">{</span>
  <span class="va">server</span>.<span class="at">createList</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&#39;admin&#39;</span>)<span class="op">;</span>
  <span class="va">server</span>.<span class="at">createList</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&#39;nonAdmin&#39;</span><span class="op">,</span> <span class="st">&#39;withArticle&#39;</span>)<span class="op">;</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>No need to depend on the data coming from a backend app when doing the development. Just create the right setup for the data and focus on the important parts.</p>
<h2 id="ember-test-selectors">ember-test-selectors</h2>
<p>A fundamental issue when writing acceptance or integration tests is deciding how you should identify elements when accessing them from the test. Should you use some special classes? Or maybe use some particular <code>data</code> attributes?</p>
<p>These solutions will surely work, but there are some problems with them. They add some extra stuff to DOM which is not needed besides tests, using special classes might be misleading, and you can’t easily pass <code>data</code> attributes to components (e.g. <code>data-test='user-form'</code>) just like classes as it requires adding some additional attribute bindings in the component. Keeping the conventions consistent between the projects also gets more challenging.</p>
<p>Fortunately, there is a great solution to this problem: <a href="https://github.com/simplabs/ember-test-selectors">ember-test-selectors addon</a></p>
<p>Thanks to this addon, we can use <code>data-test-*</code> attributes in DOM elements, and they will be removed from the production builds! Another awesome feature is that you can pass them to the components and these attributes will be automatically bound. Rendering the following component:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="op">{{</span>article<span class="op">-</span>comments comments<span class="op">=</span>comments data<span class="op">-</span>test<span class="op">-</span>article<span class="op">-</span>comments<span class="op">=</span><span class="va">article</span>.<span class="at">id</span><span class="op">}}</span></code></pre></td></tr></table></div>
<p>will result in the following DOM:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;ember100&quot;</span><span class="ot"> data-test-article-comments=</span><span class="st">&quot;1000&quot;</span><span class="kw">&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre></td></tr></table></div>
<p>What is more, <code>ember-test-selectors</code> comes with a <code>testSelector</code> helper which can be used in both acceptance and component integration tests. If we wanted to find the <code>div</code> wrapping the component in the previous example, we could write the following acceptance test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance: Finding components&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it finds components&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> element <span class="op">=</span> <span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;article-comments&#39;</span><span class="op">,</span> <span class="dv">1000</span>))<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(element)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance: Finding components&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it finds components&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> element <span class="op">=</span> <span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;article-comments&#39;</span><span class="op">,</span> <span class="dv">1000</span>))<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(element)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>and in a component integration tests:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;my-awesome-component&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component |</span>
  my awesome component<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it finds components&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> element <span class="op">=</span> <span class="kw">this</span>.<span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;article-comments&#39;</span><span class="op">,</span> <span class="dv">1000</span>))<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(element)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<h2 id="ember-cli-page-object">ember-cli-page-object</h2>
<p>In large test suites, it’s quite easy to find a lot of repetitions with filling the same forms for testing different scenarios, querying the same elements and making similar assertions. Not only is it not that DRY, but it adds some unnecessary noise to the tests - instead of focusing on the testing scenario you see a bunch of query selectors which are pretty meaningless. Encapsulating querying logic, filling forms, visiting pages and assertions in a separate object that is easily reusable sounds like a good idea. And guess what! There is already a solution for this problem: <a href="http://ember-cli-page-object.js.org">ember-cli-page-object</a>.</p>
<p>Imagine you are testing a user signup scenario. In such case we would probably want to visit some <strong>signup</strong> page, provide an email, a password, a password confirmation, click a button and then we should see some notification that a user has successfully signed up. An acceptance test for this use case could look like this:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/acceptance/user-signup-test.js</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance: User SignUp&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user can sign up with valid data&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="at">visit</span>(<span class="st">&#39;/signup&#39;</span>)<span class="op">;</span>
  <span class="at">fillIn</span>(<span class="st">&#39;[data-test-user-email]&#39;</span><span class="op">,</span> <span class="st">&#39;email@example.com&#39;</span>)<span class="op">;</span>
  <span class="at">fillIn</span>(<span class="st">&#39;[data-test-user-password]&#39;</span><span class="op">,</span> <span class="st">&#39;supersecretpassword123&#39;</span>)<span class="op">;</span>
  <span class="at">fillIn</span>(<span class="st">&#39;[data-test-user-password-confirmation]&#39;</span><span class="op">,</span> <span class="st">&#39;supersecretpassword123&#39;</span>)<span class="op">;</span>
  <span class="at">click</span>(<span class="st">&#39;[data-test-sign-up]&#39;</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
     <span class="kw">const</span> $notification <span class="op">=</span> <span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;success-notification&#39;</span>))<span class="op">;</span>
     <span class="va">assert</span>.<span class="at">equal</span>(
        <span class="va">$notification</span>.<span class="at">text</span>().<span class="at">trim</span>()<span class="op">,</span>
        <span class="st">&#39;You have successufully signed up!&#39;</span><span class="op">,</span>
        <span class="st">&#39;success notification should be displayed&#39;</span>
     )<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>It doesn’t look bad so far. What if we wanted to test another scenario, e.g., that some error notification is displayed when a user provides invalid data? We would have a very similar test with a lot of duplication like how to access given input. It would be much better to have it encapsulated in one place. Let’s create our first page object.</p>
<p>We can use a generator provided by the addon for creating new page objects:</p>
<pre><code>ember generate page-object singup</code></pre>
<p>We should see a new file in <code>tests/pages</code> directory. Let’s provide an interface for testing signup scenario:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/pages/signup.js</span>
<span class="im">import</span> PageObject<span class="op">,</span> <span class="op">{</span>
  clickable<span class="op">,</span>
  fillable<span class="op">,</span>
  text<span class="op">,</span>
  visitable
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;my-awesome-app/tests/page-object&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">PageObject</span>.<span class="at">create</span>(<span class="op">{</span>
  <span class="dt">visit</span><span class="op">:</span> <span class="at">visitable</span>(<span class="st">&#39;/signup&#39;</span>)<span class="op">,</span>

  <span class="dt">email</span><span class="op">:</span> <span class="at">fillable</span>(<span class="st">&#39;[data-test-user-email]&#39;</span>)<span class="op">,</span>
  <span class="dt">password</span><span class="op">:</span> <span class="at">fillable</span>(<span class="st">&#39;[data-test-user-password]&#39;</span>)<span class="op">,</span>
  <span class="dt">passwordConfirmation</span><span class="op">:</span> <span class="at">fillable</span>(<span class="st">&#39;[data-test-user-password-confirmation]&#39;</span>)<span class="op">,</span>
  <span class="dt">signUp</span><span class="op">:</span> <span class="at">clickable</span>(<span class="st">&#39;[data-test-sign-up]&#39;</span>)<span class="op">,</span>
  <span class="dt">successNotification</span><span class="op">:</span> <span class="at">text</span>(<span class="st">&#39;[data-test-success-notification]&#39;</span>)<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>There is quite a lot of things going on, so let’s break them down. To create a page object, we call, well, <code>create</code> method on <code>PageObject</code> and specify the steps for a given scenario. We are using some interesting helpers here, so let’s break them down:</p>
<ul>
<li><p><code>visitable</code> - a helper for visiting a page under given path.</p></li>
<li><p><code>fillable</code> - fills an input identified by a provided selector.</p></li>
<li><p><code>clickable</code> - clicks element identified by a given selector.</p></li>
<li><p><code>text</code> - finds an element with given selector and extracts the text from it. By default it will normalize the returned text so that we don’t need to call <code>trim()</code> on it, but if that’s not the desired behaviour, we can provide <code>normalize</code> option and set it to <code>false</code>: <code>text('[data-test-success-notification]', { normalize: false })</code></p></li>
</ul>
<p>Most of these helpers accept extra <code>options</code> argument where you can provide such options as <code>scope</code> (a parent element in which the given element is nested) and some more. You can learn more about them from the <a href="http://ember-cli-page-object.js.org/">official docs</a>.</p>
<p>And this is how we can refactor our previous test with a page object:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/acceptance/user-signup-test.js</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> page <span class="im">from</span> <span class="st">&#39;my-awesome-app/tests/pages/singup&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance: User SignUp&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user can sign up with valid data&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  page
    .<span class="at">visit</span>()
    .<span class="at">email</span>(<span class="st">&#39;email@example.com&#39;</span>)
    .<span class="at">password</span>(<span class="st">&#39;supersecretpassword123&#39;</span>)
    .<span class="at">passwordConfirmation</span>(<span class="st">&#39;supersecretpassword123&#39;</span>)
    .<span class="at">signUp</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
     <span class="va">assert</span>.<span class="at">equal</span>(
       <span class="va">page</span>.<span class="at">successNotification</span><span class="op">,</span>
        <span class="st">&#39;You have successufully signed up!&#39;</span><span class="op">,</span>
        <span class="st">&#39;success notification should be displayed&#39;</span>
     )<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Looks much better! What if we wanted to add a scenario where the sign up fails because the password confirmation doesn’t match the password? We just need to add a step for extracting text for some <code>errorNotification</code> and we can reuse the same flow:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/pages/signup.js</span>
<span class="im">import</span> PageObject<span class="op">,</span> <span class="op">{</span>
  clickable<span class="op">,</span>
  fillable<span class="op">,</span>
  text<span class="op">,</span>
  visitable
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;my-awesome-app/tests/page-object&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">PageObject</span>.<span class="at">create</span>(<span class="op">{</span>
  <span class="dt">visit</span><span class="op">:</span> <span class="at">visitable</span>(<span class="st">&#39;/signup&#39;</span>)<span class="op">,</span>

  <span class="dt">email</span><span class="op">:</span> <span class="at">fillable</span>(<span class="st">&#39;[data-test-user-email]&#39;</span>)<span class="op">,</span>
  <span class="dt">password</span><span class="op">:</span> <span class="at">fillable</span>(<span class="st">&#39;[data-test-user-password]&#39;</span>)<span class="op">,</span>
  <span class="dt">passwordConfirmation</span><span class="op">:</span> <span class="at">fillable</span>(<span class="st">&#39;[data-test-user-password-confirmation]&#39;</span>)<span class="op">,</span>
  <span class="dt">signUp</span><span class="op">:</span> <span class="at">clickable</span>(<span class="st">&#39;[data-test-sign-up]&#39;</span>)<span class="op">,</span>
  <span class="dt">successNotification</span><span class="op">:</span> <span class="at">text</span>(<span class="st">&#39;[data-test-success-notification]&#39;</span>)<span class="op">,</span>
  <span class="dt">errorNotification</span><span class="op">:</span> <span class="at">text</span>(<span class="st">&#39;[data-test-error-notification]&#39;</span>)<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And here’s another test scenario:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/acceptance/user-signup-test.js</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> page <span class="im">from</span> <span class="st">&#39;my-awesome-app/tests/pages/singup&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance: User SignUp&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user can sign up with valid data&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  page
    .<span class="at">visit</span>()
    .<span class="at">email</span>(<span class="st">&#39;email@example.com&#39;</span>)
    .<span class="at">password</span>(<span class="st">&#39;supersecretpassword123&#39;</span>)
    .<span class="at">passwordConfirmation</span>(<span class="st">&#39;supersecretpassword&#39;</span>)
    .<span class="at">signUp</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
     <span class="va">assert</span>.<span class="at">equal</span>(
       <span class="va">page</span>.<span class="at">errorNotification</span><span class="op">,</span>
        <span class="st">&#39;Password and password confirmation do not match&#39;</span><span class="op">,</span>
        <span class="st">&#39;error notification should be displayed&#39;</span>
     )<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And that’s it! Very elegant and DRY.</p>
<p>You can even use page objects in components’ integration tests with some extra setup and write much more complex scenarios using plenty of available helpers/ I would highly recommend checking the <a href="http://ember-cli-page-object.js.org">docs</a>, just to get the idea what kind of helpers are available.</p>
<p></p>
<h1 id="test-driving-our-application">Test-Driving Our Application</h1>
<h2 id="our-example-application---book.me">Our Example Application - Book.me</h2>
<p>Now that we already know the essential tools in <strong>Ember</strong> ecosystem and are fully aware of the value of writing tests and ideally sticking to TDD approach if possible, we can start developing our application.</p>
<p>The problem with many example applications is that there are either too simple to show more complex use cases that are common in real-world applications or they grow huge to the extent that many of the features don’t bring much value regarding learning new concepts and only a small part of the application is valuable.</p>
<p>Nevertheless, it is still possible to provide an exciting feature(s) that will be complicated enough with a lot of interesting use cases but won’t be too big for the book example.</p>
<p>For the last few years, I’ve been mostly involved in developing software for vacation rental industry, which makes it quite natural to provide the example within that domain. This industry comes with a lot of complex problems to solve and obviously, I won’t attempt to provide any practical examples how to solve those issues as they might not necessarily contain that much concentrated educational value, but rather focus on some CRUD with cool additions.</p>
<p>As the vacation rental industry revolves mostly around reservations for, well, rentals generally speaking (villas, hotels, apartments, etc.), the primary concern of our example application, let’s call it “Book.me”, will be rentals and bookings management. Imagine you are the owner of multiple properties (rentals). To manage those properly a robust software is surely needed as we expect a lot of reservations and inquiries coming from everywhere. In a real-world scenario creating of the majority of the bookings would be automated by integration with applications like Booking.com, Airbnb or HomeAway, but this is certainly beyond the scope of this book, so let’s focus on this particular one use case of creating the reservations manually.</p>
<p>Besides rentals management (simple CRUD), we will need to implement a nice calendar view where we will be able to select some dates and create a booking for given rental. Except for dates, we also need to specify a traveler for the booking, most likely identified by an email and/or a full name. To keep it simple, we will just ask for an email.</p>
<p>In the real-world scenario, we could expect some extra fees that would be added to the reservation like a cleaning fee, airport transfer, breakfast, etc., but adding this extra domain complexity would have little educational value compared to just creating the booking itself, so we can skip that part.</p>
<h2 id="starting-the-development---generating-new-app">Starting The Development - Generating New App</h2>
<p>Now that we know what we are going to develop, let’s move to the most interesting part: the application itself.</p>
<p>Surprise, surprise, we will start with generating the new app:</p>
<pre><code>ember new book-me</code></pre>
<p>To have a more aesthetically pleasing experience when developing our application, let’s add some HTML/CSS framework - <a href="https://github.com/BookingSync/bootstrap-bookingsync-sass"><code>bootstrap-bookingsync-sass</code></a>, which is based on Bootstrap, is used extensively inside <a href="http://bookingsync.com">BookingSync</a> universe and looks very nice. We can simply install it as an addon:</p>
<pre><code>ember install ember-cli-bootstrap-bookingsync-sass</code></pre>
<p>You will be asked for overwriting <code>app/styles/app.scss</code> and <code>app/templates/application.hbs</code>, just accept the changes, we will modify them a bit later anyway.</p>
<p>The last step is editing <code>config/environment.js</code> file and adjusting <code>contentSecurityPolicy</code> for handling Google Fonts used by the addon:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// config/environment.js</span>
<span class="va">ENV</span>.<span class="at">contentSecurityPolicy</span> <span class="op">=</span> <span class="op">{</span>
  <span class="st">&#39;default-src&#39;</span><span class="op">:</span> <span class="st">&quot;&#39;none&#39;&quot;</span><span class="op">,</span>
  <span class="st">&#39;script-src&#39;</span><span class="op">:</span> <span class="st">&quot;&#39;self&#39; &#39;unsafe-inline&#39;&quot;</span><span class="op">,</span>
  <span class="st">&#39;style-src&#39;</span><span class="op">:</span> <span class="st">&quot;&#39;self&#39; &#39;unsafe-inline&#39; https://fonts.googleapis.com&quot;</span><span class="op">,</span>
  <span class="st">&#39;font-src&#39;</span><span class="op">:</span> <span class="st">&quot;&#39;self&#39; fonts.gstatic.com&quot;</span><span class="op">,</span>
  <span class="st">&#39;connect-src&#39;</span><span class="op">:</span> <span class="st">&quot;&#39;self&#39;&quot;</span><span class="op">,</span>
  <span class="st">&#39;img-src&#39;</span><span class="op">:</span> <span class="st">&quot;&#39;self&#39; data:&quot;</span><span class="op">,</span>
  <span class="st">&#39;media-src&#39;</span><span class="op">:</span> <span class="st">&quot;&#39;self&#39;&quot;</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>And that’s enough for having some a pleasing design in the app. Now we can just start the server:</p>
<pre><code>ember s</code></pre>
<p>And you should see something like this:</p>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/book_me_01.png" alt="Initial layout" />
<p class="caption">Initial layout</p>
</div>
<p></p>
<h2 id="adding-the-first-feature---sign-up-and-sign-in">Adding The First Feature - Sign Up And Sign In</h2>
<p>Signing up and signing in are not the most exciting features out there as they get pretty repetitive in every app and don’t deal much with the core domain of the application. Nevertheless, it’s certainly useful to have one and do it from the very beginning - we need to scope models by account (we don’t want our calendar to be public, right?), so it is a good idea to start exactly with this feature. Another benefit is that we can get quickly warmed up by something moderately easy.</p>
<p>There is no excuse for this feature to not practice TDD, so let’s start with a test.</p>
<p>As we will need some extra selectors that are meaningful in the acceptance tests, we need to add <a href="https://github.com/simplabs/ember-test-selectors">ember-test-selectors</a> to our application:</p>
<pre><code>ember install ember-test-selectors</code></pre>
<p>We will also need <a href="http://www.ember-cli-mirage.com">ember-cli-mirage</a>, so let’ install it now:</p>
<pre><code>ember install ember-cli-mirage</code></pre>
<p>Now we can generate a new acceptance test:</p>
<pre><code>ember g acceptance-test sign-in-sign-up</code></pre>
<p>Let’s open <code>book-me/tests/acceptance/sign-in-sign-up-test.js</code> and write our first test now!</p>
<p>Our first feature will be signing up and ensuring that we are logged in afterward. No need for any extra things like confirmations etc., we want to keep it simple here.</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/acceptance/sign-in-sign-up-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | sign in sign up&#39;</span>)<span class="op">;</span>
<span class="at">test</span>(<span class="st">&#39;user can successfully sign up&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> <span class="kw">function</span>(schema)  <span class="op">{</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span>
      <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;example@email.com&#39;</span><span class="op">,</span>
      <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;password123&#39;</span><span class="op">,</span>
      <span class="dt">passwordConfirmation</span><span class="op">:</span> <span class="st">&#39;password123&#39;</span><span class="op">,</span>
    <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span> <span class="st">&quot;attributes don&#39;t match</span>
      the expected ones<span class="st">&quot;);</span>

    <span class="cf">return</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-link&#39;</span>))<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-email-field&#39;</span>)<span class="op">,</span> <span class="st">&#39;example@email.com&#39;</span>)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-field&#39;</span>)<span class="op">,</span> <span class="st">&#39;password123&#39;</span>)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-confirmation-field&#39;</span>)<span class="op">,</span> <span class="st">&#39;password123&#39;</span>)<span class="op">;</span>

    <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-submit-btn&#39;</span>))<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>What we want to do here is filling email, password, password confirmation fields and click some signup button. After clicking that button, we expect to hit <code>users</code> endpoint and verify that the proper payload has been sent. We also fall back to a default behavior expected by such endpoint, which is creating a user with the given attributes.</p>
<p>Let’s make this test green. We will start with a little customization in <code>templates/application.hbs</code>. Locate the navbar which currently should look like this:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/application.hbs --&gt;</span>
<span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;collapse navbar-collapse navbar-top-collapse&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-right&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;button</span><span class="ot"> class=</span><span class="st">&quot;btn btn-secondary navbar-btn&quot;</span><span class="ot"> type=</span><span class="st">&quot;button&quot;</span><span class="kw">&gt;</span>Button<span class="kw">&lt;/button&gt;</span>
    <span class="kw">&lt;button</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary navbar-btn&quot;</span><span class="ot"> type=</span><span class="st">&quot;button&quot;</span><span class="kw">&gt;</span>Call to action<span class="kw">&lt;/button&gt;</span>
  <span class="kw">&lt;/div&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre></td></tr></table></div>
<p>Remove all the buttons and replace them with the following link:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/application.hbs --&gt;</span>
{{link-to &quot;Sign up&quot; &quot;signup&quot; class=&quot;btn btn-primary navbar-btn&quot; data-test-signup-link}}</code></pre></td></tr></table></div>
<p>As an extra bonus we may change few more things in the layout. In the following section, remove <code>Welcome to Ember</code> header:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/application.hbs --&gt;</span>
<span class="kw">&lt;section</span><span class="ot"> class=</span><span class="st">&quot;main-content&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;sheet&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;h1&gt;</span>Welcome to Ember<span class="kw">&lt;/h1&gt;</span>

    {{outlet}}
  <span class="kw">&lt;/div&gt;</span>
<span class="kw">&lt;/section&gt;</span></code></pre></td></tr></table></div>
<p>and replace this part:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/application.hbs --&gt;</span>
<span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-brand-container&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;navbar-brand&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;h1&gt;&lt;i</span><span class="ot"> class=</span><span class="st">&quot;fa fa-star&quot;</span><span class="kw">&gt;&lt;/i&gt;</span> Section Name<span class="kw">&lt;/h1&gt;</span>
  <span class="kw">&lt;/span&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre></td></tr></table></div>
<p>with the following one:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/application.hbs --&gt;</span>
<span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-brand-container&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;navbar-brand&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;h1&gt;&lt;i</span><span class="ot"> class=</span><span class="st">&quot;fa fa-star&quot;</span><span class="kw">&gt;&lt;/i&gt;</span> Book Me!<span class="kw">&lt;/h1&gt;</span>
  <span class="kw">&lt;/span&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre></td></tr></table></div>
<p>Let’s get back to making our test happy: <code>signup</code> route doesn’t exist yet, so let’s add it in the router:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/router.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> config <span class="im">from</span> <span class="st">&#39;./config/environment&#39;</span><span class="op">;</span>

<span class="kw">const</span> Router <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Router</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">location</span><span class="op">:</span> <span class="va">config</span>.<span class="at">locationType</span><span class="op">,</span>
  <span class="dt">rootURL</span><span class="op">:</span> <span class="va">config</span>.<span class="at">rootURL</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="va">Router</span>.<span class="at">map</span>(<span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;signup&#39;</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> Router<span class="op">;</span></code></pre></td></tr></table></div>
<p>And let’s generate the route:</p>
<pre><code>ember g route signup</code></pre>
<p>For handling the registration action, we are going to provide <code>registerUser</code> function. To make this action available in the template let’s install <a href="https://github.com/DockYard/ember-route-action-helper">ember-route-action-helper</a>:</p>
<pre><code>ember install ember-route-action-helper</code></pre>
<p>Besides adding the action for registration, we also need to create a new <code>User</code> record in <code>beforeModel</code> hook.</p>
<p>Generating a new model sounds like a reasonable thing to do now:</p>
<pre><code>ember g model User</code></pre>
<p>We can now add two attributes that we will need for registration: <code>email</code> and <code>password</code> (we can forget for now about <code>passwordConfirmation</code>):</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/models/user.js</span>
<span class="im">import</span> DS <span class="im">from</span> <span class="st">&#39;ember-data&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Model<span class="op">,</span>
  attr<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> DS<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">email</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;string&#39;</span>)<span class="op">,</span>
  <span class="dt">password</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;string&#39;</span>)<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Before <code>0.3.2</code> version of <code>ember-cli-mirage</code> it was necessary to generate a separate set of models just for <code>ember-cl-mirage</code>, but fortunately, we are now able to reuse just Ember Data model for this purpose. We just need to enable models’ discovery feature by adding the following line to the ENV file:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/config/environment.js</span>
ENV[<span class="st">&#39;ember-cli-mirage&#39;</span>] <span class="op">=</span> <span class="op">{</span>
  <span class="dt">discoverEmberDataModels</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">};</span></code></pre></td></tr></table></div>
<p>Let’s implement the logic for <code>signup</code> route and template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/signup.hbs --&gt;</span>
<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">(route-action</span> <span class="er">&quot;registerUser&quot;</span><span class="ot"> user</span><span class="er">)</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-email&quot;</span><span class="kw">&gt;</span>Email address<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-email-field
      id=&quot;signup-email&quot;
      value=(mut user.email)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-password&quot;</span><span class="kw">&gt;</span>Password<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-password-field
      id=&quot;signup-password&quot;
      value=(mut user.password)
      class=&quot;form-control&quot;
      type=&quot;password&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-password&quot;</span><span class="kw">&gt;</span>Password Confirmation<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-password-confirmation-field
      id=&quot;signup-passwordConfirmation&quot;
      value=(mut user.passwordConfirmation)
      class=&quot;form-control&quot;
      type=&quot;password&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span>
<span class="ot">    data-test-signup-submit-btn</span><span class="kw">&gt;</span>Submit<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/signup.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">createRecord</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;user&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">registerUser</span>(user) <span class="op">{</span>
      <span class="va">user</span>.<span class="at">save</span>()<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Nothing fancy going here - we just set up some necessary form fields and create a simple route with <code>registerUser</code> action, which is executed when submitting the form.</p>
<p>Note that we haven’t added any unit tests for the route. Why is that?</p>
<p>The main reason is that these methods don’t need to be tested. <code>model</code> and <code>setupController</code> hooks may be considered as implementation details, and they are indirectly tested via the acceptance test. The decision whether the actions should be unit-tested or not is more complex though. In this case, the logic is so simple that it doesn’t require any other tests, the passing acceptance test makes me confident enough about the code that it will work. The rule of thumb would be to not add any tests unless you see the benefits of them.</p>
<p>Our Mirage backend doesn’t know so far how to handle POST requests for <code>users</code> endpoint, we can solve that problem with the following addition:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/mirage/config.js</span>
<span class="im">export</span> <span class="im">default</span> <span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></td></tr></table></div>
<p>In most cases the API URLs will be namespaced by <code>api</code> or similar a segment, to make it more real-world, we could do the same. Firstly, in the Mirage config file:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/mirage/config.js</span>
<span class="im">export</span> <span class="im">default</span> <span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">namespace</span> <span class="op">=</span> <span class="st">&#39;api&#39;</span><span class="op">;</span>

  <span class="kw">this</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></td></tr></table></div>
<p>And secondly, in the application adapter which needs to be generated in the first place:</p>
<pre><code>ember g adapter application</code></pre>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/adapters/application.js</span>
<span class="im">import</span> DS <span class="im">from</span> <span class="st">&#39;ember-data&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">DS</span>.<span class="va">JSONAPIAdapter</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">namespace</span><span class="op">:</span> <span class="st">&#39;api&#39;</span><span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Now our test is passing!</p>
<p>In the TDD cycle, besides writing tests and the actual implementation for satisfying the requirements specified in tests, there is one more phase: refactoring. At this point, I’m pretty happy with the overall design and the code, so this time we may skip this part.</p>
<p>How about the failure path? What happens if the passwords don’t match or we don’t fill any input at all and submit the form? It sounds like we need to add some validations.</p>
<p>Just like before, let’s start with the test. At this level we don’t need to test every possible failure scenario, just testing that some validation works will be good enough for acceptance tests. The details of the validation might be tested on unit-test level or integration-level later.</p>
<p>Here’s our test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/acceptance/sign-in-sign-up-test.js</span>
<span class="at">test</span>(<span class="st">&#39;user cannot signup if there is an error&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;request should not be performed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">visit</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span>

  <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-link&#39;</span>))<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-email-field&#39;</span>)<span class="op">,</span> <span class="st">&#39;example@email.com&#39;</span>)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-field&#39;</span>)<span class="op">,</span> <span class="st">&#39;password123&#39;</span>)<span class="op">;</span>

    <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-submit-btn&#39;</span>))<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Quite similar to the previous test, but here we want to make sure that the error is displayed and that no request is performed to <code>/users</code> endpoint.</p>
<p>This failure case brings a new challenge: implementing validations. Where should be put it: in the model? In the controller? Or maybe we should generate a new component?</p>
<p>Arguably, the common approach would be adding some validations in a model, especially if you have some experience in Ruby on Rails. However, adding validations to models may create some serious issues if you have multiple contexts of the validations. And the idea of having “invalid object” sounds a bit uncomfortable to me, the params might not be valid in given context, but the model object itself shouldn’t be the subject of validation. That’s why I’ve been a fan of form objects for a long time.</p>
<p>In Ember apps, there are few ways to implement form objects. One way would be simply adding some computed properties in a controller or a component which would act as a form object, validate the values and if everything went fine, it would just assign the values to the model. Another way would be using some model proxy - like <a href="https://github.com/DockYard/ember-changeset">ember-changeset</a> or <a href="https://github.com/yapplabs/ember-buffered-proxy">ember-buffered-proxy</a>, so that we don’t operate directly on models, but on something that stands in front of it. I usually choose <a href="https://github.com/DockYard/ember-changeset">ember-changeset</a> and its close friend <a href="https://github.com/DockYard/ember-changeset-validations">ember-changeset-validations</a>, which provides validation layer for changesets.</p>
<p>Let’s install these addons:</p>
<pre><code>ember install ember-changeset
ember install ember-changeset-validations</code></pre>
<p>But where are we going to use the changeset? It can be either a controller or a new component. In almost all the cases I choose to go with the components and keep controllers only for some particular use cases where the components are not enough, like query params. Components are easier to test, and they decouple concepts from the routes making them more reusable.</p>
<p>Let’s generate a new <code>signup</code> component:</p>
<pre><code>ember g component user-signup</code></pre>
<p>Let’s start by moving template content from <code>signup.hbs</code> to the component’s template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/signup.hbs --&gt;</span>
{{user-signup user=user registerUser=(route-action &quot;registerUser&quot;)}}</code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!--  book-me/app/templates/components/user-signup.hbs --&gt;</span>
<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&quot;registerUser&quot;</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-email&quot;</span><span class="kw">&gt;</span>Email address<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-email-field
      id=&quot;signup-email&quot;
      value=(mut user.email)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-password&quot;</span><span class="kw">&gt;</span>Password<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-password-field
      id=&quot;signup-password&quot;
      value=(mut user.password)
      class=&quot;form-control&quot;
      type=&quot;password&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-password&quot;</span><span class="kw">&gt;</span>Password Confirmation<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-password-confirmation-field
      id=&quot;signup-passwordConfirmation&quot;
      value=(mut user.passwordConfirmation)
      class=&quot;form-control&quot;
      type=&quot;password&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span>
<span class="ot">    data-test-signup-submit-btn</span><span class="kw">&gt;</span>Submit<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>Notice that the way the <code>registerUser</code> action is invoked has changed as we are no longer invoking a route action, but we are invoking component’s action now. Let’s add the last changes to the component to make the acceptance test for the successful path happy. However, that will require adding some new code to the component, so let’s start with a test as usual:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/components/user-signup-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;user-signup&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component | user signup&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">integration</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it invokes passed `registerUser` action when clicking on signup</span>
  button<span class="st">&#39;, function(assert) {</span>
  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> user <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> registerUser <span class="op">=</span> (userArgument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(userArgument<span class="op">,</span> user<span class="op">,</span>
      <span class="st">&#39;action should be invoked with proper user argument&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;user&#39;</span><span class="op">,</span> user)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;registerUser&#39;</span><span class="op">,</span> registerUser)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{user-signup user=user registerUser=registerUser}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-submit-btn&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>It’s just a simple component integration test where we verify that the <code>registerUser</code> action was invoked with correct arguments after clicking the signup button.</p>
<p>And here’s the implementation:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/user-signup.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">registerUser</span>() <span class="op">{</span>
      <span class="kw">const</span> user <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;user&#39;</span>)<span class="op">;</span>
      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;registerUser&#39;</span>)(user)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>After all those changes we are back to green - all tests but the one for the failure path are passing, which means we did some refactoring of the code (without changing the behavior).</p>
<p>Now, let’s add an integration test for the failure ensuring that the error messages are displayed and that the action is never called:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/user-signup-test.js</span>
<span class="at">test</span>(<span class="st">&#39;it does not invoke passed `registerUser` action when there is a</span>
  validation error and displays the error messages<span class="st">&#39;, function(assert) {</span>
  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> user <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> registerUser <span class="op">=</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;action should not be called&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;user&#39;</span><span class="op">,</span> user)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;registerUser&#39;</span><span class="op">,</span> registerUser)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{user-signup user=user registerUser=registerUser}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-submit-btn&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-errors&#39;</span>).<span class="at">length</span>)<span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>Let’s get back to the idea of using changesets, which we will need in a moment for adding validations. However, we will start with refactoring the current behavior: we will just use changesets for syncing properties to model instead of directly using the model. First, we need to change the template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/user-signup.hbs --&gt;</span>
<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&quot;registerUser&quot;</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-email&quot;</span><span class="kw">&gt;</span>Email address<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-email-field
      id=&quot;signup-email&quot;
      value=(mut changeset.email)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-password&quot;</span><span class="kw">&gt;</span>Password<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-password-field
      id=&quot;signup-password&quot;
      value=(mut changeset.password)
      class=&quot;form-control&quot;
      type=&quot;password&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-password&quot;</span><span class="kw">&gt;</span>Password Confirmation<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-password-confirmation-field
      id=&quot;signup-passwordConfirmation&quot;
      value=(mut changeset.passwordConfirmation)
      class=&quot;form-control&quot;
      type=&quot;password&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span>
<span class="ot">    data-test-signup-submit-btn</span><span class="kw">&gt;</span>Submit<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>And the component itself:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/user-signup.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">init</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>(...<span class="at">arguments</span>)<span class="op">;</span>

    <span class="kw">const</span> user <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;user&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> changeset <span class="op">=</span> <span class="kw">new</span> <span class="at">Changeset</span>(user)<span class="op">;</span>

    <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span><span class="op">,</span> changeset)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">registerUser</span>() <span class="op">{</span>
      <span class="kw">const</span> changeset <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span>)<span class="op">;</span>
      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;registerUser&#39;</span>)(changeset)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>There are not that many changes - we merely introduced a changeset, which acts as a proxy for a model and we use it interchangeably in <code>registerUser</code> action - the cool thing is that saving the changes in the changesets requires calling the <code>save</code> method, just like for models.</p>
<p>However, we need to adjust one testing scenario for the integration test, which is not aware that we use <code>changeset</code>:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/componenets/user-signup-test.js</span>
<span class="at">test</span>(<span class="st">&#39;it invokes passed `registerUser` action when clicking on</span>
  signup button<span class="st">&#39;, function(assert) {</span>
  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> user <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> registerUser <span class="op">=</span> (userArgument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="co">// a change to make it changeset-aware: userArgument =&gt; userArgument._content</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="va">userArgument</span>.<span class="at">_content</span><span class="op">,</span> user<span class="op">,</span>
      <span class="st">&#39;action should be invoked with proper user argument&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;user&#39;</span><span class="op">,</span> user)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;registerUser&#39;</span><span class="op">,</span> registerUser)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{user-signup user=user registerUser=registerUser}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-submit-btn&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>Now let’s add some validations:</p>
<pre><code>ember generate validator user-signup</code></pre>
<p>As usual, we are going to start with the tests. The problem with unit-testing validators is that we couple tests to the interface of validators, which sounds a bit like an implementation detail and ideally it should be hidden behind changeset’s interface, but doing the integration tests of validators seems to be an overkill, so let’s accept the issue of coupling to implementation details and move on.</p>
<p>Changeset validators are higher-order functions which return the validator function. Here is one example:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">export</span> <span class="im">default</span> <span class="kw">function</span> <span class="at">validateCustom</span>(options) <span class="op">{</span>
  <span class="cf">return</span> (key<span class="op">,</span> newValue<span class="op">,</span> oldValue<span class="op">,</span> changes<span class="op">,</span> content) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="co">// return true if valid or error message if invalid</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>By keeping in mind that the validator function returns <code>true</code> for valid results and error message for invalid results and that the validators are simply key-value pairs with attributes names as keys and validator functions as values, we may add some basic tests for <code>email</code> format, <code>password</code> length and <code>confirmation</code> validation for passwords:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/validators/user-signup-test.js</span>
<span class="im">import</span> <span class="op">{</span> module<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> validateUserSignup <span class="im">from</span> <span class="st">&#39;book-me/validators/user-signup&#39;</span><span class="op">;</span>

<span class="at">module</span>(<span class="st">&#39;Unit | Validator | user-signup&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates email format&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validateUserSignup</span>.<span class="at">email</span>(<span class="st">&#39;email&#39;</span><span class="op">,</span> <span class="st">&#39;invalid&#39;</span>)<span class="op">,</span>
    <span class="st">&#39;Email must be a valid email address&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validateUserSignup</span>.<span class="at">email</span>(<span class="st">&#39;email&#39;</span><span class="op">,</span> <span class="st">&#39;example@gmail.com&#39;</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates password length&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validateUserSignup</span>.<span class="at">password</span>(<span class="st">&#39;password&#39;</span><span class="op">,</span> <span class="st">&#39;invalid&#39;</span>)<span class="op">,</span>
    <span class="st">&#39;Password is too short (minimum is 8 characters)&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validateUserSignup</span>.<span class="at">password</span>(<span class="st">&#39;password&#39;</span><span class="op">,</span> <span class="st">&#39;password123&#39;</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates password confirmation&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validateUserSignup</span>.<span class="at">passwordConfirmation</span>(<span class="st">&#39;passwordConfirmation&#39;</span><span class="op">,</span>
    <span class="st">&#39;invalid&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;password123&#39;</span> <span class="op">}</span>)<span class="op">,</span>
    <span class="st">&quot;Password confirmation doesn&#39;t match password&quot;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validateUserSignup</span>.<span class="at">passwordConfirmation</span>(<span class="st">&#39;passwordConfirmation&#39;</span><span class="op">,</span>
    <span class="st">&#39;password123&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;password123&#39;</span> <span class="op">}</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Indeed, we are tightly coupled to the implementation details, but it’s good enough, we don’t need to strive for the perfect tests suite. Writing those specs require knowing the signature of the validator functions, what kind of arguments do they accept, etc., so it is a good idea to check the <a href="https://github.com/DockYard/ember-changeset-validations/">docs</a> and get familiar with all these concepts.</p>
<p>Here’s the implementation that satisfies the tests:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/validators/user-signup.js</span>
<span class="im">import</span> <span class="op">{</span>
  validateLength<span class="op">,</span>
  validateConfirmation<span class="op">,</span>
  validateFormat
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-changeset-validations/validators&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="op">{</span>
  <span class="dt">email</span><span class="op">:</span> <span class="at">validateFormat</span>(<span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;email&#39;</span> <span class="op">}</span>)<span class="op">,</span>
  <span class="dt">password</span><span class="op">:</span> <span class="at">validateLength</span>(<span class="op">{</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">8</span> <span class="op">}</span>)<span class="op">,</span>
  <span class="dt">passwordConfirmation</span><span class="op">:</span> <span class="at">validateConfirmation</span>(<span class="op">{</span> <span class="dt">on</span><span class="op">:</span> <span class="st">&#39;password&#39;</span> <span class="op">}</span>)<span class="op">,</span>
<span class="op">};</span></code></pre></td></tr></table></div>
<p>Now let’s do the actual validation in the components and display the error messages if he changeset happens to be invalid:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/user-signup.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>
<span class="im">import</span> lookupValidator <span class="im">from</span> <span class="st">&#39;ember-changeset-validations&#39;</span><span class="op">;</span>
<span class="im">import</span> UserSignupValidators <span class="im">from</span> <span class="st">&#39;book-me/validators/user-signup&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">init</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>(...<span class="at">arguments</span>)<span class="op">;</span>

    <span class="kw">const</span> user <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;user&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> changeset <span class="op">=</span> <span class="kw">new</span> <span class="at">Changeset</span>(user<span class="op">,</span> <span class="at">lookupValidator</span>(UserSignupValidators)<span class="op">,</span>
      UserSignupValidators)<span class="op">;</span>

    <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span><span class="op">,</span> changeset)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">registerUser</span>() <span class="op">{</span>
      <span class="kw">const</span> changeset <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span>)<span class="op">;</span>

      <span class="va">changeset</span>.<span class="at">validate</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="cf">if</span> (<span class="at">get</span>(changeset<span class="op">,</span> <span class="st">&#39;isValid&#39;</span>)) <span class="op">{</span>
          <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;registerUser&#39;</span>)(changeset)<span class="op">;</span>
        <span class="op">}</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/user-signup.hbs --&gt;</span>
{{#if changeset.isInvalid}}
  <span class="kw">&lt;section</span><span class="ot"> data-test-signup-errors</span><span class="kw">&gt;</span>
    {{#each changeset.errors as |error|}}
      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;alert alert-danger&quot;</span><span class="ot"> role=</span><span class="st">&quot;alert&quot;</span><span class="kw">&gt;</span>
        {{error.validation}}
      <span class="kw">&lt;/div&gt;</span>
    {{/each}}
  <span class="kw">&lt;/section&gt;</span>
{{/if}}

<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&quot;registerUser&quot;</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-email&quot;</span><span class="kw">&gt;</span>Email address<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-email-field
      id=&quot;signup-email&quot;
      value=(mut changeset.email)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-password&quot;</span><span class="kw">&gt;</span>Password<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-password-field
      id=&quot;signup-password&quot;
      value=(mut changeset.password)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;signup-password&quot;</span><span class="kw">&gt;</span>Password Confirmation<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-signup-password-confirmation-field
      id=&quot;signup-passwordConfirmation&quot;
      value=(mut changeset.passwordConfirmation)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span>
<span class="ot">    data-test-signup-submit-btn</span><span class="kw">&gt;</span>Submit<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>To give you an idea how it should look like, here’s a screenshot:</p>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/book_me_02.png" alt="Form with errors" />
<p class="caption">Form with errors</p>
</div>
<p>We could expect that all tests will be green now, but it turns out we have one failure! The following scenario <code>'it invokes passed</code>registerUser<code>action when clicking on signup button'</code> in the <code>user-signup-test.js</code> fails because the form is invalid. To make it green, we need to fill the inputs with proper data:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/componenets/user-signup-test.js</span>
<span class="at">test</span>(<span class="st">&#39;it invokes passed `registerUser` action when clicking on</span>
  signup button<span class="st">&#39;, function(assert) {</span>
  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> user <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> registerUser <span class="op">=</span> (userArgument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="va">userArgument</span>.<span class="at">_content</span><span class="op">,</span> user<span class="op">,</span>
      <span class="st">&#39;action should be invoked with proper user argument&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;user&#39;</span><span class="op">,</span> user)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;registerUser&#39;</span><span class="op">,</span> registerUser)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{user-signup user=user registerUser=registerUser}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-email-field&#39;</span>)).<span class="at">val</span>(<span class="st">&#39;example@email.com&#39;</span>).<span class="at">change</span>()<span class="op">;</span>
  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-field&#39;</span>)).<span class="at">val</span>(<span class="st">&#39;password123&#39;</span>).<span class="at">change</span>()<span class="op">;</span>
  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-confirmation-field&#39;</span>)).<span class="at">val</span>(<span class="st">&#39;password123&#39;</span>).<span class="at">change</span>()<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-submit-btn&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>And that’s it! All tests are passing now!</p>
<p>It looks like we have now a working version of sign-up, but it’s far from the truth - we’ve only confirmed so far that our form and validations work. Implementing the proper sign-up will require dealing with tokens and sessions.</p>
<p>When dealing with the authentication process, <a href="https://github.com/simplabs/ember-simple-auth">ember-simple-auth</a> should cover most of our needs. And if not, it is easily extendible so we can either add our authentication strategy or tweak the existing ones.</p>
<p>Let’s install the addon:</p>
<pre><code>ember install ember-simple-auth</code></pre>
<p>Explaining the details how <code>ember-simple-auth</code> works and how different authentication flows differ from each other and which one is the most suitable choice is beyond the scope of this book, I highly recommend to read the <a href="https://github.com/simplabs/ember-simple-auth">docs</a> to learn more.</p>
<p>For the sake of simplicity, we will use <code>OAuth2PasswordGrantAuthenticator</code> which implements <code>Resource Owner Password Credentials Grant Type</code> without a refresh token and <code>OAuth2BearerAuthorizer</code> which uses Bearer tokens. The authenticators are the objects responsible for authenticating the session and authorizers use the data acquired by authenticators to handle authorization data that is required when performing the requests.</p>
<p>Let’s add the necessary layers to our application. The first thing will be adding authenticators under <code>authenticators</code> directory:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/authenticators/oauth2.js</span>
<span class="im">import</span> OAuth2PasswordGrant <span class="im">from</span> <span class="st">&#39;ember-simple-auth/authenticators/oauth2-password-grant&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">OAuth2PasswordGrant</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">serverTokenEndpoint</span><span class="op">:</span> <span class="st">&#39;/api/oauth/token&#39;</span><span class="op">,</span>
  <span class="dt">serverTokenRevocationEndpoint</span><span class="op">:</span> <span class="st">&#39;/api/oauth/destroy&#39;</span><span class="op">,</span>
  <span class="dt">refreshAccessTokens</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We are extending here <code>OAuth2PasswordGrant</code> from <code>ember-simple-auth</code> and we are doing some extra customization to specify the endpoint for acquiring tokens and revoking them. We also don’t care this time about refresh tokens, so we set <code>refreshAccessTokens</code> to <code>false</code>.</p>
<p>The next thing will be adding <code>authorizer</code> under <code>authorizers</code> directory:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/authorizers/oauth2.js</span>
<span class="im">import</span> OAuth2Bearer <span class="im">from</span> <span class="st">&#39;ember-simple-auth/authorizers/oauth2-bearer&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">OAuth2Bearer</span>.<span class="at">extend</span>()<span class="op">;</span></code></pre></td></tr></table></div>
<p>Now let’s extend our <code>ApplicationAdapter</code> with <code>DataAdapterMixin</code> which will be used for properly handling the authorization process:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/adapters/application.js</span>
<span class="im">import</span> DS <span class="im">from</span> <span class="st">&#39;ember-data&#39;</span><span class="op">;</span>
<span class="im">import</span> DataAdapterMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/data-adapter-mixin&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">DS</span>.<span class="va">JSONAPIAdapter</span>.<span class="at">extend</span>(DataAdapterMixin<span class="op">,</span> <span class="op">{</span>
  <span class="dt">namespace</span><span class="op">:</span> <span class="st">&#39;api&#39;</span><span class="op">,</span>
  <span class="dt">authorizer</span><span class="op">:</span> <span class="st">&#39;authorizer:oauth2&#39;</span><span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>At this point, we need to update the unit test for the <code>ApplicationAdapter</code> which will be failing now because of the <code>service:session</code> dependency. Let’s fix it now:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/adapters/application.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;adapter:application&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Adapter | application&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="co">// added the dependency</span>
  <span class="dt">needs</span><span class="op">:</span> [<span class="st">&#39;service:session&#39;</span>]
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Let’s focus now on simulating the backend part when it comes to tokens and authentication process in <code>ember-cli-mirage</code> config. We need two endpoints: one for handling the login and one for the logout processes. For logout it is pretty simple: we will assume that the response is always successful, so we will just return a response with <code>204</code> HTTP code and no body. For login it’s a bit more complex: we need somehow to implement the authentication process. The simplest way to do it (which would also be close to what happens on backend server) would be to find the user by provided email and compare the provided password with user’s password. In that case, we will return the data in the expected format. Otherwise, we will return 401 status to indicate that the request is not authenticated with some error message. Here’s how we can approach this problem:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/mirage/config.js</span>
<span class="im">import</span> Mirage <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Response<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Mirage<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">namespace</span> <span class="op">=</span> <span class="st">&#39;api&#39;</span><span class="op">;</span>

  <span class="kw">this</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">post</span>(<span class="st">&#39;/oauth/token&#39;</span><span class="op">,</span> (schema<span class="op">,</span> request) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> potentialPasswordMatch <span class="op">=</span> <span class="va">request</span>.<span class="va">requestBody</span>.<span class="at">match</span>(<span class="ss">/password=</span><span class="sc">([^&amp;]*)</span><span class="ss">/</span>)<span class="op">;</span>
    <span class="kw">const</span> potentialEmailMatch <span class="op">=</span> <span class="va">request</span>.<span class="va">requestBody</span>.<span class="at">match</span>(<span class="ss">/username=</span><span class="sc">([^&amp;]*)</span><span class="ss">/</span>)<span class="op">;</span>
    <span class="co">// example: [</span>
    <span class="co">//   &quot;password=password123&quot;,</span>
    <span class="co">//   &quot;password123&quot;,</span>
    <span class="co">//   index: 50,</span>
    <span class="co">//   input: &quot;grant_type=password&amp;username=example%40gmail.com&amp;password=password123&quot;</span>
    <span class="co">// ]</span>
    <span class="kw">const</span> password <span class="op">=</span> potentialPasswordMatch <span class="op">&amp;&amp;</span> potentialPasswordMatch[<span class="dv">1</span>]<span class="op">;</span>
    <span class="kw">const</span> email <span class="op">=</span> potentialEmailMatch <span class="op">&amp;&amp;</span> <span class="at">decodeURIComponent</span>(potentialEmailMatch[<span class="dv">1</span>])<span class="op">;</span>

    <span class="kw">const</span> user <span class="op">=</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">findBy</span>(<span class="op">{</span> email <span class="op">}</span>)<span class="op">;</span>

    <span class="cf">if</span> (<span class="op">!</span>user <span class="op">||</span> <span class="va">user</span>.<span class="at">password</span> <span class="op">!==</span> password) <span class="op">{</span>
      <span class="cf">return</span> <span class="kw">new</span> <span class="at">Response</span>(<span class="dv">401</span><span class="op">,</span> <span class="op">{},</span> <span class="op">{</span> <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;invalid credentials&#39;</span> <span class="op">}</span>)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
      <span class="cf">return</span> <span class="op">{</span>
        <span class="dt">access_token</span><span class="op">:</span> <span class="st">&#39;123456789&#39;</span><span class="op">,</span>
        <span class="dt">token_type</span><span class="op">:</span> <span class="st">&#39;bearer&#39;</span><span class="op">,</span>
        <span class="dt">user_id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span><span class="op">,</span>
      <span class="op">};</span>
    <span class="op">}</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">post</span>(<span class="st">&#39;/oauth/destroy&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Response</span>(<span class="dv">204</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>At this point we’ve already made a proper setup for authentication and authorization process, so we can add another scenario. What we want to achieve is to make sure that the <code>token</code> endpoint is indeed reached and that we transition to some authentication-protected route, let’s call it an <code>admin</code> route, after a successful signup.</p>
<p>As <code>ember-cli-mirage</code> uses <code>pretender</code> internally, we could take advantage of a great feature provided by <code>pretender</code> - recording of handled requests. Thanks to this feature, we can check all the requests that have been performed with the URLs of the endpoints, request bodies, etc. Let’s modify our <code>user can successfully sign up</code> scenario:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/sign-in-sign-up-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | sign in sign up&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">email</span> <span class="op">=</span> <span class="st">&#39;example@email.com&#39;</span><span class="op">;</span>
    <span class="kw">this</span>.<span class="at">password</span> <span class="op">=</span> <span class="st">&#39;password123&#39;</span><span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span>
<span class="at">test</span>(<span class="st">&#39;user can successfully sign up&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">3</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> <span class="kw">function</span>(schema)  <span class="op">{</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span>
      <span class="dt">email</span><span class="op">:</span> email<span class="op">,</span>
      <span class="dt">password</span><span class="op">:</span> password<span class="op">,</span>
    <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">visit</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span>

  <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-link&#39;</span>))<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-email-field&#39;</span>)<span class="op">,</span> email)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-field&#39;</span>)<span class="op">,</span> password)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-confirmation-field&#39;</span>)<span class="op">,</span> password)<span class="op">;</span>

    <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-submit-btn&#39;</span>))<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="co">// new scenario: make sure that the request to `tokens` endpoint is performed</span>
  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> tokenUrl <span class="op">=</span> <span class="st">&#39;/api/oauth/token&#39;</span><span class="op">;</span>
    <span class="kw">const</span> tokenRequest <span class="op">=</span> <span class="va">server</span>.<span class="va">pretender</span>.<span class="va">handledRequests</span>.<span class="at">find</span>((request) <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="cf">return</span> <span class="va">request</span>.<span class="at">url</span> <span class="op">===</span> tokenUrl<span class="op">;</span>
    <span class="op">}</span>)<span class="op">;</span>

    <span class="va">assert</span>.<span class="at">ok</span>(tokenRequest<span class="op">,</span> <span class="st">&#39;tokenRequest should be performed&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentURL</span>()<span class="op">,</span> <span class="st">&#39;/admin&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Let’s make our test suite happy again. We will start with some adjustments in <code>signup</code> route. The simplest way to solve our problem will be using <code>session</code> service from <code>ember-simple-auth</code> and authenticating the user after it gets created:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/signup.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
  get<span class="op">,</span>
  getProperties<span class="op">,</span>
  <span class="dt">inject</span><span class="op">:</span> <span class="op">{</span>
    service<span class="op">,</span>
  <span class="op">}</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">session</span><span class="op">:</span> <span class="at">service</span>()<span class="op">,</span>

  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">createRecord</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;user&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">registerUser</span>(user) <span class="op">{</span>
      <span class="va">user</span>.<span class="at">save</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="at">getProperties</span>(user<span class="op">,</span> <span class="st">&#39;email&#39;</span><span class="op">,</span> <span class="st">&#39;password&#39;</span>)<span class="op">;</span>

        <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;session&#39;</span>).<span class="at">authenticate</span>(<span class="st">&#39;authenticator:oauth2&#39;</span><span class="op">,</span> email<span class="op">,</span> password)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We also need to update the unit test for the route and inject <code>service:session</code> dependency:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/sign-up-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;route:signup&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route | signup&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">needs</span><span class="op">:</span> [<span class="st">&#39;service:session&#39;</span>]
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We are almost there; now we are only missing the implementation for the final step: the transition to <code>admin</code> route. To handle this step, we can just transition to that route after the successful authentication:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/signup.js</span>
<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>

  <span class="co">// the rest of the logic</span>
  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">registerUser</span>(user) <span class="op">{</span>
      <span class="va">user</span>.<span class="at">save</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="at">getProperties</span>(user<span class="op">,</span> <span class="st">&#39;email&#39;</span><span class="op">,</span> <span class="st">&#39;password&#39;</span>)<span class="op">;</span>

        <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;session&#39;</span>).<span class="at">authenticate</span>(<span class="st">&#39;authenticator:oauth2&#39;</span><span class="op">,</span> email<span class="op">,</span>
          password).<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We also need to set up the routing and the template for the new route:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/router.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> config <span class="im">from</span> <span class="st">&#39;./config/environment&#39;</span><span class="op">;</span>

<span class="kw">const</span> Router <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Router</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">location</span><span class="op">:</span> <span class="va">config</span>.<span class="at">locationType</span><span class="op">,</span>
  <span class="dt">rootURL</span><span class="op">:</span> <span class="va">config</span>.<span class="at">rootURL</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="va">Router</span>.<span class="at">map</span>(<span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;signup&#39;</span>)<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span> <span class="co">// new route</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> Router<span class="op">;</span></code></pre></td></tr></table></div>
<p>Here is a new route:</p>
<pre><code>import Ember from &#39;ember&#39;;

export default Ember.Route.extend();</code></pre>
<p>Let’s skip the authentication-protection for this route to not add too much code at once, especially if this part is not covered with any tests.</p>
<p>And the final step, the template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/admin.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Admin<span class="kw">&lt;/h2&gt;</span></code></pre></td></tr></table></div>
<p>And all the tests are passing again! However, there is one scenario we are missing: what if the error comes not from the client-side validation, but from the server? So far we’ve only covered the error case when the validation fails in Ember app. Let’s add another test for the scenario we’ve just discovered:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// tests/acceptance/sign-in-sign-up-test.js</span>
<span class="at">test</span>(<span class="st">&#39;user cannot signup if there is an error on server&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> errors <span class="op">=</span> <span class="op">{</span>
      <span class="dt">errors</span><span class="op">:</span> [
        <span class="op">{</span>
          <span class="dt">detail</span><span class="op">:</span> <span class="st">&#39;is already taken&#39;</span><span class="op">,</span>
          <span class="dt">source</span><span class="op">:</span> <span class="op">{</span>
            <span class="dt">pointer</span><span class="op">:</span> <span class="st">&#39;data/attributes/email&#39;</span>
          <span class="op">}</span>
        <span class="op">}</span>
      ]
    <span class="op">};</span>
    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Response</span>(<span class="dv">422</span><span class="op">,</span> <span class="op">{},</span> errors)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">visit</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span>

  <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-link&#39;</span>))<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-email-field&#39;</span>)<span class="op">,</span> email)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-field&#39;</span>)<span class="op">,</span> password)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-confirmation-field&#39;</span>)<span class="op">,</span> password)<span class="op">;</span>

    <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-submit-btn&#39;</span>))<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>To make the new test pass, we just need to handle the error scenario in <code>registerUser</code> action in <code>signup</code> route:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/signup.js</span>
  actions<span class="op">:</span> <span class="op">{</span>
    <span class="at">registerUser</span>(user) <span class="op">{</span>
      <span class="va">user</span>.<span class="at">save</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="at">getProperties</span>(user<span class="op">,</span> <span class="st">&#39;email&#39;</span><span class="op">,</span> <span class="st">&#39;password&#39;</span>)<span class="op">;</span>

        <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;session&#39;</span>).<span class="at">authenticate</span>(<span class="st">&#39;authenticator:oauth2&#39;</span><span class="op">,</span> email<span class="op">,</span>
          password).<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>
          <span class="op">}</span>).<span class="at">catch</span>(() <span class="op">=&gt;</span> <span class="op">{</span> <span class="co">// handle error scenario</span>
              <span class="at">get</span>(<span class="va">user</span>.<span class="at">_content</span><span class="op">,</span> <span class="st">&#39;errors&#39;</span>).<span class="at">forEach</span>((<span class="op">{</span> attribute<span class="op">,</span> message <span class="op">}</span>) <span class="op">=&gt;</span> <span class="op">{</span>
                  <span class="va">user</span>.<span class="at">pushErrors</span>(attribute<span class="op">,</span> message)<span class="op">;</span>
              <span class="op">}</span>)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span></code></pre></td></tr></table></div>
<p>As this is a scenario for handling server-side errors, our <code>user</code> changeset won’t be automatically populated with model errors; we need to do it manually. Fortunately, populating the errors is handled by Ember Data and we can just loop over all the errors and add them to the changeset using <code>pushErrors</code> method.</p>
<p>Now, we can proceed to the next feature: making <code>admin</code> route protected by the authentication. Again, let’s start with the test, the acceptance one:</p>
<pre><code>ember g acceptance-test access-admin</code></pre>
<p>And here’s our test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/access-admin-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> authenticateSession<span class="op">,</span> <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/ember-simple-auth&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | access admin&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it is not possible to visit `admin` without authentication&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="at">visit</span>(<span class="st">&#39;/admin&#39;</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;login&#39;</span><span class="op">,</span>
      <span class="st">&#39;should not be an admin route for not authenticated users&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it is possible to visit `admin` when user is authenticated&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> user <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span>
  <span class="at">authenticateSession</span>(<span class="kw">this</span>.<span class="at">application</span><span class="op">,</span> <span class="op">{</span> <span class="dt">user_id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">}</span>)<span class="op">;</span>

  <span class="at">visit</span>(<span class="st">&#39;/admin&#39;</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span> <span class="st">&#39;should be an admin route&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We are taking advantage of <code>authenticateSession</code> provided by <code>ember-simple-auth</code> which greatly simplifies authentication process for tests’ setup. We want to verify two scenarios: one is that without authentication we can’t access the <code>admin</code> route and the other one is that after being authenticated we can access that route.</p>
<p>To make the <code>admin</code> route, protected we need to include <code>AuthenticatedRouteMixin</code> from <code>ember-simple-auth</code>:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/admin.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>By default <code>ember-simple-auth</code> performs a transition to <code>login</code> route if the user is not authenticated, so it would be a good idea to add this route in the first place:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/router.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> config <span class="im">from</span> <span class="st">&#39;./config/environment&#39;</span><span class="op">;</span>

<span class="kw">const</span> Router <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Router</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">location</span><span class="op">:</span> <span class="va">config</span>.<span class="at">locationType</span><span class="op">,</span>
  <span class="dt">rootURL</span><span class="op">:</span> <span class="va">config</span>.<span class="at">rootURL</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="va">Router</span>.<span class="at">map</span>(<span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;signup&#39;</span>)<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;login&#39;</span>)<span class="op">;</span> <span class="co">// new route</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> Router<span class="op">;</span></code></pre></td></tr></table></div>
<p>And now we are back to green! All tests are passing.</p>
<p>If we already added the <code>login</code> route, it would be a good idea to implement the login process itself.</p>
<p>Again, let’s start with the acceptance test:</p>
<pre><code>ember g acceptance-test user-login</code></pre>
<p>We want to cover here three scenarios: First, that after providing the valid email and password combo the user will be logged in and redirected to <code>admin</code> route. The other two would be failures for both client and server side issues. Here are the tests covering these scenarios:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/user-login-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | user login&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">const</span> email <span class="op">=</span> <span class="st">&#39;example@email.com&#39;</span><span class="op">;</span>
    <span class="kw">const</span> password <span class="op">=</span> <span class="st">&#39;password123&#39;</span><span class="op">;</span>

    <span class="kw">this</span>.<span class="at">email</span> <span class="op">=</span> email<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">password</span> <span class="op">=</span> password<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">user</span> <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="op">{</span> email<span class="op">,</span> password<span class="op">,</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user can successfully log in and is redirected to /admin route&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="at">visit</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span>

  <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-link&#39;</span>))<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-email-field&#39;</span>)<span class="op">,</span> email)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-password-field&#39;</span>)<span class="op">,</span> password)<span class="op">;</span>

    <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-submit-btn&#39;</span>))<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span> <span class="st">&#39;should be an admin route&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user cannot log in with invalid credentials and sees the error messages from</span>
  client<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="at">visit</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span>

  <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-link&#39;</span>))<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-email-field&#39;</span>)<span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-password-field&#39;</span>)<span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span>

    <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-submit-btn&#39;</span>))<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;login&#39;</span><span class="op">,</span> <span class="st">&#39;should still be a login route&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user cannot log in with invalid credentials and sees the error messages</span>
  <span class="im">from</span> server<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="at">visit</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span>

  <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-link&#39;</span>))<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-email-field&#39;</span>)<span class="op">,</span> <span class="kw">this</span>.<span class="at">email</span>)<span class="op">;</span>
    <span class="at">fillIn</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-password-field&#39;</span>)<span class="op">,</span> <span class="st">&#39;invalidPassword&#39;</span>)<span class="op">;</span>

    <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-submit-btn&#39;</span>))<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;login&#39;</span><span class="op">,</span> <span class="st">&#39;should still be a login route&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>Let’s make these tests green now. We need to start with generating a <code>login</code> route:</p>
<pre><code>ember g route login</code></pre>
<p>Let’s do something similar as we did for signup and generate <code>user-login</code> component. It may sound a bit like a Big Design Upfront. However, we already did something very similar for the signup process and we can easily predict that having a separate component will be useful in this use case as well. Let’s generate it then:</p>
<pre><code>ember g component user-login</code></pre>
<p>Before adding anything new to the <code>login</code> or <code>user-login</code> templates, let’s add the actual link to the login page in the layout template (<code>application.hbs</code>):</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/application.hbs --&gt;</span>
<span class="kw">&lt;nav</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-default navbar-fixed-top&quot;</span><span class="ot"> role=</span><span class="st">&quot;navigation&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container-fluid&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-header&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;button&quot;</span><span class="ot"> class=</span><span class="st">&quot;navbar-toggle navbar-toggle-context&quot;</span>
<span class="ot">              data-toggle=</span><span class="st">&quot;collapse&quot;</span><span class="ot"> data-target=</span><span class="st">&quot;.navbar-top-collapse&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;sr-only&quot;</span><span class="kw">&gt;</span>Toggle Navigation<span class="kw">&lt;/span&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;icon-bar&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;icon-bar&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;icon-bar&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
      <span class="kw">&lt;/button&gt;</span>
      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-brand-container&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;navbar-brand&quot;</span><span class="kw">&gt;</span>
          <span class="kw">&lt;h1&gt;&lt;i</span><span class="ot"> class=</span><span class="st">&quot;fa fa-star&quot;</span><span class="kw">&gt;&lt;/i&gt;</span> Book Me!<span class="kw">&lt;/h1&gt;</span>
        <span class="kw">&lt;/span&gt;</span>
      <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;collapse navbar-collapse navbar-top-collapse&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-right&quot;</span><span class="kw">&gt;</span>
        {{link-to &quot;Sign up&quot; &quot;signup&quot; data-test-signup-link
          class=&quot;btn btn-primary navbar-btn&quot;}}
        {{link-to &quot;Login&quot; &quot;login&quot; data-test-login-link
          class=&quot;btn btn-primary navbar-btn&quot;}}
      <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;/div&gt;</span>
<span class="kw">&lt;/nav&gt;</span>
<span class="kw">&lt;section</span><span class="ot"> class=</span><span class="st">&quot;main-content&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;sheet&quot;</span><span class="kw">&gt;</span>
    {{outlet}}
  <span class="kw">&lt;/div&gt;</span>
<span class="kw">&lt;/section&gt;</span></code></pre></td></tr></table></div>
<p>And let’s render the component in <code>login</code> template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/login.js --&gt;</span>
{{user-login}}</code></pre></td></tr></table></div>
<p>Just like for the <strong>signup</strong> use case, we want the <strong>login</strong> component to encapsulate data aggregation for the process, handle validation and if the data is valid, call some action that would handle the actual login. That action should probably come from the route. But for now, let’s focus exclusively on the component. Just like before, we are going to start with the tests.</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// app/tests/integration/components/user-login-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;user-login&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component | user login&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">integration</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it invokes passed `loginUser` action when clicking on login button&#39;</span><span class="op">,</span>
  <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> loginModel <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> loginUser <span class="op">=</span> (loginArgument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="va">loginArgument</span>.<span class="at">_content</span><span class="op">,</span>
      loginModel<span class="op">,</span> <span class="st">&#39;action should be invoked with proper user argument&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;loginUser&#39;</span><span class="op">,</span> loginUser)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{user-login loginUser=loginUser}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-email-field&#39;</span>)).<span class="at">val</span>(<span class="st">&#39;example@email.com&#39;</span>).<span class="at">change</span>()<span class="op">;</span>
  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-password-field&#39;</span>)).<span class="at">val</span>(<span class="st">&#39;password&#39;</span>).<span class="at">change</span>()<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-submit-btn&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it does not invoke passed `loginUser` action when there is a</span>
  validation error and displays the error messages<span class="st">&#39;, function(assert) {</span>
  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> loginUser <span class="op">=</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;action should not be called&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;loginUser&#39;</span><span class="op">,</span> loginUser)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{user-login loginUser=loginUser}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-submit-btn&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-errors&#39;</span>).<span class="at">length</span>)<span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>These tests are quite similar to the ones for the <strong>signup</strong> - we want to test both success and failure scenarios. For the success one, we want to make sure that the action passed to the component is called with the proper arguments and for the failure case, we want to ensure that the action is not called and the error messages from validation are displayed.</p>
<p>Time to make these tests happy. Here is the simple component to make the success scenario pass:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/user-login.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">init</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>(...<span class="at">arguments</span>)<span class="op">;</span>

    <span class="kw">const</span> loginModel <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
    <span class="kw">const</span> changeset <span class="op">=</span> <span class="kw">new</span> <span class="at">Changeset</span>(loginModel)<span class="op">;</span>

    <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span><span class="op">,</span> changeset)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">loginUser</span>() <span class="op">{</span>
      <span class="kw">const</span> changeset <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span>)<span class="op">;</span>

      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;loginUser&#39;</span>)(changeset)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And here’s the template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/user-login.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Log in<span class="kw">&lt;/h2&gt;</span>

<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&quot;loginUser&quot;</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;login-email&quot;</span><span class="kw">&gt;</span>Email address<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-login-email-field
      id=&quot;login-email&quot;
      value=(mut changeset.email)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;login-password&quot;</span><span class="kw">&gt;</span>Password<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-login-password-field
      id=&quot;login-password&quot;
      value=(mut changeset.password)
      class=&quot;form-control&quot;
      type=&quot;password&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span>
<span class="ot">    data-test-login-submit-btn</span><span class="kw">&gt;</span>Log in<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>Not many surprises here: we just set up the proper <code>changeset</code> and provide input fields for <code>email</code> and <code>password</code> and obviously the submit button. We are using a virtual <code>loginModel</code> - we don’t want to use any Ember Data model here as it doesn’t make much sense - we just need some something that can merely aggregate the data, so we are simply creating an Ember Object to be used as such attributes’ aggregate.</p>
<p>With this code, we managed to get the integration tests pass. Let’s deal with the validation messages now. First, we are going to decide on the actual validations we need and write tests for them.</p>
<p>We don’t need to make it overly complicated, so let’s just validate the format of the <code>email</code> address and make sure that the password has at least eight characters, which is also the requirement for signup process.</p>
<p>Here are the tests:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/validators/user-login-test.js</span>
<span class="im">import</span> <span class="op">{</span> module<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> validateUserLogin <span class="im">from</span> <span class="st">&#39;book-me/validators/user-login&#39;</span><span class="op">;</span>

<span class="at">module</span>(<span class="st">&#39;Unit | Validator | user-login&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates email format&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validateUserLogin</span>.<span class="at">email</span>(<span class="st">&#39;email&#39;</span><span class="op">,</span> <span class="st">&#39;invalid&#39;</span>)<span class="op">,</span>
    <span class="st">&#39;Email must be a valid email address&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validateUserLogin</span>.<span class="at">email</span>(<span class="st">&#39;email&#39;</span><span class="op">,</span> <span class="st">&#39;example@gmail.com&#39;</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates password length&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validateUserLogin</span>.<span class="at">password</span>(<span class="st">&#39;password&#39;</span><span class="op">,</span> <span class="st">&#39;invalid&#39;</span>)<span class="op">,</span>
    <span class="st">&#39;Password is too short (minimum is 8 characters)&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validateUserLogin</span>.<span class="at">password</span>(<span class="st">&#39;password&#39;</span><span class="op">,</span> <span class="st">&#39;password123&#39;</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And the implementation that will make these tests pass:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/validators/user-login.js</span>
<span class="im">import</span> <span class="op">{</span>
  validateLength<span class="op">,</span>
  validateFormat
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-changeset-validations/validators&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="op">{</span>
  <span class="dt">email</span><span class="op">:</span> <span class="at">validateFormat</span>(<span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;email&#39;</span> <span class="op">}</span>)<span class="op">,</span>
  <span class="dt">password</span><span class="op">:</span> <span class="at">validateLength</span>(<span class="op">{</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">8</span> <span class="op">}</span>)<span class="op">,</span>
<span class="op">};</span></code></pre></td></tr></table></div>
<p>Let’s get back to the login component. It’s almost the same as the signup component, so we may handle it with the same flow:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/user-login.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>
<span class="im">import</span> lookupValidator <span class="im">from</span> <span class="st">&#39;ember-changeset-validations&#39;</span><span class="op">;</span>
<span class="im">import</span> UserLoginValidators <span class="im">from</span> <span class="st">&#39;book-me/validators/user-login&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">init</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>(...<span class="at">arguments</span>)<span class="op">;</span>

    <span class="kw">const</span> loginModel <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
    <span class="kw">const</span> changeset <span class="op">=</span> <span class="kw">new</span> <span class="at">Changeset</span>(loginModel<span class="op">,</span> <span class="at">lookupValidator</span>(UserLoginValidators)<span class="op">,</span>
      UserLoginValidators)<span class="op">;</span>

    <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span><span class="op">,</span> changeset)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">loginUser</span>() <span class="op">{</span>
      <span class="kw">const</span> changeset <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span>)<span class="op">;</span>

      <span class="va">changeset</span>.<span class="at">validate</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="cf">if</span> (<span class="at">get</span>(changeset<span class="op">,</span> <span class="st">&#39;isValid&#39;</span>)) <span class="op">{</span>
          <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;loginUser&#39;</span>)(changeset)<span class="op">;</span>
        <span class="op">}</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And, as the last step, let’s display the error messages if the changeset is invalid:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/user-login.js --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Log in<span class="kw">&lt;/h2&gt;</span>

{{#if changeset.isInvalid}}
  <span class="kw">&lt;section</span><span class="ot"> data-test-login-errors</span><span class="kw">&gt;</span>
    {{#each changeset.errors as |error|}}
      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;alert alert-danger&quot;</span><span class="ot"> role=</span><span class="st">&quot;alert&quot;</span><span class="kw">&gt;</span>
        {{error.validation}}
      <span class="kw">&lt;/div&gt;</span>
    {{/each}}
  <span class="kw">&lt;/section&gt;</span>
{{/if}}

<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&quot;loginUser&quot;</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;login-email&quot;</span><span class="kw">&gt;</span>Email address<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-login-email-field
      id=&quot;login-email&quot;
      value=(mut changeset.email)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;login-password&quot;</span><span class="kw">&gt;</span>Password<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-login-password-field
      id=&quot;login-password&quot;
      value=(mut changeset.password)
      class=&quot;form-control&quot;
      type=&quot;password&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span>
<span class="ot">    data-test-login-submit-btn</span><span class="kw">&gt;</span>Log in<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>We’ve managed to make all the integration tests pass; however, we still have the acceptance ones failing. Apparently, we haven’t defined <code>loginUser</code> function yet that will be responsible for the actual logging in, so let’s add it now. Just like for the signup process, we need a route action:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/login.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  getProperties<span class="op">,</span>
  <span class="dt">inject</span><span class="op">:</span> <span class="op">{</span>
    service<span class="op">,</span>
  <span class="op">}</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">session</span><span class="op">:</span> <span class="at">service</span>()<span class="op">,</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">loginUser</span>(loginModel) <span class="op">{</span>
      <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="at">getProperties</span>(loginModel<span class="op">,</span> <span class="st">&#39;email&#39;</span><span class="op">,</span> <span class="st">&#39;password&#39;</span>)<span class="op">;</span>

      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;session&#39;</span>).<span class="at">authenticate</span>(<span class="st">&#39;authenticator:oauth2&#39;</span><span class="op">,</span> email<span class="op">,</span>
        password).<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
          <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>
        <span class="op">}</span>).<span class="at">catch</span>((error) <span class="op">=&gt;</span> <span class="op">{</span>
          <span class="va">loginModel</span>.<span class="at">addError</span>(<span class="st">&#39;login&#39;</span><span class="op">,</span> <span class="va">error</span>.<span class="at">message</span>)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Now we just need a final adjustment in login route unit test as we injected the <code>session</code> service:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/login-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;route:login&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route | login&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">needs</span><span class="op">:</span> [<span class="st">&#39;service:session&#39;</span>]
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it exists&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">let</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(route)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>All there tests are passing now! It seems like we’ve just finished our first feature.</p>
<p>However, there are some duplications here and there. Some of the tests have quite a similar setup, especially the ones for the signup - they require filling some input and submitting the form. That’s a perfect use case to DRY up with page objects! Let’s install <code>ember-cli-page-object</code> addon:</p>
<pre><code>ember install ember-cli-page-object</code></pre>
<p>and generate a page object for the signup process:</p>
<pre><code>ember generate page-object signup</code></pre>
<p>Interacting with the signup page consists of visiting the page, filling the fields with the proper values and submitting the form. For such use case, this is how our page object may look like:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/pages/signup.js</span>
<span class="im">import</span> <span class="op">{</span>
  create<span class="op">,</span>
  visitable<span class="op">,</span>
  clickable<span class="op">,</span>
  fillable<span class="op">,</span>
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-page-object&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="at">create</span>(<span class="op">{</span>
  <span class="dt">visit</span><span class="op">:</span> <span class="at">visitable</span>(<span class="st">&#39;/&#39;</span>)<span class="op">,</span>
  <span class="dt">goToSignup</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-link&#39;</span>))<span class="op">,</span>
  <span class="dt">email</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-email-field&#39;</span>))<span class="op">,</span>
  <span class="dt">password</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-field&#39;</span>))<span class="op">,</span>
  <span class="dt">passwordConfirmation</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-password-confirmation-field&#39;</span>))<span class="op">,</span>
  <span class="dt">submit</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-submit-btn&#39;</span>))<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And here are the acceptance <code>sign in sign up</code> tests after the refactoring to page objects:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/sign-in-sign-up-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> Mirage <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>
<span class="im">import</span> signupPage <span class="im">from</span> <span class="st">&#39;book-me/tests/pages/signup&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Response<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Mirage<span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | sign in sign up&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">email</span> <span class="op">=</span> <span class="st">&#39;example@email.com&#39;</span><span class="op">;</span>
    <span class="kw">this</span>.<span class="at">password</span> <span class="op">=</span> <span class="st">&#39;password123&#39;</span><span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span>
<span class="at">test</span>(<span class="st">&#39;user can successfully sign up&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">3</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> <span class="kw">function</span>(schema)  <span class="op">{</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span>
      <span class="dt">email</span><span class="op">:</span> email<span class="op">,</span>
      <span class="dt">password</span><span class="op">:</span> password<span class="op">,</span>
    <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">schema</span>.<span class="va">users</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    signupPage
      .<span class="at">visit</span>()
      .<span class="at">goToSignup</span>()
      .<span class="at">email</span>(email)
      .<span class="at">password</span>(password)
      .<span class="at">passwordConfirmation</span>(password)
      .<span class="at">submit</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> tokenUrl <span class="op">=</span> <span class="st">&#39;/api/oauth/token&#39;</span><span class="op">;</span>
    <span class="kw">const</span> tokenRequest <span class="op">=</span> <span class="va">server</span>.<span class="va">pretender</span>.<span class="va">handledRequests</span>.<span class="at">find</span>((request) <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="cf">return</span> <span class="va">request</span>.<span class="at">url</span> <span class="op">===</span> tokenUrl<span class="op">;</span>
    <span class="op">}</span>)<span class="op">;</span>

    <span class="va">assert</span>.<span class="at">ok</span>(tokenRequest<span class="op">,</span> <span class="st">&#39;tokenRequest should be performed&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentURL</span>()<span class="op">,</span> <span class="st">&#39;/admin&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user cannot signup if there is an error&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;request should not be performed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    signupPage
      .<span class="at">visit</span>()
      .<span class="at">goToSignup</span>()
      .<span class="at">email</span>(email)
      .<span class="at">password</span>(password)
      .<span class="at">submit</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user cannot signup if there is an error on server when fetching a token&#39;</span><span class="op">,</span>
  <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/oauth/token&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Response</span>(<span class="dv">401</span><span class="op">,</span> <span class="op">{},</span> <span class="op">{</span> <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;invalid credentials&#39;</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    signupPage
      .<span class="at">visit</span>()
      .<span class="at">goToSignup</span>()
      .<span class="at">email</span>(email)
      .<span class="at">password</span>(password)
      .<span class="at">passwordConfirmation</span>(password)
      .<span class="at">submit</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user cannot signup if there is an error on server when creating a user&#39;</span><span class="op">,</span>
  <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> errors <span class="op">=</span> <span class="op">{</span>
      <span class="dt">errors</span><span class="op">:</span> [
        <span class="op">{</span>
          <span class="dt">detail</span><span class="op">:</span> <span class="st">&#39;is already taken&#39;</span><span class="op">,</span>
          <span class="dt">source</span><span class="op">:</span> <span class="op">{</span>
            <span class="dt">pointer</span><span class="op">:</span> <span class="st">&#39;data/attributes/email&#39;</span>
          <span class="op">}</span>
        <span class="op">}</span>
      ]
    <span class="op">};</span>
    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Response</span>(<span class="dv">422</span><span class="op">,</span> <span class="op">{},</span> errors)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    signupPage
      .<span class="at">visit</span>()
      .<span class="at">goToSignup</span>()
      .<span class="at">email</span>(email)
      .<span class="at">password</span>(password)
      .<span class="at">passwordConfirmation</span>(password)
      .<span class="at">submit</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Looks much better! The code is more readable, more reusable and the implementation details are hidden behind expressive methods. Let’s do the same thing for the tests for <code>user login</code> scenario:</p>
<pre><code>ember generate page-object login</code></pre>
<p>Here are the steps for interacting with <code>login</code> page:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/pages/login.js</span>
<span class="im">import</span> <span class="op">{</span>
  create<span class="op">,</span>
  visitable<span class="op">,</span>
  clickable<span class="op">,</span>
  fillable<span class="op">,</span>
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-page-object&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="at">create</span>(<span class="op">{</span>
  <span class="dt">visit</span><span class="op">:</span> <span class="at">visitable</span>(<span class="st">&#39;/&#39;</span>)<span class="op">,</span>
  <span class="dt">goTologin</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-link&#39;</span>))<span class="op">,</span>
  <span class="dt">email</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-email-field&#39;</span>))<span class="op">,</span>
  <span class="dt">password</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-password-field&#39;</span>))<span class="op">,</span>
  <span class="dt">submit</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-submit-btn&#39;</span>))<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And the tests after the refactoring:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/user-login-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> loginPage <span class="im">from</span> <span class="st">&#39;book-me/tests/pages/login&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | user login&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">const</span> email <span class="op">=</span> <span class="st">&#39;example@email.com&#39;</span><span class="op">;</span>
    <span class="kw">const</span> password <span class="op">=</span> <span class="st">&#39;password123&#39;</span><span class="op">;</span>

    <span class="kw">this</span>.<span class="at">email</span> <span class="op">=</span> email<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">password</span> <span class="op">=</span> password<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">user</span> <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="op">{</span> email<span class="op">,</span> password<span class="op">,</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user can successfully log in and is redirected to /admin route&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    loginPage
      .<span class="at">visit</span>()
      .<span class="at">goTologin</span>()
      .<span class="at">email</span>(email)
      .<span class="at">password</span>(password)
      .<span class="at">submit</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span> <span class="st">&#39;should be an admin route&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user cannot log in with invalid credentials and sees the error messages</span>
  <span class="im">from</span> client<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    loginPage
      .<span class="at">visit</span>()
      .<span class="at">goTologin</span>()
      .<span class="at">email</span>(<span class="st">&#39;&#39;</span>)
      .<span class="at">password</span>(<span class="st">&#39;&#39;</span>)
      .<span class="at">submit</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;login&#39;</span><span class="op">,</span> <span class="st">&#39;should still be a login route&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;user cannot log in with invalid credentials and sees the error messages</span>
  <span class="im">from</span> server<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    loginPage
      .<span class="at">visit</span>()
      .<span class="at">goTologin</span>()
      .<span class="at">email</span>(<span class="kw">this</span>.<span class="at">email</span>)
      .<span class="at">password</span>(<span class="st">&#39;invalidPassword&#39;</span>)
      .<span class="at">submit</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;login&#39;</span><span class="op">,</span> <span class="st">&#39;should still be a login route&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;errors should be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>Again, much cleaner!</p>
<p>To put the cherry on top, let’s make some improvements when it comes to sign in / sign up process - we can do both of these things, but so far we are not able to log out! The other problem is that <code>Sign up</code> and <code>Login</code> buttons are displayed even when a user is authenticated. We need to change that. Obviously, we will start with a spec - for that purpose, we will extend <code>User Login</code> and <code>user can successfully log in and is redirected to /admin route</code> scenarios a bit:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/user-login-test.js</span>
<span class="at">test</span>(<span class="st">&#39;user can successfully log in and is redirected to /admin route and is</span>
  able to logout afterward<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">4</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    loginPage
      .<span class="at">visit</span>()
      .<span class="at">goTologin</span>()
      .<span class="at">email</span>(email)
      .<span class="at">password</span>(password)
      .<span class="at">submit</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span> <span class="st">&#39;should be an admin route&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;signup-link&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;signup button should not be displayed&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;login-link&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;login button should not be displayed&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">click</span>(<span class="at">testSelector</span>(<span class="st">&#39;logout-link&#39;</span>))<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="st">&#39;should be an application route&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>To make the new scenario pass, we just need to add an action for handling logging out and make the proper adjustments in the templates. We can easily reuse the example that is documented in <code>ember-simple-auth</code> docs. Let’s start with the injection of <code>session</code> service to <code>application</code> route and defining <code>logOut</code> action:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/application.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  <span class="dt">inject</span><span class="op">:</span> <span class="op">{</span> service <span class="op">},</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">session</span><span class="op">:</span> <span class="at">service</span>()<span class="op">,</span>

  <span class="at">setupController</span>(controller) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;session&#39;</span><span class="op">,</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;session&#39;</span>))<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">logOut</span>() <span class="op">{</span>
      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;session&#39;</span>).<span class="at">invalidate</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;application&#39;</span>)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And update <code>application</code> template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/application.hbs --&gt;</span>
<span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;collapse navbar-collapse navbar-top-collapse&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-right&quot;</span><span class="kw">&gt;</span>
    {{#if session.isAuthenticated}}
      <span class="kw">&lt;a</span> <span class="er">{{action</span> <span class="er">(route-action</span> <span class="er">&#39;logOut&#39;)}}</span>
<span class="ot">        data-test-logout-link class=</span><span class="st">&quot;btn btn-primary navbar-btn&quot;</span><span class="kw">&gt;</span>Logout<span class="kw">&lt;/a&gt;</span>
    {{else}}
      {{link-to &quot;Sign up&quot; &quot;signup&quot; data-test-signup-link
        class=&quot;btn btn-primary navbar-btn&quot;}}
      {{link-to &quot;Login&quot; &quot;login&quot; data-test-login-link
        class=&quot;btn btn-primary navbar-btn&quot;}}
    {{/if}}
  <span class="kw">&lt;/div&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre></td></tr></table></div>
<p>That would mean we’ve managed to finish our first feature - sign in/sign up process following the entire TDD cycle - red/green/ refactor.</p>
<p>Now we can start implementing the core domain of our application - rentals management and a calendar for creating bookings.</p>
<p></p>
<h2 id="adding-the-core-feature---rentals-crud-and-the-calendar">Adding The Core Feature - Rentals’ CRUD And The Calendar</h2>
<p>Now we are getting to the most exciting part of the application. Let’s break it down into some basic points to fully understand what we want to achieve here:</p>
<ul>
<li><p>Rentals (properties) can be booked for a particular period (bookings). To keep it realistic, let’s assume that the minimum stay is one night.</p></li>
<li><p>Rentals must have some <strong>daily rate</strong> defined so that it is possible to calculate the price for the booking for a given period.</p></li>
<li><p>Obviously, bookings for a given rental cannot overlap with each other.</p></li>
<li><p>Bookings must be associated with some client. To keep it simple, we won’t introduce any new model, like <code>Client</code>, we will just have <code>clientEmail</code> attribute instead of a client relationship, which should be just enough in our case.</p></li>
<li><p>Also, bookings must have <strong>price</strong> attribute stored on themselves - we can’t safely rely on rental’s <strong>daily rate</strong> as it might change and obviously, the price of already existing booking should stay the same.</p></li>
</ul>
<p>So what we want to do here is to implement full CRUD for rentals and CRUD for bookings with a bit more complex way of creating bookings - we could just add two date fields backed by datepickers, but that would not be the best UX. A proper calendar sounds like a much better choice.</p>
<p>However, building a calendar sounds like an awful amount of work. How are we going to handle it?</p>
<p>Fortunately, there is already an addon for that! <a href="http://www.ember-power-calendar.com">ember-power-calendar</a> is robust and flexible and easily saves us hours of work!</p>
<p>That’s one of the most amazing things about developing applications in Ember - not only is it an awesome framework that makes you very productive, but also the community has already created so many addons that solve quite complex problems in a generic way.</p>
<p>However, before adding a calendar, we need to implement a full CRUD for rentals.</p>
<h3 id="rentals-crud">Rentals’ CRUD</h3>
<p>Fortunately, with Ember, it is a pretty straight-forward task. Just like before, let’s start with an acceptance test:</p>
<pre><code>ember g acceptance-test rentals-crud</code></pre>
<p>The first thing we will test will be “C” and “R” parts of CRUD which is creating and reading accordingly. What we initially expect to see here is empty admin page when there are no rentals created yet. The next step will be visiting some <code>create</code> page, filling forms, creating a rental and making sure the new rental that has just been created is displayed there. A good thing to do would also be to ensure the POST request is performed to <code>/rentals</code> endpoint - otherwise, we may get a false-positive and see the in-memory rental on the admin page, not the one that has been created and persisted on the server.</p>
<p>Before writing test let’s take advantage of the awesome <code>resource</code> helper from <code>ember-cli-mirage</code> which defines all routes for CRUD actions:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/mirage/config.js</span>
<span class="im">export</span> <span class="im">default</span> <span class="kw">function</span>() <span class="op">{</span>
    <span class="co">// existing code</span>

    <span class="kw">this</span>.<span class="at">resource</span>(<span class="st">&#39;rentals&#39;</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></td></tr></table></div>
<p>And here’s out initial test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/rentals-crud-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> authenticateSession<span class="op">,</span> <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/ember-simple-auth&#39;</span><span class="op">;</span>
<span class="im">import</span> PageObject<span class="op">,</span> <span class="op">{</span>
  clickable<span class="op">,</span>
  fillable<span class="op">,</span>
  visitable
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;book-me/tests/page-object&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | rentals crud&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it is possible to read, create, edit and delete rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">3</span>)<span class="op">;</span>

  <span class="kw">const</span> page <span class="op">=</span> <span class="va">PageObject</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">visitAdmin</span><span class="op">:</span> <span class="at">visitable</span>(<span class="st">&#39;/admin&#39;</span>)<span class="op">,</span>
    <span class="dt">goToNewRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;add-rental&#39;</span>))<span class="op">,</span>
    <span class="dt">rentalName</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-name&#39;</span>))<span class="op">,</span>
    <span class="dt">rentalDailyRate</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-daily-rate&#39;</span>))<span class="op">,</span>
    <span class="dt">createRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;create-rental&#39;</span>))
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">const</span> user <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span>
  <span class="at">authenticateSession</span>(<span class="kw">this</span>.<span class="at">application</span><span class="op">,</span> <span class="op">{</span> <span class="dt">user_id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">}</span>)<span class="op">;</span>

  <span class="va">page</span>.<span class="at">visitAdmin</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-row&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;no rentals should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">const</span> name <span class="op">=</span> <span class="st">&#39;Rental 1&#39;</span><span class="op">;</span>
  <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="dv">100</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/rentals&#39;</span><span class="op">,</span> <span class="kw">function</span> (schema) <span class="op">{</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span> name<span class="op">,</span> dailyRate <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">schema</span>.<span class="va">rentals</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">goToNewRental</span>()
    .<span class="at">rentalName</span>(name)
    .<span class="at">rentalDailyRate</span>(dailyRate)
    .<span class="at">createRental</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-row&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;a new rental should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Not many surprises here - we are taking advantage of <strong>test selectors</strong> and <strong>page objects</strong> to make the test more expressive and simpler for both writing and reading. Not only do we interact with UI but we are also verifying if the expected request has been performed, which might not be the case if there is some validation error.</p>
<p>You might be wondering if we haven’t written too many tests at once - shouldn’t we maybe write one test, make it pass and only then write another one? That is a good question, but the answer is: it depends. In case of such simple scenario like here, there is not much risk in doing that, and I can’t recall any single false-positives in similar cases in acceptance tests, so I’m confident enough to bend some TDD rules. However, writing a minimum amount of tests and then writing a minimum implementation to make those tests pass is the right default way of TDD and unless you really know what you are doing, I wouldn’t recommend going against it.</p>
<p>To make this scenario pass let’s generate the model first:</p>
<pre><code>ember g model Rental name dailyRate</code></pre>
<p>and provide the types of the attributes:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/models/rental.js</span>
<span class="im">import</span> DS <span class="im">from</span> <span class="st">&#39;ember-data&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Model<span class="op">,</span>
  attr<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> DS<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">name</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;string&#39;</span>)<span class="op">,</span>
  <span class="dt">dailyRate</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;number&#39;</span>)
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>The next step will be adding some table to <code>admin.hbs</code> template where we are going to display all the rentals and also the button for adding a new rental:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/admin.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Admin<span class="kw">&lt;/h2&gt;</span>

{{#link-to &#39;rentals.new&#39; data-test-add-rental class=&#39;btn btn-primary&#39;}}
  Add rental
{{/link-to}}

<span class="kw">&lt;table</span><span class="ot"> class=</span><span class="st">&#39;table table-border&#39;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;</span>
      <span class="kw">&lt;th&gt;</span>Name<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Daily Rate<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Actions<span class="kw">&lt;/th&gt;</span>
    <span class="kw">&lt;/tr&gt;</span>
  <span class="kw">&lt;/thead&gt;</span>
  <span class="kw">&lt;tbody&gt;</span>
    {{#each rentals as |rental|}}
      <span class="kw">&lt;tr</span><span class="ot"> data-test-rental-row</span><span class="kw">&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{rental.name}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{rental.dailyRate}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;&lt;/td&gt;</span>
      <span class="kw">&lt;/tr&gt;</span>
    {{/each}}
  <span class="kw">&lt;/tbody&gt;</span>
<span class="kw">&lt;/table&gt;</span></code></pre></td></tr></table></div>
<p>As we need <code>rentals</code> to be available under <code>rentals</code> property, not generic <code>model</code> property, let’s do the proper adjustments in <code>admin</code> route:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/admin.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">findAll</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rentals&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Another step will be generating <code>rentals/new</code> route where the actual creation of the rental is going to happen:</p>
<pre><code>ember g route rentals/new</code></pre>
<p>What we need to put in this route is the logic responsible for creating a new rental and some <strong>route action</strong> that is going to persist the rental and then transition back to <code>admin</code> route on success. Here is the route:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rentals/new.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">createRecord</span>(<span class="st">&#39;rental&#39;</span>)
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">createRental</span>(rental) <span class="op">{</span>
      <span class="va">rental</span>.<span class="at">save</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And the last missing piece - the template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/rentals/new.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Create a new rental<span class="kw">&lt;/h2&gt;</span>

<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">(route-action</span> <span class="er">&quot;createRental&quot;</span><span class="ot"> rental</span><span class="er">)</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-name&quot;</span><span class="kw">&gt;</span>Name<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-name
      id=&quot;rental-name&quot;
      value=(mut rental.name)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-dailyRate&quot;</span><span class="kw">&gt;</span>Daily Rate<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-daily-rate
      id=&quot;rental-daily-rate&quot;
      value=(mut rental.dailyRate)
      class=&quot;form-control&quot;
      type=&quot;integer&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span><span class="ot"> data-test-create-rental</span><span class="kw">&gt;</span>Create rental<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>Back to green tests again!</p>
<p>Let’s cover the “U” part of the CRUD now, which is updating the rentals. This should be quite straightforward - we just need to add some <code>edit</code> route, where the updating will happen. Again, we are going to start with a test by extending the last scenario:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/rentals-crud-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> authenticateSession<span class="op">,</span> <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/ember-simple-auth&#39;</span><span class="op">;</span>
<span class="im">import</span> PageObject<span class="op">,</span> <span class="op">{</span>
  clickable<span class="op">,</span>
  fillable<span class="op">,</span>
  visitable
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;book-me/tests/page-object&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | rentals crud&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it is possible to read, create, edit and delete rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">5</span>)<span class="op">;</span>

  <span class="kw">const</span> page <span class="op">=</span> <span class="va">PageObject</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">visitAdmin</span><span class="op">:</span> <span class="at">visitable</span>(<span class="st">&#39;/admin&#39;</span>)<span class="op">,</span>
    <span class="dt">goToNewRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;add-rental&#39;</span>))<span class="op">,</span>
    <span class="dt">rentalName</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-name&#39;</span>))<span class="op">,</span>
    <span class="dt">rentalDailyRate</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-daily-rate&#39;</span>))<span class="op">,</span>
    <span class="dt">createRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;create-rental&#39;</span>))<span class="op">,</span>
    <span class="dt">goToEditRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;edit-rental&#39;</span>))<span class="op">,</span>
    <span class="dt">updateRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;update-rental&#39;</span>))<span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">const</span> user <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span>
  <span class="at">authenticateSession</span>(<span class="kw">this</span>.<span class="at">application</span><span class="op">,</span> <span class="op">{</span> <span class="dt">user_id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">}</span>)<span class="op">;</span>

  <span class="va">page</span>.<span class="at">visitAdmin</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-row&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;no rentals should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">const</span> name <span class="op">=</span> <span class="st">&#39;Rental 1&#39;</span><span class="op">;</span>
  <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="dv">100</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>(schema) <span class="op">{</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span> name<span class="op">,</span> dailyRate <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">schema</span>.<span class="va">rentals</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">goToNewRental</span>()
    .<span class="at">rentalName</span>(name)
    .<span class="at">rentalDailyRate</span>(dailyRate)
    .<span class="at">createRental</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-row&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;a new rental should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">const</span> updatedDailyRate <span class="op">=</span> <span class="dv">200</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">patch</span>(<span class="st">&#39;/rentals/:id&#39;</span><span class="op">,</span> <span class="kw">function</span>(<span class="op">{</span> rentals <span class="op">},</span> request) <span class="op">{</span>
    <span class="kw">const</span> id <span class="op">=</span> <span class="va">request</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">;</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span> id<span class="op">,</span> name<span class="op">,</span> <span class="dt">dailyRate</span><span class="op">:</span> updatedDailyRate <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">rentals</span>.<span class="at">find</span>(id).<span class="at">update</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">goToEditRental</span>()
    .<span class="at">rentalDailyRate</span>(updatedDailyRate)
    .<span class="at">updateRental</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span> <span class="st">&#39;user should be redirected to admin page&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Let’s make the tests green again. We will start with generating new routes:</p>
<pre><code>ember g route rental
ember g route rental/edit</code></pre>
<p>And do the proper adjustments in the router:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/router.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> config <span class="im">from</span> <span class="st">&#39;./config/environment&#39;</span><span class="op">;</span>

<span class="kw">const</span> Router <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Router</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">location</span><span class="op">:</span> <span class="va">config</span>.<span class="at">locationType</span><span class="op">,</span>
  <span class="dt">rootURL</span><span class="op">:</span> <span class="va">config</span>.<span class="at">rootURL</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="va">Router</span>.<span class="at">map</span>(<span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;signup&#39;</span>)
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;login&#39;</span>)<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;new&#39;</span>)<span class="op">;</span>

    <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;rental&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/rentals/:rental_id&#39;</span> <span class="op">},</span> <span class="kw">function</span>() <span class="op">{</span>
      <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;edit&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> Router<span class="op">;</span></code></pre></td></tr></table></div>
<p>Let’s add the edit link in <code>admin</code> template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/admin.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Admin<span class="kw">&lt;/h2&gt;</span>

{{#link-to &#39;rentals.new&#39; data-test-add-rental class=&#39;btn btn-primary&#39;}}
  Add rental
{{/link-to}}

<span class="kw">&lt;table</span><span class="ot"> class=</span><span class="st">&#39;table table-border&#39;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;</span>
      <span class="kw">&lt;th&gt;</span>Name<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Daily Rate<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Actions<span class="kw">&lt;/th&gt;</span>
    <span class="kw">&lt;/tr&gt;</span>
  <span class="kw">&lt;/thead&gt;</span>
  <span class="kw">&lt;tbody&gt;</span>
    {{#each rentals as |rental|}}
      <span class="kw">&lt;tr</span><span class="ot"> data-test-rental-row</span><span class="kw">&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{rental.name}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{rental.dailyRate}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>
          {{#link-to &#39;rental.edit&#39; rental data-test-edit-rental class=&#39;btn btn-primary&#39;}}
            Edit
          {{/link-to}}
        <span class="kw">&lt;/td&gt;</span>
      <span class="kw">&lt;/tr&gt;</span>
    {{/each}}
  <span class="kw">&lt;/tbody&gt;</span>
<span class="kw">&lt;/table&gt;</span></code></pre></td></tr></table></div>
<p>Now need to handle two routes: <code>rental</code> and <code>edit</code>. The former will be responsible for finding a proper rental by id, and the latter will contain the logic related to editing rentals. Here’s the code for both the <code>rental</code> route and the template:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rental.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">model</span>(params) <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">findRecord</span>(<span class="st">&#39;rental&#39;</span><span class="op">,</span> <span class="va">params</span>.<span class="at">rental_id</span>)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/rental.hbs --&gt;</span>
{{outlet}}</code></pre></td></tr></table></div>
<p>And here is for <code>edit</code> route:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rental/edit.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">model</span>(params) <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">updateRental</span>(rental) <span class="op">{</span>
      <span class="va">rental</span>.<span class="at">save</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/rental/edit.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Edit rental<span class="kw">&lt;/h2&gt;</span>

<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">(route-action</span> <span class="er">&quot;updateRental&quot;</span><span class="ot"> rental</span><span class="er">)</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-name&quot;</span><span class="kw">&gt;</span>Name<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-name
      id=&quot;rental-name&quot;
      value=(mut rental.name)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-dailyRate&quot;</span><span class="kw">&gt;</span>Daily Rate<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-daily-rate
      id=&quot;rental-daily-rate&quot;
      value=(mut rental.dailyRate)
      class=&quot;form-control&quot;
      type=&quot;integer&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span>
<span class="ot">    data-test-update-rental</span><span class="kw">&gt;</span>Edit Rental<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>Now we are back to green again! All tests are passing.</p>
<p>Before moving to deleting rentals to finally finish the CRUD for rentals, we need to handle few more things.</p>
<p>One is that we have some duplications for handling creating and updating rentals as the logic and templates for both cases is pretty much the same. Also, it would be a good idea to add some validation, which makes it even harder argument for DRYing some code up here.</p>
<p>Another thing is that the new routes are not protected by the authentication requirement.</p>
<p>Let’s handle those issues step by step.</p>
<p>The first step will be introducing changesets for both <code>create</code> and <code>update</code> actions. To avoid duplications, let’s try first to unify <code>new.hbs</code> and <code>edit.hbs</code> templates under a new component - <code>rental-persistence-form</code>:</p>
<pre><code>ember g component rental-persistence-form</code></pre>
<p>The only difference between the <code>new</code> and <code>edit</code> templates are headers (which are not the parts of the form itself) and submit button. To keep things simple we can make a button configurable part from the outside - for that purpose we will take advantage of <code>yield</code> helper inside a component. To handle the actions on submit, we will generalize both <code>createRental</code> and <code>updateRental</code> actions to <code>persistRental</code> action.</p>
<p>The role of this action will be quite simple - it will just call the action that was passed to the component. Let’s start with the component integration test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/components/rental-persistence-form-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;rental-persistence-form&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component |</span>
  rental persistence form<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it calls persistRental action when submitting form&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>
  <span class="kw">const</span> rental <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;persistRental&#39;</span><span class="op">,</span> (rentalArgument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(rentalArgument<span class="op">,</span> rental<span class="op">,</span>
      <span class="st">&#39;persistRental action should be called with rental argument&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`</span>
<span class="vs">    {{#rental-persistence-form rental=rental persistRental=persistRental}}</span>
<span class="vs">      &quot;&lt;button type=&#39;submit&#39;&gt;Submit&lt;/button&gt;&quot;</span>
<span class="vs">    {{/rental-persistence-form}}</span>
<span class="vs">  `</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="st">&#39;button&#39;</span>).<span class="at">click</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>The test is pretty simple - we just want to make sure that after submitting the form (which in this case is triggered by clicking the button that is configurable from the outside), the proper action will be called with the right arguments.</p>
<p>We can now make this new test pass. Here’s the component’s template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/rental-persistence-form.hbs --&gt;</span>
<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&quot;persistRental&quot;</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-name&quot;</span><span class="kw">&gt;</span>Name<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-name
      id=&quot;rental-name&quot;
      value=(mut rental.name)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-dailyRate&quot;</span><span class="kw">&gt;</span>Daily Rate<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-daily-rate
      id=&quot;rental-daily-rate&quot;
      value=(mut rental.dailyRate)
      class=&quot;form-control&quot;
      type=&quot;integer&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>

  {{yield}}

<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>And here’s the component’s body where we just handle <code>persistRental</code> action:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/rental-persistence-form.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">persistRental</span>() <span class="op">{</span>
      <span class="kw">const</span> rental <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;persistRental&#39;</span>)(rental)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And the test is passing! Now we can easily refactor <code>edit.hbs</code> and <code>new.hbs</code>. Here is the former template after refactoring and using <code>rental-persistence-form</code> component:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/rental/edit.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Edit rental<span class="kw">&lt;/h2&gt;</span>

{{#rental-persistence-form persistRental=(route-action &quot;updateRental&quot;) rental=rental}}
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span>
<span class="ot">    data-test-update-rental</span><span class="kw">&gt;</span>Edit Rental<span class="kw">&lt;/button&gt;</span>
{{/rental-persistence-form}}</code></pre></td></tr></table></div>
<p>and here is the latter:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/rental/edit.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Create a new rental<span class="kw">&lt;/h2&gt;</span>

{{#rental-persistence-form persistRental=(route-action &quot;createRental&quot;) rental=rental}}
  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span>
<span class="ot">    data-test-create-rental</span><span class="kw">&gt;</span>Create rental<span class="kw">&lt;/button&gt;</span>
{{/rental-persistence-form}}</code></pre></td></tr></table></div>
<p>Awesome, looks like we didn’t break any tests.</p>
<p>Now that we’ve managed to unify both actions under one template, let’s introduce changeset in the component:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/rental-persistence-form.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">init</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>(...<span class="at">arguments</span>)<span class="op">;</span>

    <span class="kw">const</span> rental <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> changeset <span class="op">=</span> <span class="kw">new</span> <span class="at">Changeset</span>(rental)<span class="op">;</span>

    <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span><span class="op">,</span> changeset)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">persistRental</span>() <span class="op">{</span>
      <span class="kw">const</span> changeset <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span>)<span class="op">;</span>

      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;persistRental&#39;</span>)(changeset)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/rental-persistence-form.hbs --&gt;</span>
<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&quot;persistRental&quot;</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-name&quot;</span><span class="kw">&gt;</span>Name<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-name
      id=&quot;rental-name&quot;
      value=(mut changeset.name)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-dailyRate&quot;</span><span class="kw">&gt;</span>Daily Rate<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-daily-rate
      id=&quot;rental-daily-rate&quot;
      value=(mut changeset.dailyRate)
      class=&quot;form-control&quot;
      type=&quot;integer&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>

  {{yield}}

<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>Introducing changeset was simple, but there is one problem though: our unit test for the component failed. But that’s not a surprise - we are no longer passing there a “raw” rental but a changeset instead, so let’s make the proper adjustments in the test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/components/rental-persistence-form-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;rental-persistence-form&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component |</span>
  rental persistence form<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it calls persistRental action when submitting form&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>
  <span class="kw">const</span> rental <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;persistRental&#39;</span><span class="op">,</span> (changeset) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="va">changeset</span>.<span class="at">_content</span><span class="op">,</span> rental<span class="op">,</span>
      <span class="st">&#39;persistRental action should be called with rental changset&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`</span>
<span class="vs">    {{#rental-persistence-form rental=rental persistRental=persistRental}}</span>
<span class="vs">      &quot;&lt;button type=&#39;submit&#39;&gt;Submit&lt;/button&gt;&quot;</span>
<span class="vs">    {{/rental-persistence-form}}</span>
<span class="vs">  `</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="st">&#39;button&#39;</span>).<span class="at">click</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And we are back to green again.</p>
<p>Another step will be introducing validations which will be the same for both <code>create</code> and <code>update</code> actions. We are going to take advantage of <code>ember-changeset-validations</code>, just like for the signup process:</p>
<pre><code>ember generate validator rental</code></pre>
<p>We want to make sure that <code>name</code> is a required attribute and that <code>dailyRate</code> is an integer and is greater than 0. Here are out tests for such requirements:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/validators/rental-test.js</span>
<span class="im">import</span> <span class="op">{</span> module<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> validateRental <span class="im">from</span> <span class="st">&#39;book-me/validators/rental&#39;</span><span class="op">;</span>

<span class="at">module</span>(<span class="st">&#39;Unit | Validator | rental&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates presence of name&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validateRental</span>.<span class="at">name</span>(<span class="st">&#39;name&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">,</span> <span class="st">&quot;Name can&#39;t be blank&quot;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validateRental</span>.<span class="at">name</span>(<span class="st">&#39;name&#39;</span><span class="op">,</span> <span class="st">&#39;Rental 1&#39;</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates if dailyRate is an integer greater than 0&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validateRental</span>.<span class="at">dailyRate</span>(<span class="st">&#39;dailyRate&#39;</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">,</span>
    <span class="st">&#39;Daily rate must be a number&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validateRental</span>.<span class="at">dailyRate</span>(<span class="st">&#39;dailyRate&#39;</span><span class="op">,</span> <span class="fl">123.12</span>)<span class="op">,</span>
    <span class="st">&#39;Daily rate must be an integer&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validateRental</span>.<span class="at">dailyRate</span>(<span class="st">&#39;dailyRate&#39;</span><span class="op">,</span> <span class="dv">100</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>The implementation is quite simple:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/validators/rental.js</span>
<span class="im">import</span> <span class="op">{</span>
  validatePresence<span class="op">,</span>
  validateNumber
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-changeset-validations/validators&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="op">{</span>
  <span class="dt">name</span><span class="op">:</span> <span class="at">validatePresence</span>(<span class="kw">true</span>)<span class="op">,</span>
  <span class="dt">dailyRate</span><span class="op">:</span> <span class="at">validateNumber</span>(<span class="op">{</span> <span class="dt">integer</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">gt</span><span class="op">:</span> <span class="dv">0</span> <span class="op">}</span>)<span class="op">,</span>
<span class="op">};</span></code></pre></td></tr></table></div>
<p>Now we need to integrate these validators with the changeset and the rest of the component. As you may have guessed already, we will start with the test checking that the errors are displayed when the form is submitted with invalid data and that the original <code>persistRental</code> action is not called. Here it is:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/components/rental-persistence-form-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;rental-persistence-form&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component |</span>
  rental persistence form<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it calls persistRental action when submitting form&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>
  <span class="kw">const</span> rental <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;persistRental&#39;</span><span class="op">,</span> (changeset) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="va">changeset</span>.<span class="at">_content</span><span class="op">,</span> rental<span class="op">,</span>
      <span class="st">&#39;persistRental action should be called with rental changset&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`</span>
<span class="vs">    {{#rental-persistence-form rental=rental persistRental=persistRental}}</span>
<span class="vs">      &quot;&lt;button type=&#39;submit&#39;&gt;Submit&lt;/button&gt;&quot;</span>
<span class="vs">    {{/rental-persistence-form}}</span>
<span class="vs">  `</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="st">&#39;button&#39;</span>).<span class="at">click</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="co">// new test</span>
<span class="at">test</span>(<span class="st">&#39;it displays validation error when the data is invalid&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>
  <span class="kw">const</span> rental <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;persistRental&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;action should not be called&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`</span>
<span class="vs">    {{#rental-persistence-form rental=rental persistRental=persistRental}}</span>
<span class="vs">      &quot;&lt;button type=&#39;submit&#39; data-test-submit-btn&gt;Submit&lt;/button&gt;&quot;</span>
<span class="vs">    {{/rental-persistence-form}}</span>
<span class="vs">  `</span>)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span>
    <span class="st">&#39;errors should not initially be visible&#39;</span>)

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;submit-btn&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span>
    <span class="st">&#39;errors should be visible when submitting form with invalid data&#39;</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>To make it pass need to do the proper adjustments in the component:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/rental-persistence-form.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>
<span class="im">import</span> lookupValidator <span class="im">from</span> <span class="st">&#39;ember-changeset-validations&#39;</span><span class="op">;</span>
<span class="im">import</span> RentalValidators <span class="im">from</span> <span class="st">&#39;book-me/validators/rental&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">init</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>(...<span class="at">arguments</span>)<span class="op">;</span>

    <span class="kw">const</span> rental <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> changeset <span class="op">=</span> <span class="kw">new</span> <span class="at">Changeset</span>(rental<span class="op">,</span> <span class="at">lookupValidator</span>(RentalValidators)<span class="op">,</span>
      RentalValidators)<span class="op">;</span>

    <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span><span class="op">,</span> changeset)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">persistRental</span>() <span class="op">{</span>
      <span class="kw">const</span> changeset <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span>)<span class="op">;</span>

      <span class="va">changeset</span>.<span class="at">validate</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="cf">if</span> (<span class="at">get</span>(changeset<span class="op">,</span> <span class="st">&#39;isValid&#39;</span>)) <span class="op">{</span>
          <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;persistRental&#39;</span>)(changeset)<span class="op">;</span>
        <span class="op">}</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>and in the template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/rental-persistence-form.hbs --&gt;</span>
{{#if changeset.isInvalid}}
  <span class="kw">&lt;section</span><span class="ot"> data-test-rental-errors</span><span class="kw">&gt;</span>
    {{#each changeset.errors as |error|}}
      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;alert alert-danger&quot;</span><span class="ot"> role=</span><span class="st">&quot;alert&quot;</span><span class="kw">&gt;</span>
        {{error.validation}}
      <span class="kw">&lt;/div&gt;</span>
    {{/each}}
  <span class="kw">&lt;/section&gt;</span>
{{/if}}

<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&quot;persistRental&quot;</span><span class="ot"> on=</span><span class="st">&quot;submit&quot;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-name&quot;</span><span class="kw">&gt;</span>Name<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-name
      id=&quot;rental-name&quot;
      value=(mut changeset.name)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;rental-dailyRate&quot;</span><span class="kw">&gt;</span>Daily Rate<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-rental-daily-rate
      id=&quot;rental-daily-rate&quot;
      value=(mut changeset.dailyRate)
      class=&quot;form-control&quot;
      type=&quot;integer&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>

  {{yield}}

<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>So now we should be back to green, right?</p>
<p>Well, not exactly. Our new test is passing, but the previous test is not! But that makes sense - we don’t currently fill any input with any data there, so the fact that it’s failing is just a sign of a good test suite. Let’s do the adjustments there and make this test pass:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/components/rental-persistence-form-test.js</span>
<span class="at">test</span>(<span class="st">&#39;it calls persistRental action when submitting form when the data</span>
  is valid<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>
  <span class="kw">const</span> rental <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;persistRental&#39;</span><span class="op">,</span> (changeset) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="va">changeset</span>.<span class="at">_content</span><span class="op">,</span> rental<span class="op">,</span>
      <span class="st">&#39;persistRental action should be called with rental changset&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`</span>
<span class="vs">    {{#rental-persistence-form rental=rental persistRental=persistRental}}</span>
<span class="vs">      &quot;&lt;button type=&#39;submit&#39; data-test-submit-btn&gt;Submit&lt;/button&gt;&quot;</span>
<span class="vs">    {{/rental-persistence-form}}</span>
<span class="vs">  `</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-name&#39;</span>)).<span class="at">val</span>(<span class="st">&#39;Rental 1&#39;</span>).<span class="at">change</span>()<span class="op">;</span>
  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-daily-rate&#39;</span>)).<span class="at">val</span>(<span class="dv">100</span>).<span class="at">change</span>()<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;submit-btn&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>And we are back to green!</p>
<p>What about server-side errors? Ideally, the UI validations would cover all the possible cases, but sometimes it is not feasible to do it perfectly (e.g., uniqueness validation) or some use case might be just overlooked, so it’s always a good idea to handle error messages coming from the server.</p>
<p>The natural way to handle it is to start with the tests. But the questions is - on what level? In this case it would be ideally acceptance test as multiple layers are going to be involved and checking if the errors are displayed in the UI is the safest way to verify it, but on the other hand those tests are much slower than unit tests, which would be the alternative here to acceptance tests as we could just handle it by testing route actions. The extra benefit of the unit tests here is that we could test for details in isolation.</p>
<p>To make it simpler let’s write both unit and acceptance tests to get an idea how it may look like and later decide which way is better. We will start with acceptance tests.</p>
<p>Before writing new tests as the part of <code>Rentals CRUD</code> scenario, let’s move the authentication logic to <code>beforeEach</code> hook and extract <strong>page object</strong> so that we make the tests more DRY and page object reusable in all scenarios.</p>
<p>Let’s generate <code>rentals</code> page:</p>
<pre><code>ember generate page-object rentals</code></pre>
<p>And move the logic there from <code>rentals-crud-test.js</code> test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/pages/rentals.js</span>
<span class="im">import</span> <span class="op">{</span>
  create<span class="op">,</span>
  clickable<span class="op">,</span>
  fillable<span class="op">,</span>
  visitable<span class="op">,</span>
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-page-object&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="at">create</span>(<span class="op">{</span>
  <span class="dt">visitAdmin</span><span class="op">:</span> <span class="at">visitable</span>(<span class="st">&#39;/admin&#39;</span>)<span class="op">,</span>
  <span class="dt">goToNewRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;add-rental&#39;</span>))<span class="op">,</span>
  <span class="dt">rentalName</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-name&#39;</span>))<span class="op">,</span>
  <span class="dt">rentalDailyRate</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-daily-rate&#39;</span>))<span class="op">,</span>
  <span class="dt">createRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;create-rental&#39;</span>))<span class="op">,</span>
  <span class="dt">goToEditRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;edit-rental&#39;</span>))<span class="op">,</span>
  <span class="dt">updateRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;update-rental&#39;</span>))<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And here is our test file after refactoring:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/rentals-crud-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> authenticateSession<span class="op">,</span> <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/ember-simple-auth&#39;</span><span class="op">;</span>
<span class="im">import</span> page <span class="im">from</span> <span class="st">&#39;book-me/tests/pages/rentals&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | rentals crud&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">const</span> user <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span>
    <span class="at">authenticateSession</span>(<span class="kw">this</span>.<span class="at">application</span><span class="op">,</span> <span class="op">{</span> <span class="dt">user_id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it is possible to read, create, edit and delete rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">5</span>)<span class="op">;</span>

  <span class="va">page</span>.<span class="at">visitAdmin</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-row&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;no rentals should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">const</span> name <span class="op">=</span> <span class="st">&#39;Rental 1&#39;</span><span class="op">;</span>
  <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="dv">100</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>(schema) <span class="op">{</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span> name<span class="op">,</span> dailyRate <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">schema</span>.<span class="va">rentals</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">goToNewRental</span>()
    .<span class="at">rentalName</span>(name)
    .<span class="at">rentalDailyRate</span>(dailyRate)
    .<span class="at">createRental</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-row&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;a new rental should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">const</span> updatedDailyRate <span class="op">=</span> <span class="dv">200</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">patch</span>(<span class="st">&#39;/rentals/:id&#39;</span><span class="op">,</span> <span class="kw">function</span>(<span class="op">{</span> rentals <span class="op">},</span> request) <span class="op">{</span>
    <span class="kw">const</span> id <span class="op">=</span> <span class="va">request</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">;</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span> id<span class="op">,</span> name<span class="op">,</span> <span class="dt">dailyRate</span><span class="op">:</span> updatedDailyRate <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span> <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">rentals</span>.<span class="at">find</span>(id).<span class="at">update</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">goToEditRental</span>()
    .<span class="at">rentalDailyRate</span>(updatedDailyRate)
    .<span class="at">updateRental</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span> <span class="st">&#39;user should be redirected to admin page&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>All tests are still passing, so we managed to not break anything. Let’s write two new tests: one for handling server-side error messages when creating a new rental and one for updating a rental. The idea is simple - we want to make sure the error messages are displayed, even when passing the client-side validations. Here are our two tests:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/rentals-crud-test.js</span>
<span class="co">// new import</span>
<span class="im">import</span> Mirage <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Response<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Mirage<span class="op">;</span>

<span class="co">// 2 new tests:</span>
<span class="at">test</span>(<span class="st">&#39;it displays server-side validation errors when creating new rental&#39;</span><span class="op">,</span>
  <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/rentals&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> errors <span class="op">=</span> <span class="op">{</span>
      <span class="dt">errors</span><span class="op">:</span> [
        <span class="op">{</span>
          <span class="dt">detail</span><span class="op">:</span> <span class="st">&#39;is already taken&#39;</span><span class="op">,</span>
          <span class="dt">source</span><span class="op">:</span> <span class="op">{</span>
            <span class="dt">pointer</span><span class="op">:</span> <span class="st">&#39;data/attributes/name&#39;</span>
          <span class="op">}</span>
        <span class="op">}</span>
      ]
    <span class="op">};</span>
    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Response</span>(<span class="dv">422</span><span class="op">,</span> <span class="op">{},</span> errors)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">visitAdmin</span>()
    .<span class="at">goToNewRental</span>()
    .<span class="at">rentalName</span>(<span class="st">&#39;name&#39;</span>)
    .<span class="at">rentalDailyRate</span>(<span class="dv">100</span>)
    .<span class="at">createRental</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;rentals.new&#39;</span><span class="op">,</span> <span class="st">&#39;user should stay on new rental page&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;errors should be visible when submitting form with invalid data&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it displays server-side validation errors when updating rental&#39;</span><span class="op">,</span>
  <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;rental&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;name&#39;</span><span class="op">,</span> <span class="dt">dailyRate</span><span class="op">:</span> <span class="dv">20</span> <span class="op">}</span>)<span class="op">;</span>

  <span class="va">server</span>.<span class="at">patch</span>(<span class="st">&#39;/rentals/:id&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> errors <span class="op">=</span> <span class="op">{</span>
      <span class="dt">errors</span><span class="op">:</span> [
        <span class="op">{</span>
          <span class="dt">detail</span><span class="op">:</span> <span class="st">&#39;is already taken&#39;</span><span class="op">,</span>
          <span class="dt">source</span><span class="op">:</span> <span class="op">{</span>
            <span class="dt">pointer</span><span class="op">:</span> <span class="st">&#39;data/attributes/name&#39;</span>
          <span class="op">}</span>
        <span class="op">}</span>
      ]
    <span class="op">};</span>
    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Response</span>(<span class="dv">422</span><span class="op">,</span> <span class="op">{},</span> errors)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">visitAdmin</span>()
    .<span class="at">goToEditRental</span>()
    .<span class="at">rentalName</span>(<span class="st">&#39;updated name&#39;</span>)
    .<span class="at">rentalDailyRate</span>(<span class="dv">100</span>)
    .<span class="at">updateRental</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;rental.edit&#39;</span><span class="op">,</span>
      <span class="st">&#39;user should stay on edit rental page&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;errors should be visible when submitting form with invalid data&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Although first part of our tests is fine - we verified that we won’t be redirected to <code>admin</code> route, the second part, checking if validation errors are displayed, is failing which is a very good thing as seeing this part fail is the way to verify that we are not confusing client-side errors with server-side errors.</p>
<p>To make these tests pass we just need to copy validation errors from model’s errors to changeset in <code>edit</code> and <code>new</code> routes. We need to keep in mind that the formatted validation message that we display in a component comes from error’s <code>validation</code> property, so it’s essential to populate this attribute:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rentals/new.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">createRecord</span>(<span class="st">&#39;rental&#39;</span>)
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">createRental</span>(changeset) <span class="op">{</span>
      <span class="va">changeset</span>.<span class="at">save</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>
      <span class="op">}</span>).<span class="at">catch</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">const</span> errors <span class="op">=</span> <span class="at">get</span>(<span class="va">changeset</span>.<span class="at">_content</span><span class="op">,</span> <span class="st">&#39;errors&#39;</span>)

        <span class="va">errors</span>.<span class="at">forEach</span>(error <span class="op">=&gt;</span> <span class="op">{</span>
          <span class="kw">const</span> key <span class="op">=</span> <span class="va">error</span>.<span class="at">attribute</span><span class="op">;</span>
          <span class="kw">const</span> message <span class="op">=</span> <span class="va">error</span>.<span class="at">message</span><span class="op">;</span>

          <span class="va">changeset</span>.<span class="at">addError</span>(key<span class="op">,</span> <span class="op">{</span> <span class="dt">validation</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>message<span class="sc">}</span><span class="vs">`</span> <span class="op">}</span>)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rental/edit.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">updateRental</span>(changeset) <span class="op">{</span>
      <span class="va">changeset</span>.<span class="at">save</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>
      <span class="op">}</span>).<span class="at">catch</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">const</span> errors <span class="op">=</span> <span class="at">get</span>(<span class="va">changeset</span>.<span class="at">_content</span><span class="op">,</span> <span class="st">&#39;errors&#39;</span>)

        <span class="va">errors</span>.<span class="at">forEach</span>(error <span class="op">=&gt;</span> <span class="op">{</span>
          <span class="kw">const</span> key <span class="op">=</span> <span class="va">error</span>.<span class="at">attribute</span><span class="op">;</span>
          <span class="kw">const</span> message <span class="op">=</span> <span class="va">error</span>.<span class="at">message</span><span class="op">;</span>

          <span class="va">changeset</span>.<span class="at">addError</span>(key<span class="op">,</span> <span class="op">{</span> <span class="dt">validation</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>message<span class="sc">}</span><span class="vs">`</span> <span class="op">}</span>)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And we are back to green tests again! Let’s cover the same use case with unit tests for route actions. As both <code>edit</code> and <code>new</code> routes are almost the same, the tests won’t differ that much. The idea is simple: we just need to check if the changeset errors are indeed populated with model errors when the <code>save</code> fails (i.e., when the promise is rejected).</p>
<p>Here’s how we can approach it:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rentals/new-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  RSVP<span class="op">,</span>
  run<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="at">moduleFor</span>(<span class="st">&#39;route:rentals/new&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route | rentals/new&#39;</span><span class="op">,</span> <span class="op">{</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;changeset gets populated with model errors in `createRental` action</span>
  when there is an error on backend<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>
  <span class="kw">const</span> createRental <span class="op">=</span> <span class="va">route</span>.<span class="va">actions</span>.<span class="at">createRental</span><span class="op">;</span>

  <span class="kw">const</span> errors <span class="op">=</span> [
    <span class="op">{</span>
      <span class="dt">attribute</span><span class="op">:</span> <span class="st">&#39;name&#39;</span><span class="op">,</span>
      <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;is invalid&#39;</span><span class="op">,</span>
    <span class="op">}</span>
  ]<span class="op">;</span>
  <span class="kw">const</span> rentalStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">save</span>() <span class="op">{</span>
      <span class="cf">return</span> <span class="va">RSVP</span>.<span class="at">reject</span>()<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>(<span class="op">{</span> errors <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> changeset <span class="op">=</span> <span class="kw">new</span> <span class="at">Changeset</span>(rentalStub)<span class="op">;</span>

  <span class="at">run</span>(<span class="va">createRental</span>.<span class="at">bind</span>(route<span class="op">,</span> changeset))<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">get</span>(changeset<span class="op">,</span> <span class="st">&#39;isInvalid&#39;</span>)<span class="op">,</span> <span class="st">&#39;changeset should be invalid&#39;</span>)<span class="op">;</span>

  <span class="kw">const</span> expectedErrors <span class="op">=</span> [
    <span class="op">{</span>
      <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;name&#39;</span><span class="op">,</span>
      <span class="dt">validation</span><span class="op">:</span> <span class="st">&#39;name is invalid&#39;</span><span class="op">,</span>
    <span class="op">}</span>
  ]<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="at">get</span>(changeset<span class="op">,</span> <span class="st">&#39;errors&#39;</span>)<span class="op">,</span> expectedErrors<span class="op">,</span>
    <span class="st">&#39;changeset should be populated with errors&#39;</span>)<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rental/edit-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  RSVP<span class="op">,</span>
  run<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="at">moduleFor</span>(<span class="st">&#39;route:rental/edit&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route | rental/edit&#39;</span><span class="op">,</span> <span class="op">{</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;changeset gets populated with model errors in `updateRental`</span>
  action when there is an error on backend<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>
  <span class="kw">const</span> updateRental <span class="op">=</span> <span class="va">route</span>.<span class="va">actions</span>.<span class="at">updateRental</span><span class="op">;</span>

  <span class="kw">const</span> errors <span class="op">=</span> [
    <span class="op">{</span>
      <span class="dt">attribute</span><span class="op">:</span> <span class="st">&#39;name&#39;</span><span class="op">,</span>
      <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;is invalid&#39;</span><span class="op">,</span>
    <span class="op">}</span>
  ]<span class="op">;</span>
  <span class="kw">const</span> rentalStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">save</span>() <span class="op">{</span>
      <span class="cf">return</span> <span class="va">RSVP</span>.<span class="at">reject</span>()<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>(<span class="op">{</span> errors <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> changeset <span class="op">=</span> <span class="kw">new</span> <span class="at">Changeset</span>(rentalStub)<span class="op">;</span>

  <span class="at">run</span>(<span class="va">updateRental</span>.<span class="at">bind</span>(route<span class="op">,</span> changeset))<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">get</span>(changeset<span class="op">,</span> <span class="st">&#39;isInvalid&#39;</span>)<span class="op">,</span> <span class="st">&#39;changeset should be invalid&#39;</span>)<span class="op">;</span>

  <span class="kw">const</span> expectedErrors <span class="op">=</span> [
    <span class="op">{</span>
      <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;name&#39;</span><span class="op">,</span>
      <span class="dt">validation</span><span class="op">:</span> <span class="st">&#39;name is invalid&#39;</span><span class="op">,</span>
    <span class="op">}</span>
  ]<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="at">get</span>(changeset<span class="op">,</span> <span class="st">&#39;errors&#39;</span>)<span class="op">,</span> expectedErrors<span class="op">,</span>
    <span class="st">&#39;changeset should be populated with errors&#39;</span>)<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>There are some interesting patterns used in those two examples. To grab a specific action from a route, we can access its <code>actions</code> property and then fetch the action we need. Another step is creating a rental stub with a <code>save</code> method that merely returns rejected promise, which is exactly what we need to handle the error flow. We also populate rental stub with some <code>errors</code> messages. Then, we run the actual action in <code>Ember.run</code>, which is quite important here as we are dealing with promises and that way we will make sure that the assertions are not being run before the promise is fulfilled. To make sure <code>this</code> will be the expected context in the action when running tests, we need to take advantage of <code>bind</code> and pass the actual <code>route</code> as the first argument; otherwise, everything that calls <code>this</code> in the route action will fail. The last thing is the assertions - we obviously want to make sure the changeset is invalid and that it contains the proper validation messages.</p>
<p>Before moving to deleting rentals, we have one more thing to handle - making sure <code>edit</code> and <code>new</code> routes require authentication.</p>
<p>Adding acceptance tests to cover those cases might be too heavy. Ideally, we would cover this case with unit tests.</p>
<p>The best way to handle this case will be to check if <code>AuthenticatedRouteMixin</code> is included. After a quick look at the <a href="https://github.com/simplabs/ember-simple-auth/blob/1.4.0/addon/mixins/authenticated-route-mixin.js#L80">mixin</a>, we can see that <code>beforeModel</code> hook uses <code>session</code> service and its <code>isAuthenticated</code> property to check if we are authenticated or not. To make sure the routes are protected, we can just make sure that this property is called when executing <code>beforeModel</code> hook. Here are the tests:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rentals/new-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  RSVP<span class="op">,</span>
  run<span class="op">,</span>
  computed<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="at">moduleFor</span>(<span class="st">&#39;route:rentals/new&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route | rentals/new&#39;</span><span class="op">,</span> <span class="op">{</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it requires authentication&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> sessionStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Service</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="dt">isAuthenticated</span><span class="op">:</span> <span class="at">computed</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;isAuthenticated has to be used for checking authentication&#39;</span>)<span class="op">;</span>

      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
    <span class="op">}</span>)<span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">register</span>(<span class="st">&#39;service:session&#39;</span><span class="op">,</span> sessionStub)<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">inject</span>.<span class="at">service</span>(<span class="st">&#39;session&#39;</span>)<span class="op">;</span>

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="va">route</span>.<span class="at">beforeModel</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rental/edit-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  RSVP<span class="op">,</span>
  run<span class="op">,</span>
  computed<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="at">moduleFor</span>(<span class="st">&#39;route:rental/edit&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route | rental/edit&#39;</span><span class="op">,</span> <span class="op">{</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it requires authentication&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> sessionStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Service</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="dt">isAuthenticated</span><span class="op">:</span> <span class="at">computed</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;isAuthenticated has to be used for checking authentication&#39;</span>)<span class="op">;</span>

      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
    <span class="op">}</span>)<span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">register</span>(<span class="st">&#39;service:session&#39;</span><span class="op">,</span> sessionStub)<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">inject</span>.<span class="at">service</span>(<span class="st">&#39;session&#39;</span>)<span class="op">;</span>

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="va">route</span>.<span class="at">beforeModel</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>The interesting thing here is that we are providing a session stub instead of using a real service with <code>isAuthenticated</code> computed property where we are making assertion just to make sure this property is called. Next, we register the stub as <code>service:session</code> and inject the service. In the end, we are just calling <code>beforeModel()</code> method. Thanks to <code>assert.expect(1)</code>, such test is enough here - if <code>isAuthenticated</code> property doesn’t get called, it will fail.</p>
<p>And here is the implementation to make those tests pass:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/new.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
    <span class="co">// the rest of the code</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/new.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
    <span class="co">// the rest of the code</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/edit.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
    <span class="co">// the rest of the code</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>But not the all tests are green! Apparently, we’ve just broken the tests for route actions, and we are getting <code>Attempting to inject an unknown injection: 'service:session'</code> error. To fix this, we just need to take advantage of <code>needs</code> property and provide the missing dependencies:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rental/edit-test.js</span>
<span class="at">moduleFor</span>(<span class="st">&#39;route:rental/edit&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route | rental/edit&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">needs</span><span class="op">:</span> [<span class="st">&#39;service:session&#39;</span>]<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rentals/new-test.js</span>
<span class="at">moduleFor</span>(<span class="st">&#39;route:rentals/new&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route | rentals/new&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">needs</span><span class="op">:</span> [<span class="st">&#39;service:session&#39;</span>]<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Now we are back to green; all tests are passing.</p>
<p>Now, it’s time for the final part of Rentals’ CRUD - adding a possibility to delete rentals.</p>
<p>When adding a delete button, it’s worth keeping in mind some usability aspects and providing good UX - it’s quite easy to accidentally click on the button and remove something that was not supposed to be removed.</p>
<p>One easy solution is to possibly display a confirmation alert and make user users confirm the action before deleting anything. That would certainly get the job done, but it’s not that pretty from the UX perspective. Fortunately, we can do much better than this, and it is quite simple to implement - we could just make the user hold a button for a particular period, e.g., 3 seconds and only after 3 seconds will the rental be deleted. Holding it for a shorter period would not have any effect.</p>
<p>Apparently, we are quite lucky since there is already some addon that provides such solution - <a href="https://www.npmjs.com/package/ember-hold-button">ember-hold-button</a>.</p>
<p>We can now write an acceptance tests. What we want to test is that after holding the button, rental will no longer be in the UI and that <code>DELETE</code> request will be performed to <code>rentals/:id</code> endpoint. Here’s the test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/rentals-crud-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> authenticateSession<span class="op">,</span> <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/ember-simple-auth&#39;</span><span class="op">;</span>
<span class="im">import</span> page <span class="im">from</span> <span class="st">&#39;book-me/tests/pages/rentals&#39;</span><span class="op">;</span>
<span class="im">import</span> Mirage <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Response<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Mirage<span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | rentals crud&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">const</span> user <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span>
    <span class="at">authenticateSession</span>(<span class="kw">this</span>.<span class="at">application</span><span class="op">,</span> <span class="op">{</span> <span class="dt">user_id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it is possible to read, create, edit and delete rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">7</span>)<span class="op">;</span>

  <span class="va">page</span>.<span class="at">visitAdmin</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-row&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;no rentals should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">const</span> name <span class="op">=</span> <span class="st">&#39;Rental 1&#39;</span><span class="op">;</span>
  <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="dv">100</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>(schema) <span class="op">{</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span> name<span class="op">,</span> dailyRate <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">schema</span>.<span class="va">rentals</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">goToNewRental</span>()
    .<span class="at">rentalName</span>(name)
    .<span class="at">rentalDailyRate</span>(dailyRate)
    .<span class="at">createRental</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-row&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;a new rental should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">const</span> updatedDailyRate <span class="op">=</span> <span class="dv">200</span><span class="op">;</span>

  <span class="va">server</span>.<span class="at">patch</span>(<span class="st">&#39;/rentals/:id&#39;</span><span class="op">,</span> <span class="kw">function</span>(<span class="op">{</span> rentals <span class="op">},</span> request) <span class="op">{</span>
    <span class="kw">const</span> id <span class="op">=</span> <span class="va">request</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">;</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span> id<span class="op">,</span> name<span class="op">,</span> <span class="dt">dailyRate</span><span class="op">:</span> updatedDailyRate <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">rentals</span>.<span class="at">find</span>(id).<span class="at">update</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">goToEditRental</span>()
    .<span class="at">rentalDailyRate</span>(updatedDailyRate)
    .<span class="at">updateRental</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentPath</span>()<span class="op">,</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span> <span class="st">&#39;user should be redirected to admin page&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="co">// new stuff for testing deleting the rentals</span>

  <span class="va">server</span>.<span class="at">del</span>(<span class="st">&#39;/rentals/:id&#39;</span><span class="op">,</span> <span class="kw">function</span>(<span class="op">{</span> rentals <span class="op">},</span> request) <span class="op">{</span>
    <span class="kw">const</span> id <span class="op">=</span> <span class="va">request</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">;</span>

    <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;rental should be destroyed&#39;</span>)

    <span class="va">rentals</span>.<span class="at">find</span>(id).<span class="at">destroy</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="va">page</span>.<span class="at">deleteRental</span>()<span class="op">;</span> <span class="co">// not implemented yet</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-row&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;no rentals should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>The next step will be implementing <code>deleteRental</code> on Rentals page object. But how should we handle the interaction with the button? Obviously, it’s not just a simple click.</p>
<p>To solve that problem we should break the problem down into the single events. On a non-mobile device, pressing a button means triggering <strong>mouseDown</strong> event and releasing means triggering <strong>mouseUp</strong> event. On mobile that would be <strong>touchStart</strong> and <strong>touchEnd</strong> events accordingly.</p>
<p>Based on how <a href="https://www.npmjs.com/package/ember-hold-button"><strong>hold-button</strong></a> component works, we may suspect that there is some internal timer which starts counting time after triggering <strong>mouseDown</strong> (<strong>touchStart</strong>) event or a scheduler which executes the action if it was held for required amount of time and cancels it if it was released before that period, which would mean cancelling timer on <strong>mouseUp</strong> event.</p>
<p>After checking the <a href="https://github.com/AddJam/ember-hold-button/blob/master/addon/components/hold-button.js">internals</a> of the addon, it turns out this is exactly the case! We don’t have to care about <strong>mouseUp</strong> part; we just need to make sure that <code>mouseDown</code> event is triggered on the button. Fortunately, it is quite easy to achieve with <code>ember-cli-page-object</code> - we just need to take advantage of <code>triggerable</code> helper. Here’s how our page object is going to look like now:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/pages/rentals.js</span>
<span class="im">import</span> <span class="op">{</span>
  create<span class="op">,</span>
  clickable<span class="op">,</span>
  fillable<span class="op">,</span>
  visitable<span class="op">,</span>
  triggerable<span class="op">,</span>
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-page-object&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="at">create</span>(<span class="op">{</span>
  <span class="dt">visitAdmin</span><span class="op">:</span> <span class="at">visitable</span>(<span class="st">&#39;/admin&#39;</span>)<span class="op">,</span>
  <span class="dt">goToNewRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;add-rental&#39;</span>))<span class="op">,</span>
  <span class="dt">rentalName</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-name&#39;</span>))<span class="op">,</span>
  <span class="dt">rentalDailyRate</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;rental-daily-rate&#39;</span>))<span class="op">,</span>
  <span class="dt">createRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;create-rental&#39;</span>))<span class="op">,</span>
  <span class="dt">goToEditRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;edit-rental&#39;</span>))<span class="op">,</span>
  <span class="dt">updateRental</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;update-rental&#39;</span>))<span class="op">,</span>
  <span class="dt">deleteRental</span><span class="op">:</span> <span class="at">triggerable</span>(<span class="st">&#39;mousedown&#39;</span><span class="op">,</span> <span class="at">testSelector</span>(<span class="st">&#39;delete-rental&#39;</span>))<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Now that we see the new scenario failing let’s move to the actual implementation. We will start with installing the addon:</p>
<pre><code>ember install ember-hold-button</code></pre>
<p>We need to add the button to <code>admin.hbs</code> template and implement a route action, let’s call it <code>delete-rental</code>, that will be responsible for deleting rentals. Here’s the template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/admin.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Admin<span class="kw">&lt;/h2&gt;</span>

{{#link-to &#39;rentals.new&#39; data-test-add-rental class=&#39;btn btn-primary&#39;}}
  Add rental
{{/link-to}}

<span class="kw">&lt;table</span><span class="ot"> class=</span><span class="st">&#39;table table-border&#39;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;</span>
      <span class="kw">&lt;th&gt;</span>Name<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Daily Rate<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Actions<span class="kw">&lt;/th&gt;</span>
    <span class="kw">&lt;/tr&gt;</span>
  <span class="kw">&lt;/thead&gt;</span>
  <span class="kw">&lt;tbody&gt;</span>
    {{#each rentals as |rental|}}
      <span class="kw">&lt;tr</span><span class="ot"> data-test-rental-row</span><span class="kw">&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{rental.name}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{rental.dailyRate}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>
          {{#link-to &#39;rental.edit&#39; rental data-test-edit-rental class=&#39;btn btn-primary&#39;}}
            Edit
          {{/link-to}}

          {{#hold-button action=(route-action &#39;deleteRental&#39; rental) delay=3000
            class=&#39;btn&#39; data-test-delete-rental=rental.id}}
            Delete
          {{/hold-button}}
        <span class="kw">&lt;/td&gt;</span>
      <span class="kw">&lt;/tr&gt;</span>
    {{/each}}
  <span class="kw">&lt;/tbody&gt;</span>
<span class="kw">&lt;/table&gt;</span></code></pre></td></tr></table></div>
<p>Holding the button for 3 seconds will trigger <code>deleteRental</code> action. Here is its implementation in <code>admin</code> route:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/admin.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">findAll</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rentals&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">deleteRental</span>(rental) <span class="op">{</span>
      <span class="va">rental</span>.<span class="at">destroyRecord</span>()<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And again, all tests are passing! We’ve managed to implement the full CRUD TDD-style. However, there are a couple of things that be improved.</p>
<p>The first one is that we may want to delete rental in multiple places later, not only in <code>admin</code>. In such case, we may want to have the entire process of deleting rental encapsulated in a component that would be exclusively responsible for deleting rentals. Also, that would be a good use case to learn how to test such logic in a component integration test ;).</p>
<p>Another thing is that holding a button for 3 seconds in test suite makes it last 3 seconds longer, which is quite long. Ideally, we would have some kind of helper that in the non-test environment would return the “real” delay time and in the test environment, it would return <code>0</code> to make it possibly fast.</p>
<p>We will certainly need to get back to that issue but for now, let’s focus now on a component that we will call <code>delete-rental-button</code>:</p>
<pre><code>ember g component delete-rental-button</code></pre>
<p>As you may have already guessed, we will start with the integration test. The idea is simple: we need to make sure that after holding a button for a certain time the rental will get deleted. The test itself is not that obvious, however:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/components/delete-rental-button-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> wait <span class="im">from</span> <span class="st">&#39;ember-test-helpers/wait&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
  RSVP<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;delete-rental-button&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component |</span>
  <span class="kw">delete</span> rental button<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it deletes rental by holding a button&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="kw">const</span> rentalStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">destroyRecord</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;item should be destroyed&#39;</span>)<span class="op">;</span>

      <span class="cf">return</span> <span class="va">RSVP</span>.<span class="at">resolve</span>(<span class="kw">this</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>)<span class="op">;</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> rentalStub)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{delete-rental-button rental=rental}}`</span>)<span class="op">;</span>

  <span class="kw">const</span> $deleteBtn <span class="op">=</span> <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;delete-rental&#39;</span>))<span class="op">;</span>
  <span class="kw">const</span> done <span class="op">=</span> <span class="va">assert</span>.<span class="at">async</span>()<span class="op">;</span>

  <span class="va">$deleteBtn</span>.<span class="at">mousedown</span>()<span class="op">;</span>

  <span class="at">wait</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">done</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Even though there is only one assertion, there are few interesting things going on in the test. The beginning is quite simple - we create a rental stub and define <code>destroyRecord</code> method where we do the actual assertion that this method was called and we render the component and find <code>deleteBtn</code>, that is simple. But then we are using <code>async() / done()</code> functions, triggering <code>mouseDown</code> event on the button and using <code>wait()</code> helper. What are the purposes of those functions?</p>
<ul>
<li><p><code>async()/done()</code> – To make sure QUnit will wait for an asynchronous operation to be finished, we need to use <code>async()</code> function. That way QUnit will wait until <code>done()</code> is called.</p></li>
<li><p><code>wait()</code> – it forces run loop to process all the pending events. That way we ensure that the asynchronous operation has been executed (like calling <code>deleteRental</code> action after 3 seconds. When all the events have been processed, we can call <code>done()</code>.</p></li>
</ul>
<p>It might sound a bit complex, but after writing several of such tests, such flow becomes quite simple and obvious.</p>
<p>Here’s the implementation of the component:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/delete-rental-button.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">delay</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">deleteRental</span>() <span class="op">{</span>
      <span class="kw">const</span> rental <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

      <span class="va">rental</span>.<span class="at">destroyRecord</span>()<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>and its body:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!--book-me/app/templates/components/delete-rental-button.hbs --&gt;</span>
{{#hold-button action=&quot;deleteRental&quot; delay=delay class=&#39;btn&#39;
  data-test-delete-rental=rental.id}}
  Delete
{{/hold-button}}</code></pre></td></tr></table></div>
<p>And that way we managed to get the component’s test to pass. Now, let’s get back to the idea of making the tests faster:</p>
<p>We will implement a utility function called <code>resolveDelay</code>. We are going to start with a test checking that whatever value we pass, we will get <code>0</code> as a result. Since the behavior is going to be environment-dependent, there is not much we can do for testing it for other environments, so it might be worth testing in UI via the real interaction in such case.</p>
<p>Here’s the test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/utilities/resolve-delay-test.js</span>
<span class="im">import</span> resolveDelay <span class="im">from</span> <span class="st">&#39;book-me/utilities/resolve-delay&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> module<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>

<span class="at">module</span>(<span class="st">&#39;Unit | Utility | resolve delay&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it returns 0 for every value in test env&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">resolveDelay</span>(<span class="dv">42</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">resolveDelay</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">resolveDelay</span>(<span class="dv">3000</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And here’s the implementation:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/utilities/resolve-delay.js</span>
<span class="im">import</span> config <span class="im">from</span> <span class="st">&#39;book-me/config/environment&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="kw">function</span> <span class="at">resolveDelay</span>(delay) <span class="op">{</span>
  <span class="cf">if</span> (<span class="va">config</span>.<span class="at">environment</span> <span class="op">===</span> <span class="st">&#39;test&#39;</span>) <span class="op">{</span>
    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span>
  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
    <span class="cf">return</span> delay<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>We can apply it now in our <code>delete-rental-button</code> component:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/delete-rental-button.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> resolveDelay <span class="im">from</span> <span class="st">&#39;book-me/utilities/resolve-delay&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">delay</span><span class="op">:</span> <span class="at">resolveDelay</span>(<span class="dv">3000</span>)<span class="op">,</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">deleteRental</span>() <span class="op">{</span>
      <span class="kw">const</span> rental <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

      <span class="va">rental</span>.<span class="at">destroyRecord</span>()<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>All tests are still passing so nothing got broken. We can now modify <code>admin.hbs</code> template and take advantage of <code>delete-rental-button</code> component:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!--book-me/app/templates/admin.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Admin<span class="kw">&lt;/h2&gt;</span>

{{#link-to &#39;rentals.new&#39; data-test-add-rental class=&#39;btn btn-primary&#39;}}
  Add rental
{{/link-to}}

<span class="kw">&lt;table</span><span class="ot"> class=</span><span class="st">&#39;table table-border&#39;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;</span>
      <span class="kw">&lt;th&gt;</span>Name<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Daily Rate<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Actions<span class="kw">&lt;/th&gt;</span>
    <span class="kw">&lt;/tr&gt;</span>
  <span class="kw">&lt;/thead&gt;</span>
  <span class="kw">&lt;tbody&gt;</span>
    {{#each rentals as |rental|}}
      <span class="kw">&lt;tr</span><span class="ot"> data-test-rental-row</span><span class="kw">&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{rental.name}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{rental.dailyRate}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>
          {{#link-to &#39;rental.edit&#39; rental data-test-edit-rental class=&#39;btn btn-primary&#39;}}
            Edit
          {{/link-to}}

          {{delete-rental-button rental=rental}}
        <span class="kw">&lt;/td&gt;</span>
      <span class="kw">&lt;/tr&gt;</span>
    {{/each}}
  <span class="kw">&lt;/tbody&gt;</span>
<span class="kw">&lt;/table&gt;</span></code></pre></td></tr></table></div>
<p>And our test suite has just become much faster ;). We can also remove the route action since it’s not used anymore:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/admin.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">findAll</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rentals&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>As the last improvement, let’s display some notification when the rental gets deleted, which would bring more pleasant UX. There is a great addon that will be very helpful here called <a href="https://github.com/aexmachina/ember-notify"><strong>ember-notify</strong></a>, let’s install it:</p>
<pre><code>ember install ember-notify</code></pre>
<p>The setup is quite straightforward, we just need to display <code>ember-notify</code> component in <code>application.hbs</code> template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/application.hbs --&gt;</span>
<span class="kw">&lt;nav</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-default navbar-fixed-top&quot;</span><span class="ot"> role=</span><span class="st">&quot;navigation&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container-fluid&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-header&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;button&quot;</span><span class="ot"> class=</span><span class="st">&quot;navbar-toggle navbar-toggle-context&quot;</span>
<span class="ot">              data-toggle=</span><span class="st">&quot;collapse&quot;</span><span class="ot"> data-target=</span><span class="st">&quot;.navbar-top-collapse&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;sr-only&quot;</span><span class="kw">&gt;</span>Toggle Navigation<span class="kw">&lt;/span&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;icon-bar&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;icon-bar&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;icon-bar&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
      <span class="kw">&lt;/button&gt;</span>
      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-brand-container&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> class=</span><span class="st">&quot;navbar-brand&quot;</span><span class="kw">&gt;</span>
          <span class="kw">&lt;h1&gt;&lt;i</span><span class="ot"> class=</span><span class="st">&quot;fa fa-star&quot;</span><span class="kw">&gt;&lt;/i&gt;</span> Book Me!<span class="kw">&lt;/h1&gt;</span>
        <span class="kw">&lt;/span&gt;</span>
      <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;collapse navbar-collapse navbar-top-collapse&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-right&quot;</span><span class="kw">&gt;</span>
        {{#if session.isAuthenticated}}
          <span class="kw">&lt;a</span> <span class="er">{{action</span> <span class="er">(route-action</span> <span class="er">&#39;logOut&#39;)}}</span><span class="ot"> data-test-logout-link</span>
<span class="ot">            class=</span><span class="st">&quot;btn btn-primary navbar-btn&quot;</span><span class="kw">&gt;</span>Logout<span class="kw">&lt;/a&gt;</span>
        {{else}}
          {{link-to &quot;Sign up&quot; &quot;signup&quot; data-test-signup-link
            class=&quot;btn btn-primary navbar-btn&quot;}}
          {{link-to &quot;Login&quot; &quot;login&quot; data-test-login-link
            class=&quot;btn btn-primary navbar-btn&quot;}}
        {{/if}}
      <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;/div&gt;</span>
  <span class="kw">&lt;/div&gt;</span>
<span class="kw">&lt;/nav&gt;</span>
<span class="kw">&lt;section</span><span class="ot"> class=</span><span class="st">&quot;main-content&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;sheet&quot;</span><span class="kw">&gt;</span>
    {{outlet}}
  <span class="kw">&lt;/div&gt;</span>
<span class="kw">&lt;/section&gt;</span>

{{ember-notify messageStyle=&#39;bootstrap&#39;}}</code></pre></td></tr></table></div>
<p>Writing acceptance tests checking if the notification is displayed would be too much - displaying a notification after a rental gets deleted is not a business-critical feature. It’s much better to just check in the UI if the notifications are displayed nicely and then, only write integration or unit tests.</p>
<p>Since we want to display some notification after a rental gets deleted, let’s extend the integration test for <code>delete-rental-button</code> component:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/component/delete-rental-button-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> wait <span class="im">from</span> <span class="st">&#39;ember-test-helpers/wait&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
  RSVP<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;delete-rental-button&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component |</span>
  <span class="kw">delete</span> rental button<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it deletes rental by holding a button&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>

  <span class="kw">const</span> notifyStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Service</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">info</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;notification should be displayed&#39;</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">register</span>(<span class="st">&#39;service:notify&#39;</span><span class="op">,</span> notifyStub)<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">inject</span>.<span class="at">service</span>(<span class="st">&#39;notify&#39;</span>)<span class="op">;</span>

  <span class="kw">const</span> rentalStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">destroyRecord</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;item should be destroyed&#39;</span>)<span class="op">;</span>

      <span class="cf">return</span> <span class="va">RSVP</span>.<span class="at">resolve</span>(<span class="kw">this</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>)<span class="op">;</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> rentalStub)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{delete-rental-button rental=rental}}`</span>)<span class="op">;</span>

  <span class="kw">const</span> $deleteBtn <span class="op">=</span> <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;delete-rental&#39;</span>))<span class="op">;</span>
  <span class="kw">const</span> done <span class="op">=</span> <span class="va">assert</span>.<span class="at">async</span>()<span class="op">;</span>

  <span class="va">$deleteBtn</span>.<span class="at">mousedown</span>()<span class="op">;</span>

  <span class="at">wait</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">done</span>()<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We are creating a stub of the <code>notify</code> service where we do perform another assertion in <code>info</code> method to make sure it gets called; we are registering this service and injecting it. The implementation to make this test pass is going to be quite straightforward:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/delete-rental-button.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> resolveDelay <span class="im">from</span> <span class="st">&#39;book-me/utilities/resolve-delay&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  inject<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">delay</span><span class="op">:</span> <span class="at">resolveDelay</span>(<span class="dv">3000</span>)<span class="op">,</span>
  <span class="dt">notify</span><span class="op">:</span> <span class="va">inject</span>.<span class="at">service</span>()<span class="op">,</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">deleteRental</span>() <span class="op">{</span>
      <span class="kw">const</span> rental <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

      <span class="va">rental</span>.<span class="at">destroyRecord</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="kw">const</span> notify <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;notify&#39;</span>)<span class="op">;</span>

        <span class="va">notify</span>.<span class="at">info</span>(<span class="st">&#39;Rental is deleted&#39;</span>)<span class="op">;</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And all tests are again green!</p>
<p>That would be all for rentals’ CRUD. There are obviously few more things that could make a nice improvement - we could, for example, disable submit buttons until the changeset is valid, we could implement rollback / reset buttons or delete a rental from memory in <code>rentals/new</code> route when exiting the route without persisting the rental, but at this point I’m pretty sure you will be able to TDD those features without any problems :).</p>
<p>If you are curious about the visual side of the features we delivered, here are some screenshots:</p>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/book_me_03.png" alt="Create rental" />
<p class="caption">Create rental</p>
</div>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/book_me_04.png" alt="Admin" />
<p class="caption">Admin</p>
</div>
<p>As you can see the <code>Delete</code> button doesn’t look perfect, but TDD-ing CSS is outside of the scope of this book ;).</p>
<p>Let’s move to the final and the most interesting feature we are going to implement: the calendar.</p>
<p></p>
<h3 id="the-calendar">The Calendar</h3>
<p>As already discussed earlier, we are going to take advantage of <code>ember-power-calendar</code>. Let’s install this powerful addon now:</p>
<pre><code>ember install ember-power-calendar</code></pre>
<p>The addon comes also with some stylesheets. To make the calendars look better we can include them as well:</p>
<pre class="scss"><code>/* book-me/app/styles/app.scss */
@import &quot;ember-power-select&quot;;
@import &quot;ember-modal-dialog/ember-modal-structure&quot;;
@import &quot;bootstrap-bookingsync&quot;;
@import &quot;ember-power-calendar&quot;;</code></pre>
<p>However, before moving on to playing with a calendar, let’s populate in-memory “database” for development to make the interaction with app better instead of creating all the rentals manually.</p>
<p>We will start with generating an ember-cli-mirage <code>rental factory</code>:</p>
<pre><code>ember g mirage-factory rental</code></pre>
<p>If we are already on generating factories, we may generate one for user model to be able to use the sign in right away when opening the app, without signing up in the first place to create a user:</p>
<pre><code>ember g mirage-factory user</code></pre>
<p>For rentals, we need to have some unique and random <code>name</code>s and some integer <code>daily rate</code>s. We will take advantage of sequence number which is an optional argument for attributes and use <code>faker</code> to generate random numbers for rates:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/mirage/factories/rental.js</span>
<span class="im">import</span> <span class="op">{</span> Factory<span class="op">,</span> faker <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">name</span>(i) <span class="op">{</span>
    <span class="cf">return</span> <span class="vs">`Rental </span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">`</span><span class="op">;</span>
  <span class="op">},</span>

  <span class="at">dailyRate</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="va">faker</span>.<span class="va">random</span>.<span class="at">number</span>()<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>We are going to have a pretty similar setup for <code>user</code>s with unique <code>email</code>s and hardcoded <code>password</code>s, just to make it easier to sign in:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/mirage/factories/user.js</span>
<span class="im">import</span> <span class="op">{</span> Factory <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-mirage&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Factory</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">email</span>(i) <span class="op">{</span>
    <span class="cf">return</span> <span class="vs">`example_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">@gmail.com`</span><span class="op">;</span>
  <span class="op">},</span>

  <span class="at">password</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="vs">`password123`</span><span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Since we want to have the rentals and users available right away during the development, let’s seed the <code>database</code> with 10 <code>rental</code>s and one <code>user</code>:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/mirage/scenarios/default.js</span>
<span class="im">export</span> <span class="im">default</span> <span class="kw">function</span>(server) <span class="op">{</span>
  <span class="va">server</span>.<span class="at">createList</span>(<span class="st">&#39;rental&#39;</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>

  <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;email@example.com&#39;</span><span class="op">,</span> <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;password123&#39;</span> <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>Now that we’ve made a helpful setup, we can focus on the calendar itself and what we want to do with it. There is one particularly interesting section in the docs of the addon about <a href="http://www.ember-power-calendar.com/docs/range-selection">range selection</a> which is exactly what we need - the booking will have <code>beginsAt</code> and <code>finishesAt</code> attributes which can be easily populated from the selected range. To make it possible, we will just display a calendar in <code>rental/show</code> template where we will be able to select the dates for a new booking.</p>
<p>Another thing to consider is: what is going to happen next? We also need to provide input for <code>clientEmail</code> attribute. It would also be nice to display the actual length of stay for the booking and its price that is going to be calculated based on this length of stay and rental’s <code>dailyRate</code> value.</p>
<p>To achieve all those things and to provide a nice UX, we are going to display a modal after selecting the range on a calendar with the form to fill other fields and display the required info.</p>
<p>An excellent choice for modals in Ember ecosystem is <code>ember-modal-dialog</code> which provides flexible API and is easy to use. And it’s based on <code>ember-wormhole</code> addon, which has a pretty awesome name. Let’s install the addon now:</p>
<pre><code>ember install ember-modal-dialog</code></pre>
<p>To make the UI nice we can also add some stylesheets provided by the addon:</p>
<pre class="scss"><code>/* book-me/app/styles/app.scss */
@import &quot;ember-power-select&quot;;
@import &quot;ember-modal-dialog/ember-modal-structure&quot;;
@import &quot;bootstrap-bookingsync&quot;;
@import &quot;ember-power-calendar&quot;;
@import &quot;ember-modal-dialog/ember-modal-structure&quot;;
@import &quot;ember-modal-dialog/ember-modal-appearance&quot;;</code></pre>
<p>Just like with every feature we’ve implemented so far, we are going to start with an acceptance test. Initially, we will keep it pretty simple: what we want to test is that we can go to admin page, click on the link to go to <code>rental/show</code> route, select same dates range on calendar, fill in <code>clientEmail</code>, click some button and verify that a new booking gets displayed and that it actually gets created by checking the outgoing request and its payload. Let’s generate a new acceptance test:</p>
<pre><code>ember g acceptance-test create-booking</code></pre>
<p>The next step would be writing a test cover the just mentioned scenario:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/create-booking-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> authenticateSession<span class="op">,</span> <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/ember-simple-auth&#39;</span><span class="op">;</span>
<span class="im">import</span> page <span class="im">from</span> <span class="st">&#39;book-me/tests/pages/create-booking&#39;</span><span class="op">;</span>
<span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | create booking&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">const</span> user <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span>
    <span class="at">authenticateSession</span>(<span class="kw">this</span>.<span class="at">application</span><span class="op">,</span> <span class="op">{</span> <span class="dt">user_id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;creating a booking for rental&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">3</span>)<span class="op">;</span>

  <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="dv">100</span><span class="op">;</span>
  <span class="kw">const</span> rental <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;rental&#39;</span><span class="op">,</span> <span class="op">{</span> dailyRate <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> clientEmail <span class="op">=</span> <span class="st">&#39;client@email.com&#39;</span><span class="op">;</span>
  <span class="kw">const</span> today <span class="op">=</span> <span class="at">moment</span>()<span class="op">;</span>
  <span class="kw">const</span> currentMonth <span class="op">=</span> <span class="va">today</span>.<span class="at">month</span>() <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// month are indexed starting from 0</span>
  <span class="kw">const</span> startDay <span class="op">=</span> <span class="dv">10</span><span class="op">;</span>
  <span class="kw">const</span> endDay <span class="op">=</span> <span class="dv">20</span><span class="op">;</span>
  <span class="kw">const</span> price <span class="op">=</span> (endDay <span class="op">-</span> startDay) <span class="op">*</span> dailyRate<span class="op">;</span>

  page
    .<span class="at">visitAdmin</span>()
    .<span class="at">goToRentalPage</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;booking-row&#39;</span>)).<span class="at">length</span><span class="op">,</span> <span class="st">&#39;no bookings should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/bookings&#39;</span><span class="op">,</span> <span class="kw">function</span>(schema) <span class="op">{</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span>
      <span class="dt">rentalId</span><span class="op">:</span> <span class="va">rental</span>.<span class="at">id</span><span class="op">,</span>
      clientEmail<span class="op">,</span>
      price<span class="op">,</span>
      <span class="dt">beginsAt</span><span class="op">:</span> <span class="vs">`2017-0</span><span class="sc">${</span>currentMonth<span class="sc">}</span><span class="vs">-</span><span class="sc">${</span>startDay<span class="sc">}</span><span class="vs">T14:00:00.000Z`</span><span class="op">,</span>
      <span class="dt">finishesAt</span><span class="op">:</span> <span class="vs">`2017-0</span><span class="sc">${</span>currentMonth<span class="sc">}</span><span class="vs">-</span><span class="sc">${</span>endDay<span class="sc">}</span><span class="vs">T10:00:00.000Z`</span><span class="op">,</span>
    <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">schema</span>.<span class="va">rentals</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">selectStartDate</span>(startDay)
    .<span class="at">selectEndDate</span>(endDay)
    .<span class="at">fillInClientEmail</span>(clientEmail)
    .<span class="at">createNewBooking</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;booking-row&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;bookings should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>There are some interesting things going on in this test. The beginning is pretty straight-forward - authentication of the user and variables’ setup. However, there is one surprise when it comes to the months - in JavaScript, months are indexed from <strong>0</strong>! So, e.g., January will not be <code>1</code> but <code>0</code> instead! That’s why we are adding +1, just to have some reasonable number standing for the current month. Then, we are taking advantage of page object (which is not implemented yet) - we are visiting admin page and going to a rental page. In next step, we are verifying that no booking has been created or loaded yet. Another step is quite similar to what we did in other acceptance tests - we are intercepting a request and verifying if the params sent to <code>bookings</code> endpoint match the expected ones and simply creating a booking, just like the original implementation of the route handler from <code>ember-cli-mirage</code> does. What we are doing next is selecting start and end dates, filling in client’s email and creating a booking, which means simply submitting a form. The last step is checking that the new booking is displayed.</p>
<p>Now let’s generate the page object that we are using here since it’s not implemented yet:</p>
<pre><code>ember generate page-object create-booking</code></pre>
<p>Here is its implementation:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/pages/create-booking.js</span>
<span class="im">import</span> <span class="op">{</span>
  create<span class="op">,</span>
  clickable<span class="op">,</span>
  fillable<span class="op">,</span>
  visitable<span class="op">,</span>
  clickOnText<span class="op">,</span>
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-cli-page-object&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="at">create</span>(<span class="op">{</span>
  <span class="dt">visitAdmin</span><span class="op">:</span> <span class="at">visitable</span>(<span class="st">&#39;/admin&#39;</span>)<span class="op">,</span>
  <span class="dt">goToRentalPage</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;show-rental&#39;</span>))<span class="op">,</span>
  <span class="dt">selectStartDate</span><span class="op">:</span> <span class="at">clickOnText</span>(<span class="st">&#39;button&#39;</span><span class="op">,</span>
    <span class="op">{</span> <span class="dt">scope</span><span class="op">:</span> <span class="at">testSelector</span>(<span class="st">&#39;new-booking-calendar&#39;</span>) <span class="op">}</span>)<span class="op">,</span>
  <span class="dt">selectEndDate</span><span class="op">:</span> <span class="at">clickOnText</span>(<span class="st">&#39;button&#39;</span><span class="op">,</span>
    <span class="op">{</span> <span class="dt">scope</span><span class="op">:</span> <span class="at">testSelector</span>(<span class="st">&#39;new-booking-calendar&#39;</span>) <span class="op">}</span>)<span class="op">,</span>
  <span class="dt">fillInClientEmail</span><span class="op">:</span> <span class="at">fillable</span>(<span class="at">testSelector</span>(<span class="st">&#39;booking-client-email&#39;</span>))<span class="op">,</span>
  <span class="dt">createNewBooking</span><span class="op">:</span> <span class="at">clickable</span>(<span class="at">testSelector</span>(<span class="st">&#39;create-booking&#39;</span>))<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>There is a new one thing that comes particularly in handy here: <code>clickOnText</code> - this property allows to specify an element containing text that is later provided as an argument. In case of the calendar, we need <code>button</code> containing the number of the day in the month (which is going to be 10 for start date and 20 for end date). This might not be obvious, but if you’ve ever used <code>ember-power-calendar</code>, you’re probably familiar with the structure of the calendar. To make sure we are dealing with the right button in the proper scope, we are passing one explicitly as a <code>scope</code> option.</p>
<p>The next step would be generating some <code>rental/show</code> route, where we will display the rental info and its bookings. And we are also going to provide a calendar here for creating new bookings:</p>
<pre><code>ember g route rental/show</code></pre>
<p>The router should include a new <code>show</code> route:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/router.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> config <span class="im">from</span> <span class="st">&#39;./config/environment&#39;</span><span class="op">;</span>

<span class="kw">const</span> Router <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Router</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">location</span><span class="op">:</span> <span class="va">config</span>.<span class="at">locationType</span><span class="op">,</span>
  <span class="dt">rootURL</span><span class="op">:</span> <span class="va">config</span>.<span class="at">rootURL</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="va">Router</span>.<span class="at">map</span>(<span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;signup&#39;</span>)
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;login&#39;</span>)<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;new&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;rental&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/rentals/:rental_id&#39;</span> <span class="op">},</span> <span class="kw">function</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;edit&#39;</span>)<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;show&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> Router<span class="op">;</span></code></pre></td></tr></table></div>
<p>Here’s the route’s body that we will start with:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/ap/routes/rental/show.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Nothing surprising here - we are just grabbing a <code>rental</code> from, well, <code>rental</code> route and aliasing it on the controller.</p>
<p>Here’s the template’s body:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/rental/show.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>{{rental.name}}<span class="kw">&lt;/h2&gt;</span>

<span class="kw">&lt;table</span><span class="ot"> class=</span><span class="st">&#39;table table-border&#39;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;</span>
      <span class="kw">&lt;th&gt;</span>Begins At<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Finishes At<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Length of Stay<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Client Email<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Price<span class="kw">&lt;/th&gt;</span>
    <span class="kw">&lt;/tr&gt;</span>
  <span class="kw">&lt;/thead&gt;</span>
  <span class="kw">&lt;tbody&gt;</span>
    {{#each rental.bookings as |booking|}}
      <span class="kw">&lt;tr</span><span class="ot"> data-test-booking-row</span><span class="kw">&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.beginsAt}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.finishesAt}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.lengthOfStay}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.clientEmail}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.price}}<span class="kw">&lt;/td&gt;</span>
      <span class="kw">&lt;/tr&gt;</span>
    {{/each}}
  <span class="kw">&lt;/tbody&gt;</span>
<span class="kw">&lt;/table&gt;</span></code></pre></td></tr></table></div>
<p>We are just displaying rental’s name here and some properties like dates, booking’s price and client’s email. We are also showing the length of stay of the booking in days to make it more clear how many days are booked. This is going to be a custom computed property that will depend on <code>booking.beginsAt</code> and <code>booking.finishesAt</code> properties.</p>
<p>Obviously, this template won’t work so far as we don’t even have a <code>Booking</code> model, so let’s generate one:</p>
<pre><code>ember g model Booking</code></pre>
<p>Let’s also add <code>bookings</code> resource to <code>ember-cli-mirage</code> config:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/mirage/config.js</span>
<span class="im">export</span> <span class="im">default</span> <span class="kw">function</span>() <span class="op">{</span>
  <span class="co">// current logic</span>

  <span class="kw">this</span>.<span class="at">resource</span>(<span class="st">&#39;bookings&#39;</span>)<span class="op">;</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>The next step would be setting up relationships between <code>Rental</code> and <code>Booking</code> models and defining attributes. Since we will be dealing with dates here (<code>beginsAt</code> and <code>finishesAt</code> attributes), ideally we would wrap them with <code>moment</code>. Unfortunately, there are no out-of-box attribute transforms in Ember Data that would properly handle serialization and deserialization of the datetime attributes if we care about the timezones. But the good news is that we can easily add them by installing <code>ember-cli-moment-transform</code> addon:</p>
<pre><code>ember install ember-cli-moment-transform</code></pre>
<p>Thanks to that addon, we can use <code>moment-utc</code> transform in <code>Booking</code> model:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/models/booking.js</span>
<span class="im">import</span> DS <span class="im">from</span> <span class="st">&#39;ember-data&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Model<span class="op">,</span>
  attr<span class="op">,</span>
  belongsTo<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> DS<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">beginsAt</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;moment-utc&#39;</span>)<span class="op">,</span>
  <span class="dt">finishesAt</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;moment-utc&#39;</span>)<span class="op">,</span>
  <span class="dt">clientEmail</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;string&#39;</span>)<span class="op">,</span>
  <span class="dt">price</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;number&#39;</span>)<span class="op">,</span>

  <span class="dt">rental</span><span class="op">:</span> <span class="at">belongsTo</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Let’s also add <code>hasMany</code> bookings relationship to <code>Rental</code> model:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/models/rental.js</span>
<span class="im">import</span> DS <span class="im">from</span> <span class="st">&#39;ember-data&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Model<span class="op">,</span>
  attr<span class="op">,</span>
  hasMany<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> DS<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">name</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;string&#39;</span>)<span class="op">,</span>
  <span class="dt">dailyRate</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;number&#39;</span>)<span class="op">,</span>

  <span class="dt">bookings</span><span class="op">:</span> <span class="at">hasMany</span>(<span class="st">&#39;booking&#39;</span>)<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>If we are already dealing with models, let’s implement <code>lengthOfStay</code> property for bookings. The idea behind it is simple: we want to calculate some booked days based on <code>beginsAt</code> and <code>finishesAt</code> attributes. However, we need to keep in mind that those attributes are datetimes, not only dates, so we can easily end up with the case where, e.g., for one day stay we will get potential <code>lengthOfStay</code> value of 0 if the total time of the booking is less than 24h. Maybe technically it is less than one day (i.e., 24h), but in this domain, it must be counted as a one day. The simplest way to deal with it would be just subtracting dates without considering the time part. We can do that by setting time to 0 for both datetimes.</p>
<p>As you may have already guessed, we will start with a test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/tests/unit/models/booking-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForModel<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForModel</span>(<span class="st">&#39;booking&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Model | booking&#39;</span><span class="op">,</span> <span class="op">{</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;lengthOfStay returns number of days of stay&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> model <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-01 14:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-10 10:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">get</span>(model<span class="op">,</span> <span class="st">&#39;lengthOfStay&#39;</span>)<span class="op">,</span> <span class="dv">9</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>This example should be enough as it already illustrates the just mentioned edge case. Here is the implementation that will make this test happy:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/models/booking.js</span>
<span class="im">import</span> DS <span class="im">from</span> <span class="st">&#39;ember-data&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Model<span class="op">,</span>
  attr<span class="op">,</span>
  belongsTo<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> DS<span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  computed<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">beginsAt</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;moment-utc&#39;</span>)<span class="op">,</span>
  <span class="dt">finishesAt</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;moment-utc&#39;</span>)<span class="op">,</span>
  <span class="dt">clientEmail</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;string&#39;</span>)<span class="op">,</span>
  <span class="dt">price</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;number&#39;</span>)<span class="op">,</span>

  <span class="dt">rental</span><span class="op">:</span> <span class="at">belongsTo</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">,</span>

  <span class="dt">lengthOfStay</span><span class="op">:</span> <span class="at">computed</span>(<span class="st">&#39;beginsAt&#39;</span><span class="op">,</span> <span class="st">&#39;finishesAt&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span>
    <span class="kw">const</span> beginsAt <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;beginsAt&#39;</span>).<span class="at">clone</span>()<span class="op">;</span>
    <span class="kw">const</span> finishesAt <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;finishesAt&#39;</span>).<span class="at">clone</span>()<span class="op">;</span>

    <span class="cf">return</span> <span class="va">finishesAt</span>.<span class="at">set</span>(<span class="op">{</span> <span class="dt">hour</span><span class="op">:</span> <span class="dv">0</span> <span class="op">}</span>).<span class="at">diff</span>(<span class="va">beginsAt</span>.<span class="at">set</span>(<span class="op">{</span> <span class="dt">hour</span><span class="op">:</span> <span class="dv">0</span> <span class="op">}</span>)<span class="op">,</span> <span class="st">&#39;days&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>When dealing with <code>moment</code> objects and performing any modification to them (e.g., by using <code>set</code> method), it is highly recommended to <code>clone</code> any value before - operations such as <code>set</code> are mutable, so even when dealing with <code>lengthOfStay</code> which definitely looks like something that should be read-only operation, it would still modify <code>beginsAt</code> and <code>finishesAt</code> attributes and cause unexpected side effects and a real mess in your app.</p>
<p>We are actually missing a link to <code>rental/show</code> route, so let’s fix that and add it in <code>admin.hbs</code> template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/admin.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>Admin<span class="kw">&lt;/h2&gt;</span>

{{#link-to &#39;rentals.new&#39; data-test-add-rental class=&#39;btn btn-primary&#39;}}
  Add rental
{{/link-to}}

<span class="kw">&lt;table</span><span class="ot"> class=</span><span class="st">&#39;table table-border&#39;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;</span>
      <span class="kw">&lt;th&gt;</span>Name<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Daily Rate<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Actions<span class="kw">&lt;/th&gt;</span>
    <span class="kw">&lt;/tr&gt;</span>
  <span class="kw">&lt;/thead&gt;</span>
  <span class="kw">&lt;tbody&gt;</span>
    {{#each rentals as |rental|}}
      <span class="kw">&lt;tr</span><span class="ot"> data-test-rental-row</span><span class="kw">&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{link-to rental.name &quot;rental.show&quot; rental}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{rental.dailyRate}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>
          {{#link-to &#39;rental.edit&#39; rental data-test-edit-rental
            class=&#39;btn btn-primary&#39;}}
            Edit
          {{/link-to}}

          {{#link-to &#39;rental.show&#39; rental data-test-show-rental
            class=&#39;btn btn-primary&#39;}}
            Show
          {{/link-to}}

          {{delete-rental-button rental=rental}}
        <span class="kw">&lt;/td&gt;</span>
      <span class="kw">&lt;/tr&gt;</span>
    {{/each}}
  <span class="kw">&lt;/tbody&gt;</span>
<span class="kw">&lt;/table&gt;</span></code></pre></td></tr></table></div>
<p>Now that we get easily navigate to <code>rental/show</code> route, we can think of the subsequent step: a calendar. The cool thing is that we don’t need to do much here and we can almost reuse entire example from the <a href="http://www.ember-power-calendar.com/docs/range-selection">docs</a>:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/rental/show.hbs --&gt;</span>
<span class="kw">&lt;h2&gt;</span>{{rental.name}}<span class="kw">&lt;/h2&gt;</span>

<span class="kw">&lt;table</span><span class="ot"> class=</span><span class="st">&#39;table table-border&#39;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;thead&gt;</span>
    <span class="kw">&lt;tr&gt;</span>
      <span class="kw">&lt;th&gt;</span>Begins At<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Finishes At<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Length of Stay<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Client Email<span class="kw">&lt;/th&gt;</span>
      <span class="kw">&lt;th&gt;</span>Price<span class="kw">&lt;/th&gt;</span>
    <span class="kw">&lt;/tr&gt;</span>
  <span class="kw">&lt;/thead&gt;</span>
  <span class="kw">&lt;tbody&gt;</span>
    {{#each rental.bookings as |booking|}}
      <span class="kw">&lt;tr</span><span class="ot"> data-test-booking-row</span><span class="kw">&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.beginsAt}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.finishesAt}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.lengthOfStay}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.clientEmail}}<span class="kw">&lt;/td&gt;</span>
        <span class="kw">&lt;td&gt;</span>{{booking.price}}<span class="kw">&lt;/td&gt;</span>
      <span class="kw">&lt;/tr&gt;</span>
    {{/each}}
  <span class="kw">&lt;/tbody&gt;</span>
<span class="kw">&lt;/table&gt;</span>

{{#power-calendar-range
  data-test-new-booking-calendar
  selected=range
  onSelect=(action &#39;selectRange&#39; value=&#39;moment&#39;) as |calendar|}}
    {{calendar.nav}}
    {{calendar.days}}
{{/power-calendar-range}}

{{outlet}}</code></pre></td></tr></table></div>
<p>We are simply displaying a very basic calendar and providing <code>selectRange</code> action to be called when the selection changes. As we are dealing here with some controller variables, we are going to handle it with controller’s action, not route’s action. Even though controllers should be eventually replaced by routable components, it still seems more natural to use controllers instead of routes for such cases.</p>
<p>Also, <code>outlet</code> part should give you a hint what is going to happen next. The idea was to display a modal when the <code>beginsAt</code> and <code>finishesAt</code> dates are selected. Instead of dealing with some conditionals to resolve if we should show the modal or not, we are going to take advantage of Ember router - a modal will simply be placed in a new route: <code>rental/show/createBooking</code>. Not only is it simpler as it makes the state management easier, but it also provides a nice way to access this modal just by visiting a page with given URL. We will use query params here and keep the selected date range in the URL. We probably won’t share the URLs for creating bookings with anyone, so maybe this use case is a bit far-fetched; nevertheless, it’s a good practice in Ember to use its powerful router and URLs for such state management.</p>
<p>Let’s generate a controller now for <code>rental/show</code> route to handle <code>selectRange</code> action and general another route: <code>rental/show/createBooking</code>. Since we are going to deal with query params, we will need a controller for that route as well. Query params is a perfectly legit use case for using controllers, so we don’t have many alternatives here. Let’s generate those controllers and routes now:</p>
<pre><code>ember g controller rental/show
ember g controller rental/show/createBooking
ember g route rental/show/createBooking</code></pre>
<p>What should we put in <code>rental/show</code> controller? The first thing would be explicitly defining <code>range</code> property that we are passing as <code>selected</code> value to the calendar component, just to make it obvious what kind of data we are dealing with. The second thing would be obviously <code>selectRange</code> action. How should it work?</p>
<p>To answer this question, we need to think about <code>range</code> property. It is a simple JS object with two properties: <code>start</code> and <code>end</code>, which as you may have already guessed contain selected dates. In that case, we can check if both of those dates are selected. If they are, we can parse the dates with <code>moment</code> to make sure we are dealing with UTC time. Once we parse the data and have the formatted as something that would look reasonable as query params, we can transition to <code>rental.show.createBooking</code>.</p>
<p>However, before we do that, we need to add one more thing. Remember the acceptance test’s part where we were comparing expected attributes to be sent to <code>bookings</code> endpoint via POST request and the actual ones? The values of <code>startsAt</code> and <code>finishesAt</code> properties contained the time part. With <code>ember-power-calendar</code> we are only selecting with dates, so what can we do about time?</p>
<p>Just to keep things simple for the sake of example, let’s assume that one day the API will cover managing rentals’ <code>defaultArrivalHour</code> and <code>defaultDepartureHour</code> attributes, but for now, we will hardcode them in <code>Rental</code> model. Even though those are going to be super simple computed properties returning just some hardcoded values, it is still worth starting with a test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/models/rental-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForModel<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForModel</span>(<span class="st">&#39;rental&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Model | rental&#39;</span><span class="op">,</span> <span class="op">{</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;defaultArrivalHour returns 14&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> model <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">get</span>(model<span class="op">,</span> <span class="st">&#39;defaultArrivalHour&#39;</span>)<span class="op">,</span> <span class="dv">14</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;defaultDepartureHour returns 10&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> model <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">get</span>(model<span class="op">,</span> <span class="st">&#39;defaultDepartureHour&#39;</span>)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And here is the implementation that will make the tests happy:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/models/rental.js</span>
<span class="im">import</span> DS <span class="im">from</span> <span class="st">&#39;ember-data&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  Model<span class="op">,</span>
  attr<span class="op">,</span>
  hasMany<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> DS<span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  computed<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Model</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">name</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;string&#39;</span>)<span class="op">,</span>
  <span class="dt">dailyRate</span><span class="op">:</span> <span class="at">attr</span>(<span class="st">&#39;number&#39;</span>)<span class="op">,</span>

  <span class="dt">bookings</span><span class="op">:</span> <span class="at">hasMany</span>(<span class="st">&#39;booking&#39;</span>)<span class="op">,</span>

  <span class="dt">defaultArrivalHour</span><span class="op">:</span> <span class="at">computed</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">return</span> <span class="dv">14</span><span class="op">;</span>
  <span class="op">}</span>)<span class="op">,</span>

  <span class="dt">defaultDepartureHour</span><span class="op">:</span> <span class="at">computed</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">return</span> <span class="dv">10</span><span class="op">;</span>
  <span class="op">}</span>)<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>In <code>selectRange</code> action we will just take those values from the rental and set them as time parts on selected dates:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/contollers/rental/show.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Controller</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">range</span><span class="op">:</span> <span class="op">{</span>
    <span class="dt">start</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span>
    <span class="dt">end</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">selectRange</span>(range) <span class="op">{</span>
      <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;range&#39;</span><span class="op">,</span> range)<span class="op">;</span>

      <span class="cf">if</span> (<span class="va">range</span>.<span class="at">start</span> <span class="op">&amp;&amp;</span> <span class="va">range</span>.<span class="at">end</span>) <span class="op">{</span>
        <span class="kw">const</span> rental <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
        <span class="kw">const</span> start <span class="op">=</span> <span class="at">toUTCDate</span>(<span class="va">range</span>.<span class="at">start</span>).<span class="at">set</span>(<span class="op">{</span>
          <span class="dt">hour</span><span class="op">:</span> <span class="at">get</span>(rental<span class="op">,</span> <span class="st">&#39;defaultArrivalHour&#39;</span>)
        <span class="op">}</span>)<span class="op">;</span>
        <span class="kw">const</span> end <span class="op">=</span> <span class="at">toUTCDate</span>(<span class="va">range</span>.<span class="at">end</span>).<span class="at">set</span>(<span class="op">{</span>
          <span class="dt">hour</span><span class="op">:</span> <span class="at">get</span>(rental<span class="op">,</span> <span class="st">&#39;defaultDepartureHour&#39;</span>)
        <span class="op">}</span>)<span class="op">;</span>
        <span class="kw">this</span>.<span class="at">transitionToRoute</span>(<span class="st">&#39;rental.show.createBooking&#39;</span><span class="op">,</span> rental<span class="op">,</span> <span class="op">{</span>
          <span class="dt">queryParams</span><span class="op">:</span> <span class="op">{</span>
            <span class="dt">start</span><span class="op">:</span> <span class="va">start</span>.<span class="at">format</span>()<span class="op">,</span>
            <span class="dt">end</span><span class="op">:</span> <span class="va">end</span>.<span class="at">format</span>()<span class="op">,</span>
          <span class="op">}</span>
        <span class="op">}</span>)<span class="op">;</span>
      <span class="op">}</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="kw">function</span> <span class="at">toUTCDate</span>(date) <span class="op">{</span>
  <span class="cf">return</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="va">date</span>.<span class="at">format</span>(<span class="st">&#39;YYYY-MM-DD&#39;</span>))<span class="op">;</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>To make sure that the time part is getting set on UTC date attribute and not a local date, we are introducing <code>toUTCDate</code> helper function - managing dates in JavaScript is pretty inconvenient and even <code>moment</code> doesn’t necessarily solve all possible problems with dates.</p>
<p>You might be wondering if we shouldn’t maybe start with the unit test before writing <code>selectRange</code> action and if that’s compatible with TDD flow. The answer is not that simple. To me, such things are just implementation details, and the logic is already covered by the acceptance test. For more complex scenarios I would probably write a unit test to make sure every possible edge case is handled. It might still be considered as an implementation detail, but testing different scenarios on a unit level is simply faster and easier.</p>
<p>We can move on now to <code>createBooking</code> route and controller. The router should be updated by running the generator, but just to double check if it’s right, this is how it should be looking like now:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/router.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> config <span class="im">from</span> <span class="st">&#39;./config/environment&#39;</span><span class="op">;</span>

<span class="kw">const</span> Router <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Router</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">location</span><span class="op">:</span> <span class="va">config</span>.<span class="at">locationType</span><span class="op">,</span>
  <span class="dt">rootURL</span><span class="op">:</span> <span class="va">config</span>.<span class="at">rootURL</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="va">Router</span>.<span class="at">map</span>(<span class="kw">function</span>() <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;signup&#39;</span>)
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;login&#39;</span>)<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;admin&#39;</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;rentals&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;new&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;rental&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/rentals/:rental_id&#39;</span> <span class="op">},</span> <span class="kw">function</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;edit&#39;</span>)<span class="op">;</span>
    <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;show&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span>
      <span class="kw">this</span>.<span class="at">route</span>(<span class="st">&#39;createBooking&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> Router<span class="op">;</span></code></pre></td></tr></table></div>
<p>Since the controller will be super simple as it is going to be responsible merely for managing <code>start</code> and <code>end</code> query params, let’s start with the controller:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/controllers/rental/show/create-booking.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Controller</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">queryParams</span><span class="op">:</span> [<span class="st">&#39;start&#39;</span><span class="op">,</span> <span class="st">&#39;end&#39;</span>]<span class="op">,</span>
  <span class="dt">start</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span>
  <span class="dt">end</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Again, we are not writing any new tests here as this functionality is indirectly covered by acceptance tests and having unit tests for such code wouldn’t bring many benefits either - query params don’t really have much sense in isolation, so it’s very similar to testing, e.g. <code>model</code> or <code>setupController</code> hooks which are just minor implementation details of something much bigger.</p>
<p>Let’s move to the route now. This part is going to be far more complex, which means it will also be quite fun. There a couple of things this route should be responsible for. The obvious one would be setting up a new booking model. This booking should belong to a rental (which we can easily grab from the <code>rental</code> route, thanks to the awesome routing in Ember). Since both <code>beginsAt</code> and <code>finishesAt</code> dates are available in the query params, we can just parse them with <code>moment</code> and populate in <code>booking</code> model. We also need two more things: <code>price</code> and <code>client email</code>. For the email we will provide a separate input but what about <code>price</code>?</p>
<p>The cool thing is that we already have <code>lengthOfStay</code> computed property available in the model and the price depends exclusively on the length of stay and rental’s daily rate, which can be easily taken from the model. In this case, in <code>model</code> hook we can just set up the model with populated dates, calculate the price, assign it and return the model.</p>
<p>There are also some other things that will be going on here. The route itself is named <code>createBooking</code> so one may expect that it will be responsible for persistence. Since the route is clearly the data owner, it will implement some action that would persist the booking.</p>
<p>Remember the idea how the form for persisting bookings should look like? It was supposed to be displayed inside a modal. And this is exactly what we will do in the template. Also, modals usually have some button for closing them. We are going to implement something very similar, an action like <code>closeModal</code> which will call <code>deleteRecord</code> on <code>booking</code> model (to not leave any unpersisted leftovers) and then perform transition back to <code>rental.show</code> route. The same transition makes sense for the action persisting the <code>booking</code> so we will do the same upon the successful persistence request.</p>
<p>The transition part is not covered by our acceptance test, so we will add it now:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/acceptance/create-booking-test.js</span>
<span class="co">/* global server */</span>
<span class="im">import</span> <span class="op">{</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> moduleForAcceptance <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/module-for-acceptance&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>
<span class="im">import</span> <span class="op">{</span> authenticateSession<span class="op">,</span> <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;book-me/tests/helpers/ember-simple-auth&#39;</span><span class="op">;</span>
<span class="im">import</span> page <span class="im">from</span> <span class="st">&#39;book-me/tests/pages/create-booking&#39;</span><span class="op">;</span>
<span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span>

<span class="at">moduleForAcceptance</span>(<span class="st">&#39;Acceptance | create booking&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="at">beforeEach</span>() <span class="op">{</span>
    <span class="kw">const</span> user <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span>
    <span class="at">authenticateSession</span>(<span class="kw">this</span>.<span class="at">application</span><span class="op">,</span> <span class="op">{</span> <span class="dt">user_id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">}</span>)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;creating a booking for rental&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">4</span>)<span class="op">;</span> <span class="co">// one more expectation</span>

  <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="dv">100</span><span class="op">;</span>
  <span class="kw">const</span> rental <span class="op">=</span> <span class="va">server</span>.<span class="at">create</span>(<span class="st">&#39;rental&#39;</span><span class="op">,</span> <span class="op">{</span> dailyRate <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> clientEmail <span class="op">=</span> <span class="st">&#39;client@email.com&#39;</span><span class="op">;</span>
  <span class="kw">const</span> today <span class="op">=</span> <span class="at">moment</span>()<span class="op">;</span>
  <span class="kw">const</span> currentMonth <span class="op">=</span> <span class="va">today</span>.<span class="at">month</span>() <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// month are indexed starting from 0</span>
  <span class="kw">const</span> startDay <span class="op">=</span> <span class="dv">10</span><span class="op">;</span>
  <span class="kw">const</span> endDay <span class="op">=</span> <span class="dv">20</span><span class="op">;</span>
  <span class="kw">const</span> price <span class="op">=</span> (endDay <span class="op">-</span> startDay) <span class="op">*</span> dailyRate<span class="op">;</span>

  page
    .<span class="at">visitAdmin</span>()
    .<span class="at">goToRentalPage</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;booking-row&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;no bookings should be visible&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="va">server</span>.<span class="at">post</span>(<span class="st">&#39;/bookings&#39;</span><span class="op">,</span> <span class="kw">function</span>(schema) <span class="op">{</span>
    <span class="kw">const</span> attributes <span class="op">=</span> <span class="kw">this</span>.<span class="at">normalizedRequestAttrs</span>()<span class="op">;</span>
    <span class="kw">const</span> expectedAttributes <span class="op">=</span> <span class="op">{</span>
      <span class="dt">rentalId</span><span class="op">:</span> <span class="va">rental</span>.<span class="at">id</span><span class="op">,</span>
      clientEmail<span class="op">,</span>
      price<span class="op">,</span>
      <span class="dt">beginsAt</span><span class="op">:</span> <span class="vs">`2017-0</span><span class="sc">${</span>currentMonth<span class="sc">}</span><span class="vs">-</span><span class="sc">${</span>startDay<span class="sc">}</span><span class="vs">T14:00:00.000Z`</span><span class="op">,</span>
      <span class="dt">finishesAt</span><span class="op">:</span> <span class="vs">`2017-0</span><span class="sc">${</span>currentMonth<span class="sc">}</span><span class="vs">-</span><span class="sc">${</span>endDay<span class="sc">}</span><span class="vs">T10:00:00.000Z`</span><span class="op">,</span>
    <span class="op">};</span>

    <span class="va">assert</span>.<span class="at">deepEqual</span>(attributes<span class="op">,</span> expectedAttributes<span class="op">,</span>
      <span class="st">&quot;attributes don&#39;t match the expected ones&quot;</span>)<span class="op">;</span>

    <span class="cf">return</span> <span class="va">schema</span>.<span class="va">rentals</span>.<span class="at">create</span>(attributes)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  page
    .<span class="at">selectStartDate</span>(startDay)
    .<span class="at">selectEndDate</span>(endDay)
    .<span class="at">fillInClientEmail</span>(clientEmail)
    .<span class="at">createNewBooking</span>()<span class="op">;</span>

  <span class="at">andThen</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">find</span>(<span class="at">testSelector</span>(<span class="st">&#39;booking-row&#39;</span>)).<span class="at">length</span><span class="op">,</span>
      <span class="st">&#39;bookings should be visible&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">equal</span>(<span class="at">currentURL</span>()<span class="op">,</span> <span class="vs">`/rentals/</span><span class="sc">${</span><span class="va">rental</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">/show`</span><span class="op">,</span>
      <span class="st">&#39;should transition back to rental/show route&#39;</span>)<span class="op">;</span> <span class="co">// new scenario</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Ok, let’s implement the route itself now, write a proper template and… make the acceptance test pass!</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rental/show/create-booking.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">model</span>(params) <span class="op">{</span>
    <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="at">get</span>(rental<span class="op">,</span> <span class="st">&#39;dailyRate&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> beginsAt <span class="op">=</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="va">params</span>.<span class="at">start</span>)<span class="op">;</span>
    <span class="kw">const</span> finishesAt <span class="op">=</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="va">params</span>.<span class="at">end</span>)<span class="op">;</span>
    <span class="kw">const</span> booking <span class="op">=</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">createRecord</span>(<span class="st">&#39;booking&#39;</span><span class="op">,</span> <span class="op">{</span>
      rental<span class="op">,</span>
      beginsAt<span class="op">,</span>
      finishesAt<span class="op">,</span>
    <span class="op">}</span>)<span class="op">;</span>

    <span class="kw">const</span> price <span class="op">=</span> <span class="at">get</span>(booking<span class="op">,</span> <span class="st">&#39;lengthOfStay&#39;</span>) <span class="op">*</span> dailyRate<span class="op">;</span>
    <span class="at">set</span>(booking<span class="op">,</span> <span class="st">&#39;price&#39;</span><span class="op">,</span>  price)<span class="op">;</span>

    <span class="cf">return</span> booking<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;booking&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">createBooking</span>(booking) <span class="op">{</span>
      <span class="va">booking</span>.<span class="at">save</span>().<span class="at">then</span>(<span class="kw">this</span>.<span class="va">_transitionToRentalRoute</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>

  <span class="at">_transitionToRentalRoute</span>() <span class="op">{</span>
    <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

    <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;rental.show&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/rental/show/create-booking.hbs --&gt;</span>
{{#modal-dialog targetAttachment=&#39;center&#39; translucentOverlay=true}}
  <span class="kw">&lt;h3&gt;</span>Create booking<span class="kw">&lt;/h3&gt;</span>

  <span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">(route-action</span> <span class="er">&#39;createBooking&#39;</span><span class="ot"> booking</span><span class="er">)</span><span class="ot"> on=</span><span class="st">&#39;submit&#39;</span><span class="er">}}</span><span class="kw">&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;booking-client-email&quot;</span><span class="kw">&gt;</span>Client Email<span class="kw">&lt;/label&gt;</span>
      {{input
        data-test-booking-client-email
        id=&quot;client-email&quot;
        value=(mut booking.clientEmail)
        class=&quot;form-control&quot;
      }}
    <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;button</span><span class="ot"> data-test-create-booking type=</span><span class="st">&quot;submit&quot;</span>
<span class="ot">      class=</span><span class="st">&quot;btn btn-primary&quot;</span><span class="kw">&gt;</span>Create booking<span class="kw">&lt;/button&gt;</span>
  <span class="kw">&lt;/form&gt;</span>
{{/modal-dialog}}</code></pre></td></tr></table></div>
<p>By saving this template, we made our final test acceptance test pass :).</p>
<p>The template is quite basic without much new stuff except <code>modal-dialog</code> component which provides the actual modal. We want modal to be positioned in the center and to have a translucent overlay, which we can easily configure. As you can see, model’s API is simple yet powerful. That is everything we need to handle this modal.</p>
<p>In route we’ve taken advantage of a pretty cool pattern - instead of providing an anonymous function for handling the success part of persisting a booking like this:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="va">booking</span>.<span class="at">save</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;rental.show&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>we passed <code>_transitionToRentalRoute</code> function, which arguably looks more readable. We also need to keep in mind that we are taking advantage of <code>this</code> in that function which we expect to be a <code>route</code> object. In such case, we need to <code>bind</code> the proper context, that’s why we are doing it as <code>this._transitionToRentalRoute.bind(this)</code> to make it work.</p>
<p>Here are the screenshots to illustrate what we’ve just achieve:</p>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/book_me_05.png" alt="Admin" />
<p class="caption">Admin</p>
</div>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/book_me_06.png" alt="Rental show with calendar" />
<p class="caption">Rental show with calendar</p>
</div>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/book_me_07.png" alt="Form in modal" />
<p class="caption">Form in modal</p>
</div>
<div class="figure">
<img src="http://download.karolgalanciak.com/test-driven-ember/book_me_08.png" alt="Persisted booking" />
<p class="caption">Persisted booking</p>
</div>
<p>Again, there are some issues and the UI is not perfect, but this is not something that we want to devote much time in this book.</p>
<p>Nevertheless, we are not finished yet; there are some still few interesting things we need to add:</p>
<ol style="list-style-type: decimal">
<li><p>Closing the modal and transitioning to <code>rental/show</code> route.</p></li>
<li><p>Deselecting range selection in calendar upon the successful persistence of a booking. The same behavior would make sense as well in point 1.</p></li>
<li><p>Validations. The obvious ones would be validating the numericality and presence of <code>price</code> and presence and format of <code>clientEmail</code>. However, there is one not that obvious - validation of the dates and making sure that there is no overlapping of any dates.</p></li>
</ol>
<p>For 3rd point, just like for previous use cases, we will generate a separate component to encapsulate the logic, so let’s do it now:</p>
<pre><code>ember g component create-booking-form</code></pre>
<p>Here’s the code for the component and its template to preserve the current behavior:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/create-booking-form.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">createBooking</span>() <span class="op">{</span>
      <span class="kw">const</span> booking <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;booking&#39;</span>)<span class="op">;</span>

      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onCreateBooking&#39;</span>)(booking)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/create-booking-form.hbs --&gt;</span>
<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&#39;createBooking&#39;</span><span class="ot"> on=</span><span class="st">&#39;submit&#39;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;booking-client-email&quot;</span><span class="kw">&gt;</span>Client Email<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-booking-client-email
      id=&quot;client-email&quot;
      value=(mut booking.clientEmail)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>

  <span class="kw">&lt;button</span><span class="ot"> data-test-create-booking type=</span><span class="st">&quot;submit&quot;</span>
<span class="ot">    class=</span><span class="st">&quot;btn btn-primary&quot;</span><span class="kw">&gt;</span>Create booking<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>And the updated version of the template of <code>rental/show/createBooking</code> route which takes advantage of <code>create-booking-form</code> component:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/rental/show/create-booking.hbs --&gt;</span>
{{#modal-dialog targetAttachment=&#39;center&#39; translucentOverlay=true}}
  <span class="kw">&lt;h3&gt;</span>Create booking<span class="kw">&lt;/h3&gt;</span>

  {{create-booking-form
    booking=booking
    onCreateBooking=(route-action &#39;createBooking&#39;)
  }}
{{/modal-dialog}}</code></pre></td></tr></table></div>
<p>Let’s start with point no. 1: “closing” the modal which will simply invoke a transition back to <code>rental/show</code> route and deselect calendar’s range.</p>
<p>One way to start this feature would be writing an acceptance test. The other way would be covering this functionality with unit tests. Obviously, the acceptance test would be more accurate, but it would also be slower. Closing a modal is not a business-critical feature, so it might be ok make it a bit simpler and just cover it with unit or integration tests, which maybe don’t provide 100% guarantee that the entire feature works (there is always a possibility that something in some layer may go wrong), but gives enough confidence that we might assume that as long as those tests pass, the feature works just fine.</p>
<p>Let’s start with a route’s action test. We will implement an action called <code>closeModal</code>. The idea behind it is simple: we want to <code>deleteRecord</code> to not leave any leftovers, reset calendar’s <code>range</code> and transition back to <code>rental/show</code> route. Here’s the test:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rental/show/create-booking-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;route:rental/show/create-booking&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route |</span>
  rental/show/create booking<span class="st">&#39;, {</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&quot;closeModal action deletes booking record, resets calendar&#39;s range and</span>
  peforms transition to <span class="vs">`rental/show`</span> route<span class="st">&quot;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">4</span>)<span class="op">;</span>

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="kw">const</span> controllerStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">resetRange</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;resetRange should be called&#39;</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> rentalStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> bookingStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">deleteRecord</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;deleteRecord should be called&#39;</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>()<span class="op">;</span>

  <span class="va">route</span>.<span class="at">controllerFor</span> <span class="op">=</span> (name) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;rental.show&#39;</span>) <span class="op">{</span>
      <span class="cf">return</span> controllerStub<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
  <span class="va">route</span>.<span class="at">modelFor</span> <span class="op">=</span> (name) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;rental&#39;</span>) <span class="op">{</span>
      <span class="cf">return</span> rentalStub<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
  <span class="va">route</span>.<span class="at">transitionTo</span> <span class="op">=</span> (routeName<span class="op">,</span> rentalArgument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(routeName<span class="op">,</span> <span class="st">&#39;rental.show&#39;</span><span class="op">,</span>
      <span class="st">&#39;should transition to rental.show route&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(rentalArgument<span class="op">,</span> rentalStub<span class="op">,</span>
      <span class="st">&#39;should be called with proper argument&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="va">route</span>.<span class="va">actions</span>.<span class="va">closeModal</span>.<span class="at">bind</span>(route)(bookingStub)<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>This test is far from perfect. A lot of stubs and seems almost like coupling to some very specific implementation. But you need to keep in mind that testing is about having a right level of confidence, so some aspects might depend on preference. If such unit testing is ok for you then great. If not, you still have other options, like writing acceptance test to cover this case, which is not necessarily worse.</p>
<p>The flow of the test is quite simple - verifying if the right methods are called with the expected arguments. We are also stubbing two methods on the route itself which might not be the best idea in most cases since stubbing object under the test is considered an anti-pattern (and for the right reason), but here it doesn’t bring many issues and really helps to test this action.</p>
<p>Here is our implementation:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rental/show.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">model</span>(params) <span class="op">{</span>
    <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="at">get</span>(rental<span class="op">,</span> <span class="st">&#39;dailyRate&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> beginsAt <span class="op">=</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="va">params</span>.<span class="at">start</span>)<span class="op">;</span>
    <span class="kw">const</span> finishesAt <span class="op">=</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="va">params</span>.<span class="at">end</span>)<span class="op">;</span>
    <span class="kw">const</span> booking <span class="op">=</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">createRecord</span>(<span class="st">&#39;booking&#39;</span><span class="op">,</span> <span class="op">{</span>
      rental<span class="op">,</span>
      beginsAt<span class="op">,</span>
      finishesAt<span class="op">,</span>
    <span class="op">}</span>)<span class="op">;</span>

    <span class="kw">const</span> price <span class="op">=</span> <span class="at">get</span>(booking<span class="op">,</span> <span class="st">&#39;lengthOfStay&#39;</span>) <span class="op">*</span> dailyRate<span class="op">;</span>
    <span class="at">set</span>(booking<span class="op">,</span> <span class="st">&#39;price&#39;</span><span class="op">,</span>  price)<span class="op">;</span>

    <span class="cf">return</span> booking<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;booking&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">closeModal</span>(booking) <span class="op">{</span>
      <span class="va">booking</span>.<span class="at">deleteRecord</span>()<span class="op">;</span>

      <span class="kw">this</span>.<span class="at">_transitionToRentalRoute</span>(<span class="kw">this</span>)<span class="op">;</span>
    <span class="op">},</span>

    <span class="at">createBooking</span>(booking) <span class="op">{</span>
      <span class="va">booking</span>.<span class="at">save</span>().<span class="at">then</span>(<span class="kw">this</span>.<span class="va">_transitionToRentalRoute</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>

  <span class="at">_transitionToRentalRoute</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">controllerFor</span>(<span class="st">&#39;rental.show&#39;</span>).<span class="at">resetRange</span>()<span class="op">;</span>

    <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

    <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;rental.show&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>Since the same thing happens after successfully persisting a booking, let’s also write a test to cover <code>createBooking</code> action:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rental/show/create-booking-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  RSVP<span class="op">,</span>
  run<span class="op">,</span>
  computed<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;route:rental/show/create-booking&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route |</span>
  rental/show/create booking<span class="st">&#39;, {</span>
  needs<span class="op">:</span> [<span class="st">&#39;service:session&#39;</span>]<span class="op">,</span>
})<span class="op">;</span>

<span class="co">// previous test</span>

<span class="at">test</span>(<span class="st">&quot;createBooking action creates booking, resets calendar&#39;s range and</span>
  peforms transition to <span class="vs">`rental/show`</span> route<span class="st">&quot;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">4</span>)<span class="op">;</span>

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="kw">const</span> controllerStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">resetRange</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;resetRange should be called&#39;</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> rentalStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> bookingStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">save</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;save should be called&#39;</span>)<span class="op">;</span>
      <span class="cf">return</span> <span class="va">RSVP</span>.<span class="at">resolve</span>()<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>()<span class="op">;</span>

  <span class="va">route</span>.<span class="at">controllerFor</span> <span class="op">=</span> (name) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;rental.show&#39;</span>) <span class="op">{</span>
      <span class="cf">return</span> controllerStub<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
  <span class="va">route</span>.<span class="at">modelFor</span> <span class="op">=</span> (name) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;rental&#39;</span>) <span class="op">{</span>
      <span class="cf">return</span> rentalStub<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
  <span class="va">route</span>.<span class="at">transitionTo</span> <span class="op">=</span> (routeName<span class="op">,</span> rentalArgument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(routeName<span class="op">,</span> <span class="st">&#39;rental.show&#39;</span><span class="op">,</span>
      <span class="st">&#39;should transition to rental.show route&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(rentalArgument<span class="op">,</span> rentalStub<span class="op">,</span>
      <span class="st">&#39;should be called with proper argument&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">run</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">route</span>.<span class="va">actions</span>.<span class="va">createBooking</span>.<span class="at">bind</span>(route)(bookingStub)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>The test is quite similar, but there is one major difference - we are wrapping the method call inside <code>Ember.run</code> function, to avoid any potential surprises with promises and their async nature.</p>
<p>Since there are a lot of duplications in this file, you might be wondering about DRYing the tests. Personally, I’m not a big fan DRY in tests. The readability and expressiveness are essential in testing and we lose both of them when we attempt to extract some parts. I don’t really do it unless the benefits are substantial. Herem it would make a small difference, so it’s ok to leave those tests as they are.</p>
<p>There is also one more thing that should be added to both <code>rental/show</code> and <code>rental/show/createBooking</code> routes: authentication. We are going to reuse the same code as for other routes. Obviously, we will start with tests:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rental/show/create-booking-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  RSVP<span class="op">,</span>
  run<span class="op">,</span>
  computed<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;route:rental/show/create-booking&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route |</span>
  rental/show/create booking<span class="st">&#39;, {</span>
  needs<span class="op">:</span> [<span class="st">&#39;service:session&#39;</span>]<span class="op">,</span> <span class="co">// required for other tests</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&quot;closeModal action deletes booking record, resets calendar&#39;s</span>
  range and peforms transition to <span class="vs">`rental/show`</span> route<span class="st">&quot;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">4</span>)<span class="op">;</span>

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="kw">const</span> controllerStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">resetRange</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;resetRange should be called&#39;</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> rentalStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> bookingStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">deleteRecord</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;deleteRecord should be called&#39;</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>()<span class="op">;</span>

  <span class="va">route</span>.<span class="at">controllerFor</span> <span class="op">=</span> (name) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;rental.show&#39;</span>) <span class="op">{</span>
      <span class="cf">return</span> controllerStub<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
  <span class="va">route</span>.<span class="at">modelFor</span> <span class="op">=</span> (name) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;rental&#39;</span>) <span class="op">{</span>
      <span class="cf">return</span> rentalStub<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
  <span class="va">route</span>.<span class="at">transitionTo</span> <span class="op">=</span> (routeName<span class="op">,</span> rentalArgument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(routeName<span class="op">,</span> <span class="st">&#39;rental.show&#39;</span><span class="op">,</span>
      <span class="st">&#39;should transition to rental.show route&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(rentalArgument<span class="op">,</span> rentalStub<span class="op">,</span>
      <span class="st">&#39;should be called with proper argument&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="va">route</span>.<span class="va">actions</span>.<span class="va">closeModal</span>.<span class="at">bind</span>(route)(bookingStub)<span class="op">;</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&quot;createBooking action creates booking, resets calendar&#39;s range and</span>
  peforms transition to <span class="vs">`rental/show`</span> route<span class="st">&quot;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">4</span>)<span class="op">;</span>

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="kw">const</span> controllerStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">resetRange</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;resetRange should be called&#39;</span>)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> rentalStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> bookingStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="at">save</span>() <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;save should be called&#39;</span>)<span class="op">;</span>
      <span class="cf">return</span> <span class="va">RSVP</span>.<span class="at">resolve</span>()<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">}</span>).<span class="at">create</span>()<span class="op">;</span>

  <span class="va">route</span>.<span class="at">controllerFor</span> <span class="op">=</span> (name) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;rental.show&#39;</span>) <span class="op">{</span>
      <span class="cf">return</span> controllerStub<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
  <span class="va">route</span>.<span class="at">modelFor</span> <span class="op">=</span> (name) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;rental&#39;</span>) <span class="op">{</span>
      <span class="cf">return</span> rentalStub<span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
  <span class="va">route</span>.<span class="at">transitionTo</span> <span class="op">=</span> (routeName<span class="op">,</span> rentalArgument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">equal</span>(routeName<span class="op">,</span> <span class="st">&#39;rental.show&#39;</span><span class="op">,</span>
      <span class="st">&#39;should transition to rental.show route&#39;</span>)<span class="op">;</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(rentalArgument<span class="op">,</span> rentalStub<span class="op">,</span>
      <span class="st">&#39;should be called with proper argument&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">run</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">route</span>.<span class="va">actions</span>.<span class="va">createBooking</span>.<span class="at">bind</span>(route)(bookingStub)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
})<span class="op">;</span>

<span class="co">// new test</span>

<span class="at">test</span>(<span class="st">&#39;it requires authentication&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> sessionStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Service</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="dt">isAuthenticated</span><span class="op">:</span> <span class="at">computed</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;isAuthenticated has to be used for checking authentication&#39;</span>)<span class="op">;</span>

      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
    <span class="op">}</span>)<span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">register</span>(<span class="st">&#39;service:session&#39;</span><span class="op">,</span> sessionStub)<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">inject</span>.<span class="at">service</span>(<span class="st">&#39;session&#39;</span>)<span class="op">;</span>

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="va">route</span>.<span class="at">beforeModel</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/routes/rental/show-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleFor<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span>

<span class="kw">const</span> <span class="op">{</span>
  computed<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleFor</span>(<span class="st">&#39;route:rental/show&#39;</span><span class="op">,</span> <span class="st">&#39;Unit | Route | rental/show&#39;</span><span class="op">,</span> <span class="op">{</span>
  <span class="dt">needs</span><span class="op">:</span> [<span class="st">&#39;service:session&#39;</span>]<span class="op">,</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="co">// new test</span>

<span class="at">test</span>(<span class="st">&#39;it requires authentication&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> sessionStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Service</span>.<span class="at">extend</span>(<span class="op">{</span>
    <span class="dt">isAuthenticated</span><span class="op">:</span> <span class="at">computed</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="va">assert</span>.<span class="at">ok</span>(<span class="kw">true</span><span class="op">,</span> <span class="st">&#39;isAuthenticated has to be used for checking authentication&#39;</span>)<span class="op">;</span>

      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
    <span class="op">}</span>)<span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">register</span>(<span class="st">&#39;service:session&#39;</span><span class="op">,</span> sessionStub)<span class="op">;</span>
  <span class="kw">this</span>.<span class="va">inject</span>.<span class="at">service</span>(<span class="st">&#39;session&#39;</span>)<span class="op">;</span>

  <span class="kw">const</span> route <span class="op">=</span> <span class="kw">this</span>.<span class="at">subject</span>()<span class="op">;</span>

  <span class="va">route</span>.<span class="at">beforeModel</span>()<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>The implementation is going to be dead-simple: just extend the route with <code>AuthenticatedRouteMixin</code> mixin:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rental/show.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
  <span class="at">model</span>() <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rental/show/create-booking.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
  <span class="at">model</span>(params) <span class="op">{</span>
    <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="at">get</span>(rental<span class="op">,</span> <span class="st">&#39;dailyRate&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> beginsAt <span class="op">=</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="va">params</span>.<span class="at">start</span>)<span class="op">;</span>
    <span class="kw">const</span> finishesAt <span class="op">=</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="va">params</span>.<span class="at">end</span>)<span class="op">;</span>
    <span class="kw">const</span> booking <span class="op">=</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">createRecord</span>(<span class="st">&#39;booking&#39;</span><span class="op">,</span> <span class="op">{</span>
      rental<span class="op">,</span>
      beginsAt<span class="op">,</span>
      finishesAt<span class="op">,</span>
    <span class="op">}</span>)<span class="op">;</span>

    <span class="kw">const</span> price <span class="op">=</span> <span class="at">get</span>(booking<span class="op">,</span> <span class="st">&#39;lengthOfStay&#39;</span>) <span class="op">*</span> dailyRate<span class="op">;</span>
    <span class="at">set</span>(booking<span class="op">,</span> <span class="st">&#39;price&#39;</span><span class="op">,</span>  price)<span class="op">;</span>

    <span class="cf">return</span> booking<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;booking&#39;</span><span class="op">,</span> model)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">closeModal</span>(booking) <span class="op">{</span>
      <span class="va">booking</span>.<span class="at">deleteRecord</span>()<span class="op">;</span>

      <span class="kw">this</span>.<span class="at">_transitionToRentalRoute</span>(<span class="kw">this</span>)
    <span class="op">},</span>

    <span class="at">createBooking</span>(booking) <span class="op">{</span>
      <span class="va">booking</span>.<span class="at">save</span>().<span class="at">then</span>(<span class="kw">this</span>.<span class="va">_transitionToRentalRoute</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>

  <span class="at">_transitionToRentalRoute</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">controllerFor</span>(<span class="st">&#39;rental.show&#39;</span>).<span class="at">resetRange</span>()<span class="op">;</span>

    <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

    <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;rental.show&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>To finish points <code>1</code> and <code>2</code>, we need to ensure those actions are handled in the component. For <code>createBooking</code> we already know that it works - the acceptance test is passing just fine. However, <code>closeModal</code> is not used yet, so we definitely need to cover it.</p>
<p>Let’s update the template for <code>rental/show/createBooking</code>:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/templates/rental/show/create-booking.hbs --&gt;</span>
{{#modal-dialog targetAttachment=&#39;center&#39; translucentOverlay=true}}
  <span class="kw">&lt;h3&gt;</span>Create booking<span class="kw">&lt;/h3&gt;</span>

  {{create-booking-form
    booking=booking
    rentalBookings=rental.bookings
    onCreateBooking=(route-action &#39;createBooking&#39;)
    onCancelCreation=(route-action &#39;closeModal&#39;)
  }}
{{/modal-dialog}}</code></pre></td></tr></table></div>
<p>As already discussed, we are not going to cover it with acceptance test, which is not perfect as a small part of this functionality won’t be covered with tests at all, but it’s not a business critical feature anyway, so even in worst case scenario when something breaks, it’s not going to be the end of the world.</p>
<p>The next step will be writing component’s integration tests. We will cover with tests both the action for creating booking (already implemented) and for canceling the creation (not added yet).</p>
<p>Again, let’s start with the tests:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/components/create-booking-form-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;create-booking-form&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component | create</span>
  booking form<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;submitting form fires onCreateBooking action with booking</span>
  <span class="im">as</span> argument<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>
  <span class="kw">const</span> bookingStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> onCreateBooking <span class="op">=</span> (argument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(argument<span class="op">,</span> bookingStub<span class="op">,</span>
      <span class="st">&#39;onCreateBooking should be called with booking&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;booking&#39;</span><span class="op">,</span> bookingStub)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onCreateBooking&#39;</span><span class="op">,</span> onCreateBooking)

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{create-booking-form booking=booking</span>
<span class="vs">    onCreateBooking=onCreateBooking}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;create-booking&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;clicking cancel button fires onCancelCreation action with booking</span>
  <span class="im">as</span> argument<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>
  <span class="kw">const</span> bookingStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>
  <span class="kw">const</span> onCancelCreation <span class="op">=</span> (argument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(argument<span class="op">,</span> bookingStub<span class="op">,</span>
      <span class="st">&#39;onCancelCreation should be called with booking&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;booking&#39;</span><span class="op">,</span> bookingStub)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onCancelCreation&#39;</span><span class="op">,</span> onCancelCreation)

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{create-booking-form booking=booking</span>
<span class="vs">    onCancelCreation=onCancelCreation}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;cancel-creation&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>
})<span class="op">;</span></code></pre></td></tr></table></div>
<p>The structure of the tests is quite simple: we are doing the necessary setup and providing stubs for bookings and actions, where we perform the assertions that the function is actually called (thanks to <code>assert.expect(1)</code> at the beginning of the tests) and that it is called with the right argument. Then, we are rendering the component and clicking the button. Here is the implementation of the component and its template to make tests happy:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/create-booking-form.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">createBooking</span>() <span class="op">{</span>
      <span class="kw">const</span> booking <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;booking&#39;</span>)<span class="op">;</span>

      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onCreateBooking&#39;</span>)(booking)
    <span class="op">},</span>

    <span class="at">cancelCreation</span>() <span class="op">{</span>
      <span class="kw">const</span> booking <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;booking&#39;</span>)<span class="op">;</span>

      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onCancelCreation&#39;</span>)(booking)
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/create-booking-form.hbs --&gt;</span>
<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&#39;createBooking&#39;</span><span class="ot"> on=</span><span class="st">&#39;submit&#39;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;booking-client-email&quot;</span><span class="kw">&gt;</span>Client Email<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-booking-client-email
      id=&quot;client-email&quot;
      value=(mut booking.clientEmail)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>

  <span class="kw">&lt;button</span><span class="ot"> data-test-create-booking type=</span><span class="st">&quot;submit&quot;</span>
<span class="ot">    class=</span><span class="st">&quot;btn btn-primary&quot;</span><span class="kw">&gt;</span>Create booking<span class="kw">&lt;/button&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> data-test-cancel-creation type=</span><span class="st">&quot;button&quot;</span> <span class="er">{{action</span> <span class="er">&#39;cancelCreation&#39;}}</span>
<span class="ot">    class=</span><span class="st">&quot;btn btn-danger&quot;</span><span class="kw">&gt;</span>Close<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>We are back to green!</p>
<p>Now, it’s time for the final part of the app described in the 3rd point: validations. The most tricky one is going to be a validation that the dates do not overlap with already existing bookings, especially since format or presence validation is quite trivial to implement. That definitely sounds like <code>ember-changeset</code> validations, so let’s start with generating a validator:</p>
<pre><code>ember generate validator booking</code></pre>
<p>To implement the proper validation for dates’ overlapping, we need figure out what that even means in the first place. Let’s imagine we want to create a booking with <code>beginsAt</code> time as <code>2017-10-01 14:00:00</code> and <code>finishesAt</code> as <code>2017-10-10 10:00:00</code>. We need to make sure that at no time does this dates range cover any other booking. There are four possibilities of covering some other booking:</p>
<ol style="list-style-type: decimal">
<li><p>Another booking has <code>beginsAt</code> before a new booking’s <code>beginsAt</code> and <code>finishesAt</code> after <code>finishesAt</code> time of the new booking. The example would be a booking lasting from <code>2017-10-01 10:00:00</code> (notice the hour) to <code>2017-10-11 10:00:00</code>.</p></li>
<li><p>Other booking has <code>beginsAt</code> before a new booking’s <code>beginsAt</code> and <code>finishesAt</code> between <code>beginsAt</code> / <code>finishesAt</code> time of the new booking. The example would be a booking lasting from <code>2017-10-01 10:00:00</code> (notice the hour) to <code>2017-10-05 10:00:00</code>.</p></li>
<li><p>Other booking has <code>beginsAt</code> between new booking’s <code>beginsAt</code> / <code>finishesAt</code> and <code>finishesAt</code> time also between <code>beginsAt</code> / <code>finishesAt</code> time of the new booking. The example would be a booking lasting from <code>2017-10-02 14:00:00</code> to <code>2017-10-09 10:00:00</code>.</p></li>
<li><p>Other booking has <code>beginsAt</code> between new booking’s <code>beginsAt</code> / <code>finishesAt</code> and <code>finishesAt</code> after <code>finishesAt</code> time of the new booking. The example would be a booking lasting from <code>2017-10-05 10:00:00</code> to <code>2017-10-12 10:00:00</code>.</p></li>
</ol>
<p>Let’s assume that we are inclusive in all case on the exact times, so if one booking finishes at <code>2017-10-10 10:00:00</code>, it is also possible for another booking to start from <code>2017-10-11 10:00:00</code>.</p>
<p>Are you able to notice any pattern in those examples?</p>
<p>It looks like any potential overlapping booking would have its <code>beginsAt</code> before new booking’s <code>finishesAt</code> and at the same time its <code>finishesAt</code> after new booking’s <code>beginsAt</code>. So a non-overlapping booking would need to have both <code>beginsAt</code> and <code>finishesAt</code> before new booking’s <code>beginsAt</code> time or both <code>beginsAt</code> and <code>finishesAt</code> after new booking’s <code>finishesAt</code>.</p>
<p>Now that we know how the logic should be implemented, we can start thinking how it could be integrated with <code>ember-changeset-validator</code>. It sounds like we need a custom validation function. After consulting the <a href="https://github.com/DockYard/ember-changeset-validations#synchronous-validators">docs</a>, we see that it is not that hard - to make it work we need to implement a function returning another function taking <code>key</code>, <code>newValue</code>, <code>oldValue</code>, <code>changes</code> and <code>content</code> as arguments. If the result is valid, we need to return <code>true</code>. Otherwise, we return an error message. The only argument we will be interested in from those will be <code>content</code> as this is going to be a new booking with populated <code>beginsAt</code> and <code>finishesAt</code> properties.</p>
<p>Also, we need to somehow have access to all the bookings for given rental. Thanks to the design of validation functions, it is going to be pretty straight-forward. We will just take advantage of JS closures. Since we have to implement a function returning another function, we can pass <code>bookings</code> as the argument to the outer function. This argument will be available in the inner function’s scope. <code>ember-changeset-validators</code> addon expects that the factory function will take object argument. In that case, the potential implementation of such custom validator might look like this:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="kw">function</span> <span class="at">validateNoOverlapping</span>(<span class="op">{</span> bookings <span class="op">}</span>) <span class="op">{</span>
  <span class="cf">return</span> (_key<span class="op">,</span> _value<span class="op">,</span> _oldValue<span class="op">,</span> _changes<span class="op">,</span> content) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> overlappingBookings <span class="op">=</span> <span class="va">bookings</span>.<span class="at">filter</span>((booking) <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="cf">return</span> content <span class="op">!==</span> booking <span class="op">&amp;&amp;</span>
             <span class="at">get</span>(booking<span class="op">,</span> <span class="st">&#39;beginsAt&#39;</span>).<span class="at">isBefore</span>(<span class="at">get</span>(content<span class="op">,</span> <span class="st">&#39;finishesAt&#39;</span>)) <span class="op">&amp;&amp;</span>
             <span class="at">get</span>(booking<span class="op">,</span> <span class="st">&#39;finishesAt&#39;</span>).<span class="at">isAfter</span>(<span class="at">get</span>(content<span class="op">,</span> <span class="st">&#39;beginsAt&#39;</span>))
    <span class="op">}</span>)<span class="op">;</span>

    <span class="cf">if</span> (<span class="va">overlappingBookings</span>.<span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span>
      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
      <span class="cf">return</span> <span class="st">&#39;Dates must not overlap with other bookings&#39;</span><span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>Thanks to <code>moment</code> functions like <code>isBefore</code> or <code>isAfter</code>, implementing such logic is not that hard. We are just looking for overlapping bookings by the just mentioned criteria and if we don’t find any, we consider the result valid.</p>
<p>It looks like we have the most challenging part covered. What else do we need to have when it comes to booking’s validations?</p>
<p>For client’s email we just need to validate the presence of the email address and the right format and, as far as price goes, it must be an integer that is greater than 0.</p>
<p>One optional validation would be making sure that <code>finishesAt</code> time is after <code>beginsAt</code>, but it’s not possible to perform such selection with <code>ember-power-calendar</code>, so it might be enough if such validation existed exclusively server-side.</p>
<p>Let’s write the tests then. However, the structure of the validator itself is going to be different than the ones in previous cases. For example, in case of a rental validator, we are just returning a simple object with attributes as keys and validation functions as values. Here, we need to implement a function taking <code>bookings</code> collection as an argument that returns an object with attributes as keys and validation functions as values - that’s the only way to have access to <code>bookings</code>. Here are the tests that cover all the mentioned use cases:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/unit/validators/booking-test.js</span>
<span class="im">import</span> <span class="op">{</span> module<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> validateBooking <span class="im">from</span> <span class="st">&#39;book-me/validators/booking&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span>

<span class="at">module</span>(<span class="st">&#39;Unit | Validator | booking&#39;</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates presence of client email&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> bookings <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">const</span> validator <span class="op">=</span> <span class="at">validateBooking</span>(bookings)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validator</span>.<span class="at">clientEmail</span>[<span class="dv">0</span>](<span class="st">&#39;clientEmail&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">,</span>
    <span class="st">&quot;Client email can&#39;t be blank&quot;</span>)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validator</span>.<span class="at">clientEmail</span>[<span class="dv">0</span>](<span class="st">&#39;clientEmail&#39;</span><span class="op">,</span>
    <span class="st">&#39;example@mail.com&#39;</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates format of client email&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> bookings <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">const</span> validator <span class="op">=</span> <span class="at">validateBooking</span>(bookings)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validator</span>.<span class="at">clientEmail</span>[<span class="dv">1</span>](<span class="st">&#39;clientEmail&#39;</span><span class="op">,</span> <span class="st">&#39;example@&#39;</span>)<span class="op">,</span>
    <span class="st">&#39;Client email must be a valid email address&#39;</span>)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validator</span>.<span class="at">clientEmail</span>[<span class="dv">1</span>](<span class="st">&#39;clientEmail&#39;</span><span class="op">,</span>
    <span class="st">&#39;example@mail.com&#39;</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates if price is an integer greater than 0&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> bookings <span class="op">=</span> []<span class="op">;</span>
  <span class="kw">const</span> validator <span class="op">=</span> <span class="at">validateBooking</span>(bookings)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validator</span>.<span class="at">price</span>(<span class="st">&#39;price&#39;</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">,</span> <span class="st">&#39;Price must be a number&#39;</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validator</span>.<span class="at">price</span>(<span class="st">&#39;price&#39;</span><span class="op">,</span> <span class="fl">123.12</span>)<span class="op">,</span> <span class="st">&#39;Price must be an integer&#39;</span>)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validator</span>.<span class="at">price</span>(<span class="st">&#39;price&#39;</span><span class="op">,</span> <span class="dv">100</span>))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it validates if dates overlap with existing bookings&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="kw">const</span> bookings <span class="op">=</span> [
    <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
      <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-01 14:00:00&#39;</span>)<span class="op">,</span>
      <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-10 10:00:00&#39;</span>)
    <span class="op">}</span>)
  ]<span class="op">;</span>
  <span class="kw">const</span> validator <span class="op">=</span> <span class="at">validateBooking</span>(bookings)<span class="op">;</span>
  <span class="kw">const</span> _ <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

  <span class="kw">let</span> content <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-01 14:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-10 10:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validator</span>.<span class="at">dates</span>(_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> content)<span class="op">,</span>
    <span class="st">&#39;Dates must not overlap with other bookings&#39;</span>)<span class="op">;</span>

  content <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-01 10:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-11 10:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validator</span>.<span class="at">dates</span>(_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> content)<span class="op">,</span>
    <span class="st">&#39;Dates must not overlap with other bookings&#39;</span>)<span class="op">;</span>

  content <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-01 10:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-05 10:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validator</span>.<span class="at">dates</span>(_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> content)<span class="op">,</span>
    <span class="st">&#39;Dates must not overlap with other bookings&#39;</span>)<span class="op">;</span>

  content <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-02 14:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-09 10:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validator</span>.<span class="at">dates</span>(_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> content)<span class="op">,</span>
    <span class="st">&#39;Dates must not overlap with other bookings&#39;</span>)<span class="op">;</span>

  content <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-05 10:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-12 10:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">equal</span>(<span class="va">validator</span>.<span class="at">dates</span>(_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> content)<span class="op">,</span>
    <span class="st">&#39;Dates must not overlap with other bookings&#39;</span>)<span class="op">;</span>

  content <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-10 10:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-12 10:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validator</span>.<span class="at">dates</span>(_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> content))<span class="op">;</span>

  content <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-09-10 10:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-01 14:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validator</span>.<span class="at">dates</span>(_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> content))<span class="op">;</span>

  content <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-09-10 10:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-01 13:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validator</span>.<span class="at">dates</span>(_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> content))<span class="op">;</span>

  content <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-10 11:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-15 10:00:00&#39;</span>)
  <span class="op">}</span>)<span class="op">;</span>
  <span class="va">assert</span>.<span class="at">ok</span>(<span class="va">validator</span>.<span class="at">dates</span>(_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> content))<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>TDDing such functionality certainly requires some knowledge of the <code>ember-changeset-validations</code> API, but after writing few validators like this, it gets much simpler.</p>
<p>Here’s the implementation:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/validators/booking.js</span>
<span class="im">import</span> <span class="op">{</span>
  validatePresence<span class="op">,</span>
  validateFormat<span class="op">,</span>
  validateNumber<span class="op">,</span>
<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-changeset-validations/validators&#39;</span><span class="op">;</span>

<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="kw">function</span> <span class="at">createBookingValidator</span>(bookings) <span class="op">{</span>
  <span class="cf">return</span> <span class="op">{</span>
    <span class="dt">clientEmail</span><span class="op">:</span> [
      <span class="at">validatePresence</span>(<span class="kw">true</span>)<span class="op">,</span>
      <span class="at">validateFormat</span>(<span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;email&#39;</span> <span class="op">}</span>)
    ]<span class="op">,</span>
    <span class="dt">price</span><span class="op">:</span> <span class="at">validateNumber</span>(<span class="op">{</span> <span class="dt">integer</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">gt</span><span class="op">:</span> <span class="dv">0</span> <span class="op">}</span>)<span class="op">,</span>
    <span class="dt">dates</span><span class="op">:</span> <span class="at">validateNoOverlapping</span>(<span class="op">{</span> bookings <span class="op">}</span>)<span class="op">,</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="kw">function</span> <span class="at">validateNoOverlapping</span>(<span class="op">{</span> bookings <span class="op">}</span>) <span class="op">{</span>
  <span class="cf">return</span> (_key<span class="op">,</span> _value<span class="op">,</span> _oldValue<span class="op">,</span> _changes<span class="op">,</span> content) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="kw">const</span> overlappingBookings <span class="op">=</span> <span class="va">bookings</span>.<span class="at">filter</span>((booking) <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="cf">return</span> content <span class="op">!==</span> booking <span class="op">&amp;&amp;</span>
             <span class="at">get</span>(booking<span class="op">,</span> <span class="st">&#39;beginsAt&#39;</span>).<span class="at">isBefore</span>(<span class="at">get</span>(content<span class="op">,</span> <span class="st">&#39;finishesAt&#39;</span>)) <span class="op">&amp;&amp;</span>
             <span class="at">get</span>(booking<span class="op">,</span> <span class="st">&#39;finishesAt&#39;</span>).<span class="at">isAfter</span>(<span class="at">get</span>(content<span class="op">,</span> <span class="st">&#39;beginsAt&#39;</span>))
    <span class="op">}</span>)<span class="op">;</span>

    <span class="cf">if</span> (<span class="va">overlappingBookings</span>.<span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span>
      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
      <span class="cf">return</span> <span class="st">&#39;Dates must not overlap with other bookings&#39;</span><span class="op">;</span>
    <span class="op">}</span>
  <span class="op">};</span>
<span class="op">}</span></code></pre></td></tr></table></div>
<p>Nice! All tests are passing again, so we can just take advantage of the validations in the <code>create-booking-form</code> component. Obviously, we are going to start with the integration test verifying that the error messages are properly displayed:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/components/create-booking-form-test.js</span>
<span class="im">import</span> <span class="op">{</span> moduleForComponent<span class="op">,</span> test <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ember-qunit&#39;</span><span class="op">;</span>
<span class="im">import</span> hbs <span class="im">from</span> <span class="st">&#39;htmlbars-inline-precompile&#39;</span><span class="op">;</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> testSelector <span class="im">from</span> <span class="st">&#39;ember-test-selectors&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="at">moduleForComponent</span>(<span class="st">&#39;create-booking-form&#39;</span><span class="op">,</span> <span class="st">&#39;Integration | Component |</span>
  create booking form<span class="st">&#39;, {</span>
  integration<span class="op">:</span> <span class="kw">true</span>
})<span class="op">;</span>

<span class="at">test</span>(<span class="st">&#39;it displays validation error when the data is invalid&#39;</span><span class="op">,</span> <span class="kw">function</span>(assert) <span class="op">{</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">2</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>
  <span class="kw">const</span> bookingStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>()<span class="op">;</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;booking&#39;</span><span class="op">,</span> bookingStub)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rentalBookings&#39;</span><span class="op">,</span> [])<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onCreateBooking&#39;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;action should not be called&#39;</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{create-booking-form booking=booking</span>
<span class="vs">    onCreateBooking=onCreateBooking rentalBookings=rentalBookings}}`</span>)<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">notOk</span>(<span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;booking-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span>
    <span class="st">&#39;errors should not initially be visible&#39;</span>)

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;create-booking&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>

  <span class="va">assert</span>.<span class="at">ok</span>(<span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;booking-errors&#39;</span>)).<span class="at">length</span><span class="op">,</span>
    <span class="st">&#39;errors should be visible when submitting form with invalid data&#39;</span>)<span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>The idea behind the test is simple - initially, the errors should not be visible, but after attempting to create a booking, some errors should be displayed if data is invalid.</p>
<p>Here is the implementation that would make the new test pass:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/components/create-booking-form.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> Changeset <span class="im">from</span> <span class="st">&#39;ember-changeset&#39;</span><span class="op">;</span>
<span class="im">import</span> lookupValidator <span class="im">from</span> <span class="st">&#39;ember-changeset-validations&#39;</span><span class="op">;</span>
<span class="im">import</span> BookingValidators <span class="im">from</span> <span class="st">&#39;book-me/validators/booking&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Component</span>.<span class="at">extend</span>(<span class="op">{</span>
  <span class="at">init</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>(...<span class="at">arguments</span>)<span class="op">;</span>

    <span class="kw">const</span> rentalBookings <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rentalBookings&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> booking <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;booking&#39;</span>)
    <span class="kw">const</span> validators <span class="op">=</span> <span class="at">BookingValidators</span>(rentalBookings)<span class="op">;</span>
    <span class="kw">const</span> changeset <span class="op">=</span> <span class="kw">new</span> <span class="at">Changeset</span>(booking<span class="op">,</span> <span class="at">lookupValidator</span>(validators)<span class="op">,</span> validators)<span class="op">;</span>

    <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span><span class="op">,</span> changeset)<span class="op">;</span>
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">createBooking</span>() <span class="op">{</span>
      <span class="kw">const</span> changeset <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;changeset&#39;</span>)<span class="op">;</span>

      <span class="va">changeset</span>.<span class="at">validate</span>().<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
        <span class="cf">if</span> (<span class="at">get</span>(changeset<span class="op">,</span> <span class="st">&#39;isValid&#39;</span>)) <span class="op">{</span>
          <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onCreateBooking&#39;</span>)(changeset)
        <span class="op">}</span>
      <span class="op">}</span>)<span class="op">;</span>
    <span class="op">},</span>

    <span class="at">cancelCreation</span>() <span class="op">{</span>
      <span class="kw">const</span> booking <span class="op">=</span> <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;booking&#39;</span>)<span class="op">;</span>

      <span class="at">get</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onCancelCreation&#39;</span>)(booking)<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>The structure is almost the same as the one for persisting a rental. The only difference is setting up validators where we are passing <code>rentalBookings</code>.</p>
<p>Here is the template:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/create-booking-form.hbs --&gt;</span>
{{#if changeset.isInvalid}}
  <span class="kw">&lt;section</span><span class="ot"> data-test-booking-errors</span><span class="kw">&gt;</span>
    {{#each changeset.errors as |error|}}
      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;alert alert-danger&quot;</span><span class="ot"> role=</span><span class="st">&quot;alert&quot;</span><span class="kw">&gt;</span>
        {{error.validation}}
      <span class="kw">&lt;/div&gt;</span>
    {{/each}}
  <span class="kw">&lt;/section&gt;</span>
{{/if}}

<span class="kw">&lt;form</span> <span class="er">{{action</span> <span class="er">&#39;createBooking&#39;</span><span class="ot"> on=</span><span class="st">&#39;submit&#39;</span><span class="er">}}</span><span class="kw">&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;form-group&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;booking-client-email&quot;</span><span class="kw">&gt;</span>Client Email<span class="kw">&lt;/label&gt;</span>
    {{input
      data-test-booking-client-email
      id=&quot;client-email&quot;
      value=(mut changeset.clientEmail)
      class=&quot;form-control&quot;
    }}
  <span class="kw">&lt;/div&gt;</span>

  <span class="kw">&lt;button</span><span class="ot"> data-test-create-booking type=</span><span class="st">&quot;submit&quot;</span>
<span class="ot">    class=</span><span class="st">&quot;btn btn-primary&quot;</span><span class="kw">&gt;</span>Create booking<span class="kw">&lt;/button&gt;</span>
  <span class="kw">&lt;button</span><span class="ot"> data-test-cancel-creation type=</span><span class="st">&quot;button&quot;</span> <span class="er">{{action</span> <span class="er">&#39;cancelCreation&#39;}}</span>
<span class="ot">    class=</span><span class="st">&quot;btn btn-danger&quot;</span><span class="kw">&gt;</span>Close<span class="kw">&lt;/button&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></td></tr></table></div>
<p>Notice that we also adjusted <code>input</code> - we are no longer dealing with <code>booking</code> directly but <code>changeset</code>.</p>
<p>We managed to make the new test pass, but the old one, verifying that <code>onCreateBooking</code>, action gets called fails. The acceptance test for creating a new booking fails as well.</p>
<p>Let’s start with the component’s integration test. We need to adjust it by making sure the data is valid before submitting the form and that the action gets called with <code>changeset</code> argument, not a model. Also, we need to pass <code>rentalBookings</code> array</p>
<p>Here is the test after adjustments:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/tests/integration/components/create-booking-form-test.js</span>
<span class="at">test</span>(<span class="st">&#39;submitting form fires onCreateBooking action with booking as</span>
  argument<span class="st">&#39;, function(assert) {</span>
  <span class="va">assert</span>.<span class="at">expect</span>(<span class="dv">1</span>)<span class="op">;</span>

  <span class="kw">const</span> <span class="op">{</span>
    $<span class="op">,</span>
  <span class="op">}</span> <span class="op">=</span> <span class="kw">this</span><span class="op">;</span>
  <span class="kw">const</span> bookingStub <span class="op">=</span> <span class="va">Ember</span>.<span class="va">Object</span>.<span class="at">create</span>(<span class="op">{</span>
    <span class="dt">beginsAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-01 14:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">finishesAt</span><span class="op">:</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="st">&#39;2017-10-10 10:00:00&#39;</span>)<span class="op">,</span>
    <span class="dt">price</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span>
  <span class="op">}</span>)<span class="op">;</span>
  <span class="kw">const</span> onCreateBooking <span class="op">=</span> (argument) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="va">argument</span>.<span class="at">_content</span><span class="op">,</span> bookingStub<span class="op">,</span>
      <span class="st">&#39;onCreateBooking should be called with booking changeset&#39;</span>)<span class="op">;</span>
  <span class="op">};</span>

  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;booking&#39;</span><span class="op">,</span> bookingStub)<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;rentalBookings&#39;</span><span class="op">,</span> [])<span class="op">;</span>
  <span class="at">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="st">&#39;onCreateBooking&#39;</span><span class="op">,</span> onCreateBooking)

  <span class="kw">this</span>.<span class="at">render</span>(hbs<span class="vs">`{{create-booking-form booking=booking</span>
<span class="vs">    onCreateBooking=onCreateBooking rentalBookings=rentalBookings}}`</span>)<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;booking-client-email&#39;</span>)).<span class="at">val</span>(<span class="st">&#39;client@example.com&#39;</span>).<span class="at">change</span>()<span class="op">;</span>

  <span class="at">$</span>(<span class="at">testSelector</span>(<span class="st">&#39;create-booking&#39;</span>)).<span class="at">click</span>()<span class="op">;</span>
})<span class="op">;</span>

<span class="co">// other tests</span></code></pre></td></tr></table></div>
<p>Now it’s time for the final thing - making the acceptance test green again. The problem is that we are not passing <code>rentalBookings</code> to <code>create-booking-form</code>. Since this is a route that is nested inside <code>rental</code> route, we can easily get the rental via <code>this.modelFor('rental')</code>. Let’s assign then a <code>rental</code> property to <code>controller</code> in <code>rental/show/create-booking</code> route:</p>
<div class="sourceCode"><table class="sourceCode javascript numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="sourceCode"><pre><code class="sourceCode javascript"><span class="co">// book-me/app/routes/rental/create-booking.js</span>
<span class="im">import</span> Ember <span class="im">from</span> <span class="st">&#39;ember&#39;</span><span class="op">;</span>
<span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span>
<span class="im">import</span> AuthenticatedRouteMixin <span class="im">from</span> <span class="st">&#39;ember-simple-auth/mixins/authenticated-route-mixin&#39;</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  get<span class="op">,</span>
  set<span class="op">,</span>
<span class="op">}</span> <span class="op">=</span> Ember<span class="op">;</span>

<span class="im">export</span> <span class="im">default</span> <span class="va">Ember</span>.<span class="va">Route</span>.<span class="at">extend</span>(AuthenticatedRouteMixin<span class="op">,</span> <span class="op">{</span>
  <span class="at">model</span>(params) <span class="op">{</span>
    <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> dailyRate <span class="op">=</span> <span class="at">get</span>(rental<span class="op">,</span> <span class="st">&#39;dailyRate&#39;</span>)<span class="op">;</span>
    <span class="kw">const</span> beginsAt <span class="op">=</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="va">params</span>.<span class="at">start</span>)<span class="op">;</span>
    <span class="kw">const</span> finishesAt <span class="op">=</span> <span class="va">moment</span>.<span class="at">utc</span>(<span class="va">params</span>.<span class="at">end</span>)<span class="op">;</span>
    <span class="kw">const</span> booking <span class="op">=</span> <span class="kw">this</span>.<span class="va">store</span>.<span class="at">createRecord</span>(<span class="st">&#39;booking&#39;</span><span class="op">,</span> <span class="op">{</span>
      rental<span class="op">,</span>
      beginsAt<span class="op">,</span>
      finishesAt<span class="op">,</span>
    <span class="op">}</span>)<span class="op">;</span>

    <span class="kw">const</span> price <span class="op">=</span> <span class="at">get</span>(booking<span class="op">,</span> <span class="st">&#39;lengthOfStay&#39;</span>) <span class="op">*</span> dailyRate<span class="op">;</span>
    <span class="at">set</span>(booking<span class="op">,</span> <span class="st">&#39;price&#39;</span><span class="op">,</span>  price)<span class="op">;</span>

    <span class="cf">return</span> booking<span class="op">;</span>
  <span class="op">},</span>

  <span class="at">setupController</span>(controller<span class="op">,</span> model) <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">_super</span>()<span class="op">;</span>

    <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;booking&#39;</span><span class="op">,</span> model)<span class="op">;</span>
    <span class="at">set</span>(controller<span class="op">,</span> <span class="st">&#39;rental&#39;</span><span class="op">,</span> rental)
  <span class="op">},</span>

  <span class="dt">actions</span><span class="op">:</span> <span class="op">{</span>
    <span class="at">closeModal</span>(booking) <span class="op">{</span>
      <span class="va">booking</span>.<span class="at">deleteRecord</span>()<span class="op">;</span>

      <span class="kw">this</span>.<span class="at">_transitionToRentalRoute</span>(<span class="kw">this</span>)
    <span class="op">},</span>

    <span class="at">createBooking</span>(booking) <span class="op">{</span>
      <span class="va">booking</span>.<span class="at">save</span>().<span class="at">then</span>(<span class="kw">this</span>.<span class="va">_transitionToRentalRoute</span>.<span class="at">bind</span>(<span class="kw">this</span>))<span class="op">;</span>
    <span class="op">},</span>
  <span class="op">},</span>

  <span class="at">_transitionToRentalRoute</span>() <span class="op">{</span>
    <span class="kw">this</span>.<span class="at">controllerFor</span>(<span class="st">&#39;rental.show&#39;</span>).<span class="at">resetRange</span>()<span class="op">;</span>

    <span class="kw">const</span> rental <span class="op">=</span> <span class="kw">this</span>.<span class="at">modelFor</span>(<span class="st">&#39;rental&#39;</span>)<span class="op">;</span>

    <span class="kw">this</span>.<span class="at">transitionTo</span>(<span class="st">&#39;rental.show&#39;</span><span class="op">,</span> rental)<span class="op">;</span>
  <span class="op">},</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></td></tr></table></div>
<p>And now we can just pass the bookings of this rental to <code>create-booking-form</code> component. Since we are relying on the values of the bookings’ attributes for validations, it would make sense to not render the component until the bookings are fetched and populated. Just passing <code>rental.bookings</code> won’t be enough as it merely returns a promise that is not initially resolved. To have all the properties of the bookings available in the data fetched from the server, we need to make sure that the promise is settled. Fortunately, this is pretty simple. We just need to check the state of the promise. In this case, we will render the component only if <code>rental.bookings.isSettled</code> is true:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode html"><span class="co">&lt;!-- book-me/app/templates/components/create-booking-form.hbs --&gt;</span>
{{#modal-dialog targetAttachment=&#39;center&#39; translucentOverlay=true}}
  <span class="kw">&lt;h3&gt;</span>Create booking<span class="kw">&lt;/h3&gt;</span>

  {{#if rental.bookings.isSettled}}
    {{create-booking-form
      booking=booking
      rentalBookings=rental.bookings
      onCreateBooking=(route-action &#39;createBooking&#39;)
      onCancelCreation=(route-action &#39;closeModal&#39;)
    }}
  {{/if}}
{{/modal-dialog}}</code></pre></td></tr></table></div>
<p>And this all! We’ve successfully implemented all the features. Of course, there are a lot of small things that could be improved (e.g., handling server-side validation errors for new bookings), but after reading this booking adding, such simple features by practicing TDD should be your second nature :).</p>
<p></p>
<h1 id="closing-thoughts">Closing Thoughts</h1>
<p>And that would be it! I hope you enjoyed reading the book and learned some new concepts along the way. The example app was not that complex, yet it should be good enough to illustrate how to apply <strong>TDD</strong> rules when adding new features in any of the Ember apps and how to handle some use cases that are unique for <strong>Ember</strong> or <strong>JavaScript apps</strong> in general. Obviously there are more things that could be mentioned; however, my intention wasn’t to cover every possible testing scenario, but to do something much better - to explain testing in such a way that even if you encounter something that looks unfamiliar, you will still be able to isolate the problem and deal with it without much hassle.</p>
<p>If there is still something that is not entirely clear or you disagree with some parts, or maybe you just want to share positive feedback, feel free to reach me at <strong>karol.galanciak@gmail.com</strong>.</p>
<p></p>
